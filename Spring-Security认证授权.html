<!-- build time:Fri Mar 05 2021 23:49:06 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><script>!function(){var t,e="在线分享网";document.addEventListener("visibilitychange",function(){document.hidden?(document.title="您去哪里了！",clearTimeout(t)):(document.title="在线分享网欢迎您",t=setTimeout(function(){document.title=e},2e3))})}()</script><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script></script><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/icon.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/icon.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/icon.png?v=5.1.4"><link rel="mask-icon" href="/icon.png?v=5.1.4" color="#222"><meta name="keywords" content="Web认证,Web授权,"><link rel="alternate" href="/atom.xml" title="在线分享网" type="application/atom+xml"><meta name="description" content="Spring Security 快速上手Spring Security介绍Spring Security是一个能够为基于Spring的企业应用系统提供声明式的安全访问控制解决方案的安全框架。由于它是Spring生态系统中的一员，因此它伴随着整个Spring生态系统不断修正、升级，spring boot项目中加入spring security更是十分简单，使用Spring Security 减少了为"><meta name="keywords" content="Web认证,Web授权"><meta property="og:type" content="article"><meta property="og:title" content="Spring Security认证授权"><meta property="og:url" content="https://me.obey.fun/Spring-Security认证授权.html"><meta property="og:site_name" content="在线分享网"><meta property="og:description" content="Spring Security 快速上手Spring Security介绍Spring Security是一个能够为基于Spring的企业应用系统提供声明式的安全访问控制解决方案的安全框架。由于它是Spring生态系统中的一员，因此它伴随着整个Spring生态系统不断修正、升级，spring boot项目中加入spring security更是十分简单，使用Spring Security 减少了为"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://tva2.sinaimg.cn/large/006MOU0zgy1gjtdjzwproj30f30evq4b.jpg"><meta property="og:image" content="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjtngovstxj30au07i0t4.jpg"><meta property="og:image" content="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjtngovstxj30au07i0t4.jpg"><meta property="og:image" content="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjtnqu55vej3077067wel.jpg"><meta property="og:image" content="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjtngovstxj30au07i0t4.jpg"><meta property="og:image" content="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjtrp7u0j6j30dk0ga0ud.jpg"><meta property="og:image" content="https://tvax2.sinaimg.cn/large/006MOU0zgy1gjtsctc216j30ca0aggn8.jpg"><meta property="og:image" content="https://tvax1.sinaimg.cn/large/006MOU0zgy1gjtskik1r6j30ho09dabc.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/006MOU0zgy1gjtsmiuqe6j30l504b0u0.jpg"><meta property="og:image" content="https://tvax3.sinaimg.cn/large/006MOU0zgy1gjtsx3y5c3j30kz0ag76n.jpg"><meta property="og:image" content="https://tva2.sinaimg.cn/large/006MOU0zgy1gjtt39zvklj30gs0b7dhf.jpg"><meta property="og:image" content="https://tvax2.sinaimg.cn/large/006MOU0zgy1gjttzdkri4j30l00b0dhy.jpg"><meta property="og:image" content="https://tva2.sinaimg.cn/large/006MOU0zgy1gjtu5qcasdj30j2063gmr.jpg"><meta property="og:image" content="https://tva3.sinaimg.cn/large/006MOU0zgy1gjtc5wve76j30al03gjrc.jpg"><meta property="og:image" content="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjtvc88t2pj308404zaa6.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/006MOU0zgy1gjtvhixrpwj30kc05cwfm.jpg"><meta property="og:updated_time" content="2020-05-03T02:20:16.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Spring Security认证授权"><meta name="twitter:description" content="Spring Security 快速上手Spring Security介绍Spring Security是一个能够为基于Spring的企业应用系统提供声明式的安全访问控制解决方案的安全框架。由于它是Spring生态系统中的一员，因此它伴随着整个Spring生态系统不断修正、升级，spring boot项目中加入spring security更是十分简单，使用Spring Security 减少了为"><meta name="twitter:image" content="https://tva2.sinaimg.cn/large/006MOU0zgy1gjtdjzwproj30f30evq4b.jpg"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement(o),n=t.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"2931888f"}),daovoice("update")</script><link rel="canonical" href="https://me.obey.fun/Spring-Security认证授权.html"><title>Spring Security认证授权 | 在线分享网</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div id="particles-js"></div><div class="container sidebar-position-left page-post-detail"><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">在线分享网</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">分享，成为你我之间的快乐！</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档 <span class="badge">54</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签 <span class="badge">45</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类 <span class="badge">43</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-message"><a href="/message/" rel="section"><i class="menu-item-icon fa fa-fw fa-comments"></i><br>留言板</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="menu-item-icon fa fa-fw fa-address-book-o"></i><br>友情链接</a></li><li class="menu-item menu-item-share"><a href="https://www.52share.online" rel="section"><i class="menu-item-icon fa fa-fw fa-hand-o-right"></i><br>资源分享</a></li><li class="menu-item menu-item-topx"><a href="/topx/" rel="section"><i class="menu-item-icon fa fa-fw fa-line-chart"></i><br>热度排序</a></li><li id="search" class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><div id="lanye_popup_bg" onclick="lanye_popup_closebox()" style="display:none"></div><div class="lanye_popup_top"><a style="border-bottom:0" href="javascript:lanye_popup_box();" target="_blank" rel="external nofollow"></a><div class="lanye_popup_closetop"></div></div><script async src="/js/src/ribbon.js" type="text/javascript"></script><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://me.obey.fun/Spring-Security认证授权.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="HuiProgramer"><meta itemprop="description" content=""><meta itemprop="image" content="https://huiprogramer.gitee.io/medias/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="在线分享网"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Spring Security认证授权</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-16T12:24:24+08:00">2020-04-16 </time><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于&#58;</span> <time title="更新于" itemprop="dateModified" datetime="2020-05-03T10:20:16+08:00">2020-05-03 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Filter/" itemprop="url" rel="index"><span itemprop="name">Filter</span> </a></span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Filter/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span>评论: <span id="sourceId::Spring Security认证授权" class="cy_cmt_count"></span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">10.3k 字 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">44 分钟 </span><span id="/Spring-Security认证授权.html" class="leancloud_visitors" data-flag-title="Spring Security认证授权"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-thermometer-1"></i> </span><span class="post-meta-item-text">热度&#58;</span> <span class="leancloud-visitors-count"></span> <span>℃</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="Spring-Security-快速上手"><a href="#Spring-Security-快速上手" class="headerlink" title="Spring Security 快速上手"></a>Spring Security 快速上手</h1><h2 id="Spring-Security介绍"><a href="#Spring-Security介绍" class="headerlink" title="Spring Security介绍"></a>Spring Security介绍</h2><p>Spring Security是一个能够为基于Spring的企业应用系统提供声明式的安全访问控制解决方案的安全框架。由于它是Spring生态系统中的一员，因此它伴随着整个Spring生态系统不断修正、升级，spring boot项目中加入spring security更是十分简单，使用Spring Security 减少了为企业系统安全控制编写大量重复代码的工作。</p><h2 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h2><h3 id="创建maven工程"><a href="#创建maven工程" class="headerlink" title="创建maven工程"></a>创建maven工程</h3><p>1）创建maven工程 security-spring-security，工程结构如下：<br><img src="https://tva2.sinaimg.cn/large/006MOU0zgy1gjtdjzwproj30f30evq4b.jpg" alt="SpringSecurity工程" referrerpolicy="no-referrer"></p><p>2）引入以下依赖：<br>在security-springmvc的基础上增加spring-security的依赖：<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> 		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring‐security‐web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring‐security‐config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><h3 id="Spring容器配置"><a href="#Spring容器配置" class="headerlink" title="Spring容器配置"></a>Spring容器配置</h3><p>在<code>config</code>包下定义<code>ApplicationConfig.java</code>，它对应<code>web.xml</code>中<code>ContextLoaderListener</code>的配置<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = <span class="string">"com.itheima.security.springmvc"</span></span><br><span class="line">                ,excludeFilters = &#123;<span class="meta">@ComponentScan</span>.Filter(type = FilterType.ANNOTATION,value =</span><br><span class="line">Controller.class)&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">//在此配置除了Controller的其它bean，比如：数据库链接池、事务管理器、业务bean等。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="Servlet-Context配置"><a href="#Servlet-Context配置" class="headerlink" title="Servlet Context配置"></a>Servlet Context配置</h3><p>本案例采用Servlet3.0无web.xml方式，的config包下定义WebConfig.java，它对应于DispatcherServlet配置。<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = <span class="string">"com.itheima.security.springmvc"</span></span><br><span class="line">            ,includeFilters = &#123;<span class="meta">@ComponentScan</span>.Filter(type = FilterType.ANNOTATION,value =</span><br><span class="line">Controller.class)&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="comment">//视图解析器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InternalResourceViewResolver <span class="title">viewResolver</span><span class="params">()</span></span>&#123;</span><br><span class="line">        InternalResourceViewResolver viewResolver = <span class="keyword">new</span> InternalResourceViewResolver();</span><br><span class="line">        viewResolver.setPrefix(<span class="string">"/WEB‐INF/views/"</span>);</span><br><span class="line">        viewResolver.setSuffix(<span class="string">".jsp"</span>);</span><br><span class="line">        <span class="keyword">return</span> viewResolver;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="加载-Spring容器"><a href="#加载-Spring容器" class="headerlink" title="加载 Spring容器"></a>加载 Spring容器</h3><p>在init包下定义Spring容器初始化类<code>SpringApplicationInitializer</code>，此类实现<code>WebApplicationInitializer</code>接口，Spring容器启动时加载<code>WebApplicationInitializer</code>接口的所有实现类。<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringApplicationInitializer</span> <span class="keyword">extends</span></span></span><br><span class="line"><span class="class"><span class="title">AbstractAnnotationConfigDispatcherServletInitializer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Class&lt;?&gt;[] &#123; ApplicationConfig.class &#125;;<span class="comment">//指定rootContext的配置类</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt;[] getServletConfigClasses() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Class&lt;?&gt;[] &#123; WebConfig.class &#125;; <span class="comment">//指定servletContext的配置类</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String[] getServletMappings() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String [] &#123;<span class="string">"/"</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h2><h3 id="认证页面"><a href="#认证页面" class="headerlink" title="认证页面"></a>认证页面</h3><p>springSecurity默认提供认证页面，不需要额外开发。<br><img src="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjtngovstxj30au07i0t4.jpg" alt="SpringSecurity默认登录页面" referrerpolicy="no-referrer"></p><h3 id="安全配置"><a href="#安全配置" class="headerlink" title="安全配置"></a>安全配置</h3><p>spring security提供了用户名密码登录、退出、会话管理等认证功能，只需要配置即可使用。</p><p>1) 在config包下定义WebSecurityConfig，安全配置的内容包括：用户信息、密码编码器、安全拦截机制。<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"><span class="comment">//配置用户信息服务</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span>  </span>&#123;</span><br><span class="line">        InMemoryUserDetailsManager manager = <span class="keyword">new</span> InMemoryUserDetailsManager();</span><br><span class="line">       </span><br><span class="line">manager.createUser(User.withUsername(<span class="string">"zhangsan"</span>).password(<span class="string">"123"</span>).authorities(<span class="string">"p1"</span>).build());</span><br><span class="line">        manager.createUser(User.withUsername(<span class="string">"lisi"</span>).password(<span class="string">"456"</span>).authorities(<span class="string">"p2"</span>).build());</span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span>  NoOpPasswordEncoder.getInstance();    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//配置安全拦截机制</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            .antMatchers(<span class="string">"/r/**"</span>).authenticated()               （<span class="number">1</span>）</span><br><span class="line">            .anyRequest().permitAll()                           （<span class="number">2</span>）</span><br><span class="line">            .and()</span><br><span class="line">            .formLogin().successForwardUrl(<span class="string">"/login‐success"</span>);   （<span class="number">3</span>）</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>在 <code>userDetailsService()</code>方法中，我们返回了一个<code>UserDetailsService</code>给spring容器，Spring Security会使用它来获取用户信息。我们暂时使用<code>InMemoryUserDetailsManager</code>实现类，并在其中分别创建了<code>zhangsan、lisi</code>两个用户，并设置密码和权限。<br>而在<code>configure()</code>中，我们通过<code>HttpSecurity</code>设置了安全拦截规则，其中包含了以下内容：<br>（1）url匹配/r/**的资源，经过认证后才能访问。<br>（2）其他url完全开放。<br>（3）支持form表单认证，认证成功后转向/login-success。</p><p>关于HttpSecurity的配置清单请参考附录 HttpSecurity。<br>2) 加载 WebSecurityConfig<br>修改SpringApplicationInitializer的getRootConfigClasses()方法，添加WebSecurityConfig.class：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt;[] getRootConfigClasses() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Class&lt;?&gt;[] &#123; ApplicationConfig.class, WebSecurityConfig.class&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="Spring-Security初始化"><a href="#Spring-Security初始化" class="headerlink" title="Spring Security初始化"></a>Spring Security初始化</h3><p>Spring Security 初始化，这里有两种情况</p><ul><li>若当前环境没有使用 Spring或Spring MVC，则需要将 WebSecurityConfig(Spring Security配置类) 传入超类，以确保获取配置，并创建spring context。</li><li>相反，若当前环境已经使用 spring，我们应该在现有的springContext中注册Spring Security(上一步已经做将WebSecurityConfig加载至rootcontext)，此方法可以什么都不做。</li></ul><p>在init包下定义SpringSecurityApplicationInitializer：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringSecurityApplicationInitializer</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">AbstractSecurityWebApplicationInitializer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpringSecurityApplicationInitializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//super(WebSecurityConfig.class);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="默认根路径请求"><a href="#默认根路径请求" class="headerlink" title="默认根路径请求"></a>默认根路径请求</h3><p>在WebConfig.java中添加默认请求根路径跳转到/login，此url为spring security提供：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认Url根路径跳转到/login，此url为spring security提供</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">    registry.addViewController(<span class="string">"/"</span>).setViewName(<span class="string">"redirect:/login"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>spring security默认提供的登录页面。</p><h3 id="认证成功页面"><a href="#认证成功页面" class="headerlink" title="认证成功页面"></a>认证成功页面</h3><p>在安全配置中，认证成功将跳转到/login-success，代码如下：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置安全拦截机制</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            .antMatchers(<span class="string">"/r/**"</span>).authenticated()               （<span class="number">1</span>）</span><br><span class="line">            .anyRequest().permitAll()                           （<span class="number">2</span>）</span><br><span class="line">            .and()</span><br><span class="line">            .formLogin().successForwardUrl(<span class="string">"/login‐success"</span>);   （<span class="number">3</span>）</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>spring security</code>支持form表单认证，认证成功后转向<code>/login-success</code>。</p><p>在<code>LoginController</code>中定义<code>/login-success:</code><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/login‐success"</span>,produces = &#123;<span class="string">"text/plain;charset=UTF‐8"</span>&#125;) </span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">loginSuccess</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">" 登录成功"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>（1）启动项目，访问<code>http://localhost:8080/security-spring-security/</code>路径地址</p><p><img src="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjtngovstxj30au07i0t4.jpg" alt="SpringSecurity默认登录页面" referrerpolicy="no-referrer"></p><p>页面会根据<code>WebConfig</code>中<code>addViewControllers</code>配置规则，跳转至<code>/login</code>，<code>/login</code>是<strong>Spring Security</strong>提供的登录页面。</p><p>（2）登录</p><p>1、输入错误的用户名、密码<br><img src="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjtnqu55vej3077067wel.jpg" alt="SpringSecurity页面登录失败" referrerpolicy="no-referrer"></p><p>2、输入正确的用户名、密码，登录成功</p><p>（3）退出</p><p>1、请求/logout退出<br><img src="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjtngovstxj30au07i0t4.jpg" alt="SpringSecurity默认登录页面" referrerpolicy="no-referrer"></p><p>2、<strong>退出</strong> 后再访问资源自动跳转到登录页面</p><h2 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h2><p>实现授权需要对用户的访问进行拦截校验，校验用户的权限是否可以操作指定的资源，Spring Security默认提供授权实现方法。<br>在<code>LoginController</code>添加<code>/r/r1</code>或<code>/r/r2</code><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * 测试资源1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/r/r1"</span>,produces = &#123;<span class="string">"text/plain;charset=UTF‐8"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">r1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">" 访问资源1"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试资源2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/r/r2"</span>,produces = &#123;<span class="string">"text/plain;charset=UTF‐8"</span>&#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">r2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">" 访问资源2"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>在安全配置类 <strong>WebSecurityConfig.java</strong>中配置授权规则：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers(<span class="string">"/r/r1"</span>).hasAuthority(<span class="string">"p1"</span>)                                       </span><br><span class="line">.antMatchers(<span class="string">"/r/r2"</span>).hasAuthority(<span class="string">"p2"</span>)</span><br></pre></td></tr></table></figure><p></p><p><code>.antMatchers(&quot;/r/r1&quot;).hasAuthority(&quot;p1&quot;)</code>表示：访问<code>/r/r1</code>资源的 url 需要拥有<code>p1</code>权限。<br><code>.antMatchers(&quot;/r/r2&quot;).hasAuthority(&quot;p2&quot;)</code>表示：访问<code>/r/r2</code>资源的 url 需要拥有<code>p2</code>权限。<br>完整的<strong>WebSecurityConfig</strong>方法如下：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            .antMatchers(<span class="string">"/r/r1"</span>).hasAuthority(<span class="string">"p1"</span>)</span><br><span class="line">            .antMatchers(<span class="string">"/r/r2"</span>).hasAuthority(<span class="string">"p2"</span>)</span><br><span class="line">            .antMatchers(<span class="string">"/r/**"</span>).authenticated()</span><br><span class="line">            .anyRequest().permitAll()</span><br><span class="line">            .and()</span><br><span class="line">            .formLogin().successForwardUrl(<span class="string">"/login‐success"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>测试：<br>1、登录成功<br>2、访问/r/r1和/r/r2，有权限时则正常访问，否则返回403（拒绝访问）</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>通过快速上手，咱们使用Spring Security实现了认证和授权，Spring Security提供了基于账号和密码的认证方式，通过安全配置即可实现请求拦截，授权功能，Spring Security能完成的不仅仅是这些。</p><h1 id="Spring-Security-应用详解"><a href="#Spring-Security-应用详解" class="headerlink" title="Spring Security  应用详解"></a>Spring Security 应用详解</h1><h2 id="集成SpringBoot"><a href="#集成SpringBoot" class="headerlink" title="集成SpringBoot"></a>集成SpringBoot</h2><h3 id="Spring-Boot-介绍"><a href="#Spring-Boot-介绍" class="headerlink" title="Spring Boot 介绍"></a>Spring Boot 介绍</h3><p><code>Spring Boot</code>是一套<strong>Spring</strong>的快速开发框架，基于<code>Spring 4.0</code>设计，使用<code>Spring Boot</code>开发可以避免一些繁琐的工程搭建和配置，同时它集成了大量的常用框架，快速导入依赖包，避免依赖包的冲突。基本上常用的开发框架都支持<code>Spring Boot</code>开发，例如：<code>MyBatis、Dubbo</code>等，<code>Spring</code>家族更是如此，例如：<code>Spring cloud、Spring mvc、Spring security</code>等，使用<code>Spring Boot</code>开发可以大大得高生产率，所以<code>Spring Boot</code>的使用率非常高。</p><p>本章节讲解如何通过 <code>Spring Boot</code>开发<code>Spring Security</code>应用，<code>Spring Boot</code>提供<code>spring-boot-starter-security</code>用于开发<code>Spring Security</code>应用。</p><h3 id="创建maven工程-1"><a href="#创建maven工程-1" class="headerlink" title="创建maven工程"></a>创建maven工程</h3><p>1）创建maven工程 security-spring-boot，工程结构如下：<br><img src="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjtrp7u0j6j30dk0ga0ud.jpg" alt="SpringBoot集成SpringSecurity项目结构图" referrerpolicy="no-referrer"></p><p>2）引入以下依赖：<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF‐8"?&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema‐instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven‐</span></span></span><br><span class="line"><span class="tag"><span class="string">4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.itheima.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>security‐springboot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0‐SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring‐boot‐starter‐parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF‐8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">!‐‐</span> 以下是&gt;</span>spring boot依赖‐‐&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring‐boot‐starter‐web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">!‐‐</span> 以下是&gt;</span>spring security依赖‐‐&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring‐boot‐starter‐security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">!‐‐</span> 以下是<span class="attr">jsp</span>依赖‐‐&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet‐api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">!‐‐jsp页面使用jstl标签</span> ‐‐&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring‐boot‐starter‐tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">!‐‐用于编译jsp</span> ‐‐&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat‐embed‐jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>security‐springboot<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7‐maven‐plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line">                    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven‐compiler‐plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven‐resources‐plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>utf‐8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">useDefaultDelimiters</span>&gt;</span>true<span class="tag">&lt;/<span class="name">useDefaultDelimiters</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><h3 id="spring-容器配置"><a href="#spring-容器配置" class="headerlink" title="spring 容器配置"></a>spring 容器配置</h3><p>SpringBoot工程启动会自动扫描启动类所在包下的所有Bean，加载到spring容器。</p><p>1）Spring Boot配置文件<br>在resources下添加application.properties，内容如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.port=8080</span><br><span class="line">server.servlet.context‐path=/security‐springboot</span><br><span class="line">spring.application.name = security‐springboot</span><br></pre></td></tr></table></figure><p></p><p>2 ）Spring Boot 启动类<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecuritySpringBootApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SecuritySpringBootApp.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="Servlet-Context配置-1"><a href="#Servlet-Context配置-1" class="headerlink" title="Servlet Context配置"></a>Servlet Context配置</h3><p>由于Spring boot starter自动装配机制，这里无需使用@EnableWebMvc与@ComponentScan，WebConfig如下:<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="comment">//默认Url根路径跳转到/login，此url为spring security提供</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addViewController(<span class="string">"/"</span>).setViewName(<span class="string">"redirect:/login"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>视图解析器配置在<code>application.properties</code>中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.mvc.view.prefix=/WEB‐INF/views/ </span><br><span class="line">spring.mvc.view.suffix=.jsp</span><br></pre></td></tr></table></figure><h3 id="安全配置-1"><a href="#安全配置-1" class="headerlink" title="安全配置"></a>安全配置</h3><p>由于Spring boot starter自动装配机制，这里无需使用@EnableWebSecurity，WebSecurityConfig内容如下:<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">   <span class="comment">//内容跟Spring security入门程序一致</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>LoginController的内容同同Spring security入门程序。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</span><br><span class="line">  <span class="comment">//内容略..跟Spring security入门程序保持一致</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试过程：<br>1、测试认证<br>2、测试退出<br>3、测试授权</p><h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><h3 id="结构总览"><a href="#结构总览" class="headerlink" title="结构总览"></a>结构总览</h3><p><strong>Spring Security</strong>所解决的问题就是安全访问控制，而安全访问控制功能其实就是对所有进入系统的请求进行拦截，校验每个请求是否能够访问它所期望的资源。根据前边知识的学习，可以通过<strong>Filter或AOP</strong>等技术来实现，<strong>Spring Security</strong>对Web资源的保护是靠<strong>Filter</strong>实现的，所以从这个<strong>Filter</strong>来入手，逐步深入<strong>Spring Security</strong>原理。</p><p>当初始化<code>Spring Security</code>时，会创建一个名为 <code>SpringSecurityFilterChain</code> 的Servlet过滤器，类型为<code>org.springframework.security.web.FilterChainProxy</code>，它实现了<code>javax.servlet.Filter</code>，因此外部的请求会经过此类，下图是<code>Spring Security</code>过滤器链结构图：<br><img src="https://tvax2.sinaimg.cn/large/006MOU0zgy1gjtsctc216j30ca0aggn8.jpg" alt="FilterChainProxy" referrerpolicy="no-referrer"></p><p><code>FilterChainProxy</code> 是一个代理，真正起作用的是<code>FilterChainProxy</code>中<code>SecurityFilterChain</code>所包含的各个<strong>Filter</strong>，同时<br>这些<strong>Filter</strong>作为<strong>Bean</strong>被<strong>Spring</strong>管理，它们是<strong>Spring Security</strong>核心，各有各的职责，但他们并不直接处理用户的认证，也不直接处理用户的授权，而是把它们交给了认证管理器（<strong>AuthenticationManager</strong>）和决策管理器（<strong>AccessDecisionManager</strong>）进行处理，下图是<strong>FilterChainProxy</strong>相关类的UML图示。</p><p><img src="https://tvax1.sinaimg.cn/large/006MOU0zgy1gjtskik1r6j30ho09dabc.jpg" alt="FilterChainProxy-UML" referrerpolicy="no-referrer"></p><p><strong>spring Security</strong>功能的实现主要是由一系列过滤器链相互配合完成。<br><img src="https://tva1.sinaimg.cn/large/006MOU0zgy1gjtsmiuqe6j30l504b0u0.jpg" alt="SecurityFilterChain" referrerpolicy="no-referrer"></p><p>下面介绍过滤器链中主要的几个过滤器及其作用：<br><strong>SecurityContextPersistenceFilter</strong> 这个<code>Filter</code>是整个拦截过程的入口和出口（也就是第一个和最后一个拦截器），会在请求开始时从配置好的 <code>SecurityContextRepository</code> 中获取 <code>SecurityContext</code>，然后把它设置给<code>SecurityContextHolder</code>。在请求完成后将<code>SecurityContextHolder</code> 持有的 <code>SecurityContext</code> 再保存到配置好的 <code>SecurityContextRepository</code>，同时清除 <code>securityContextHolder</code> 所持有的 <code>SecurityContext</code>；</p><p><strong>UsernamePasswordAuthenticationFilter</strong> 用于处理来自表单提交的认证。该表单必须提供对应的用户名和密码，其内部还有登录成功或失败后进行处理的 <code>AuthenticationSuccessHandler</code> 和<code>AuthenticationFailureHandler</code>，这些都可以根据需求做相关改变；</p><p><strong>FilterSecurityInterceptor</strong> 是用于保护web资源的，使用<code>AccessDecisionManager</code>对当前用户进行授权访问，前面已经详细介绍过了；</p><p><strong>ExceptionTranslationFilter</strong> 能够捕获来自 <code>FilterChain</code> 所有的异常，并进行处理。但是它只会处理两类异常：<br><strong>AuthenticationException</strong> 和 <strong>AccessDeniedException</strong>，其它的异常它会继续抛出。</p><h3 id="认证流程"><a href="#认证流程" class="headerlink" title="认证流程"></a>认证流程</h3><h4 id="认证流程-1"><a href="#认证流程-1" class="headerlink" title="认证流程"></a>认证流程</h4><p><img src="https://tvax3.sinaimg.cn/large/006MOU0zgy1gjtsx3y5c3j30kz0ag76n.jpg" alt="用户认证流程" referrerpolicy="no-referrer"></p><p>让我们仔细分析认证过程：</p><ol><li>用户提交用户名、密码被<code>SecurityFilterChain</code>中的 <code>UsernamePasswordAuthenticationFilter</code> 过滤器获取到，封装为请求<code>Authentication</code>，通常情况下是<code>UsernamePasswordAuthenticationToken</code>这个实现类。</li><li>然后过滤器将<code>Authentication</code>提交至认证管理器（<code>AuthenticationManager</code>）进行认证</li><li>认证成功后，<code>AuthenticationManager</code> 身份管理器返回一个被填充满了信息的（包括上面提到的权限信息，身份信息，细节信息，但密码通常会被移除） <code>Authentication</code> 实例。</li><li><code>SecurityContextHolder</code> 安全上下文容器将第3步填充了信息的 <code>Authentication</code> ，通过<code>SecurityContextHolder.getContext().setAuthentication(…)</code>方法，设置到其中。</li></ol><p>可以看出<code>AuthenticationManager</code>接口（认证管理器）是认证相关的核心接口，也是发起认证的出发点，它的实现类为<code>ProviderManager</code>。而<code>Spring Security</code>支持多种认证方式，因此<code>ProviderManager</code>维护着一个<code>List&lt;AuthenticationProvider&gt;</code> 列表，存放多种认证方式，最终实际的认证工作是由<code>AuthenticationProvider</code>完成的。咱们知道web表单的对应的<code>AuthenticationProvider</code>实现类为<code>DaoAuthenticationProvider</code>，它的内部又维护着一个<code>UserDetailsService</code>负责<code>UserDetails</code>的获取。最终<code>AuthenticationProvider</code>将<code>UserDetails</code>填充至<code>Authentication</code>。</p><p>认证核心组件的大体关系如下：<br><img src="https://tva2.sinaimg.cn/large/006MOU0zgy1gjtt39zvklj30gs0b7dhf.jpg" alt="AuthenticationManager" referrerpolicy="no-referrer"></p><h4 id="AuthenticationProvider"><a href="#AuthenticationProvider" class="headerlink" title="AuthenticationProvider"></a>AuthenticationProvider</h4><p>通过前面的Spring Security认证流程我们得知，认证管理器（<strong>AuthenticationManager</strong>）委托<strong>AuthenticationProvider</strong>完成认证工作。</p><p><strong>AuthenticationProvider</strong>是一个接口，定义如下：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line">    <span class="function">Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><strong>authenticate()</strong>方法定义了<strong>认证的实现过程</strong>，它的参数是一个<code>Authentication</code>，里面包含了登录用户所提交的用户、密码等。而返回值也是一个<code>Authentication</code>，这个<code>Authentication</code>则是在认证成功后，将用户的权限及其他信息重新组装后生成。</p><p><strong>Spring Security</strong>中维护着一个 <code>List&lt;AuthenticationProvider&gt;</code> 列表，存放多种认证方式，不同的认证方式使用不同的<code>AuthenticationProvider</code>。如使用用户名密码登录时，使用<code>AuthenticationProvider1</code>，短信登录时使用<code>AuthenticationProvider2</code>等等这样的例子很多。</p><p>每个<code>AuthenticationProvider</code>需要实现<strong>supports（）</strong>方法来表明自己支持的认证方式，如我们使用表单方式认证，在提交请求时<code>Spring Security</code>会生成<code>UsernamePasswordAuthenticationToken</code>，它是一个<code>Authentication</code>，里面封装着用户提交的用户名、密码信息。而对应的，哪个<code>AuthenticationProvider</code>来处理它？</p><p>我们在<strong>DaoAuthenticationProvider</strong>的基类<code>AbstractUserDetailsAuthenticationProvider</code>发现以下代码：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> UsernamePasswordAuthenticationToken.class.isAssignableFrom(authentication);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><strong>也就是说当web表单提交用户名密码时，Spring Security由DaoAuthenticationProvider处理。</strong></p><p>最后，我们来看一下 <strong>Authentication</strong>(认证信息)的结构，它是一个接口，我们之前提到的<code>UsernamePasswordAuthenticationToken</code>就是它的实现之一：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Authentication</span> <span class="keyword">extends</span> <span class="title">Principal</span>, <span class="title">Serializable</span> </span>&#123;         （<span class="number">1</span>）</span><br><span class="line">    Collection&lt;? extends GrantedAuthority&gt; getAuthorities();              （<span class="number">2</span>）</span><br><span class="line">   </span><br><span class="line">   <span class="function">Object <span class="title">getCredentials</span><span class="params">()</span></span>;   （<span class="number">3</span>）                                                           </span><br><span class="line">    <span class="function">Object <span class="title">getDetails</span><span class="params">()</span></span>;                                                  （<span class="number">4</span>）</span><br><span class="line">    <span class="function">Object <span class="title">getPrincipal</span><span class="params">()</span></span>;                                                （<span class="number">5</span>）</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAuthenticated</span><span class="params">()</span></span>;                                           </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> var1)</span> <span class="keyword">throws</span> IllegalArgumentException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（1）<code>Authentication</code>是<code>spring security</code>包中的接口，直接继承自<code>Principal</code>类，而<code>Principal</code>是位于 <code>java.security</code>包中的。它是表示着一个抽象主体身份，任何主体都有一个名称，因此包含一个getName()方法。<br>（2）<code>getAuthorities()</code>，权限信息列表，默认是<code>GrantedAuthority</code>接口的一些实现类，通常是代表权限信息的一系列字符串。<br>（3）<code>getCredentials()</code>，凭证信息，用户输入的密码字符串，在认证过后通常会被移除，用于保障安全。<br>（4）<code>getDetails()</code>，细节信息，web应用中的实现接口通常为 <code>WebAuthenticationDetails</code>，它记录了访问者的<code>ip</code>地址和<code>sessionId</code>的值。<br>（5）<code>getPrincipal()</code>，身份信息，大部分情况下返回的是<code>UserDetails</code>接口的实现类，U<code>serDetails</code>代表用户的详细信息，那从<code>Authentication</code>中取出来的<code>UserDetails</code>就是当前登录用户信息，它也是框架中的常用接口之一。</p><h4 id="UserDetailsService"><a href="#UserDetailsService" class="headerlink" title="UserDetailsService"></a>UserDetailsService</h4><p>1）认识UserDetailsService</p><p>现在咱们现在知道<code>DaoAuthenticationProvider</code>处理了 web 表单的认证逻辑，认证成功后既得到一个<code>Authentication(UsernamePasswordAuthenticationToken实现)</code>，里面包含了身份信息（<code>Principal</code>）。这个身份信息就是一个 <code>Object</code> ，大多数情况下它可以被强转为UserDetails对象。</p><p><code>DaoAuthenticationProvider</code>中包含了一个<code>UserDetailsService</code>实例，它负责根据用户名提取用户信息<code>UserDetails</code>(<strong>包含密码</strong>)，而后<code>DaoAuthenticationProvider</code>会去对比<code>UserDetailsService</code>提取的用户密码与用户提交的密码是否匹配作为认证成功的关键依据，因此可以通过将自定义的 <code>UserDetailsService</code> 公开为<code>spring bean</code>来定义自定义身份验证。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailsService</span> </span>&#123;   </span><br><span class="line"><span class="function">UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException</span>;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很多人把 <code>DaoAuthenticationProvider</code>和<code>UserDetailsService</code>的职责搞混淆，其实<code>UserDetailsService</code>只负责从特定的地方（通常是数据库）加载用户信息，仅此而已。而<code>DaoAuthenticationProvider</code>的职责更大，它完成完整的认证流程，同时会把<code>UserDetails</code>填充至<code>Authentication</code>。</p><p>上面一直提到<code>UserDetails</code>是用户信息，咱们看一下它的真面目：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetails</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">   Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</span><br><span class="line">   <span class="function">String <span class="title">getPassword</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>它和<code>Authentication</code>接口很类似，比如它们都拥有<code>username，authorities</code>。<code>Authentication</code>的<code>getCredentials()</code>与<code>UserDetails</code>中的<code>getPassword()</code>需要被区分对待，前者是用户提交的密码凭证，后者是用户实际存储的密码，认证其实就是对这两者的比对。<code>Authentication</code>中的<code>getAuthorities()</code>实际是由<code>UserDetails</code>的<code>getAuthorities()</code>传递而形成的。还记得Authentication接口中的<code>getDetails()</code>方法吗？其中的<code>UserDetails</code>用户详细信息便是经过了<code>AuthenticationProvider</code>认证之后被填充的。</p><p>通过实现<code>UserDetailsService</code>和<code>UserDetails</code>，我们可以完成对用户信息获取方式以及用户信息字段的扩展。</p><p><code>Spring Security</code>提供的<code>InMemoryUserDetailsManager</code>(内存认证)，<code>JdbcUserDetailsManager(jdbc认证)</code>就是<code>UserDetailsService</code>的实现类，主要区别无非就是从内存还是从数据库加载用户。</p><p>2）测试自定义<code>UserDetailsService</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringDataUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">//登录账号</span></span><br><span class="line">        System.out.println(<span class="string">"username="</span>+username);</span><br><span class="line">        <span class="comment">//根据账号去数据库查询...</span></span><br><span class="line">        <span class="comment">//这里暂时使用静态数据</span></span><br><span class="line">        UserDetails userDetails =</span><br><span class="line">User.withUsername(username).password(<span class="string">"123"</span>).authorities(<span class="string">"p1"</span>).build();</span><br><span class="line">        <span class="keyword">return</span> userDetails;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>屏蔽安全配置类中 <code>UserDetailsService</code> 的定义<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*    @Bean </span></span><br><span class="line"><span class="comment">    public UserDetailsService userDetailsService()  &#123;</span></span><br><span class="line"><span class="comment">        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();</span></span><br><span class="line"><span class="comment">       </span></span><br><span class="line"><span class="comment">manager.createUser(User.withUsername("zhangsan").password("123").authorities("p1").build());</span></span><br><span class="line"><span class="comment">        manager.createUser(User.withUsername("lisi").password("456").authorities("p2").build());</span></span><br><span class="line"><span class="comment">        return manager;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br></pre></td></tr></table></figure><p></p><p>重启工程，请求认证，<code>SpringDataUserDetailsService</code>的<code>loadUserByUsername</code>方法被调用 ，查询用户信息。</p><h4 id="PasswordEncoder"><a href="#PasswordEncoder" class="headerlink" title="PasswordEncoder"></a>PasswordEncoder</h4><p>1）认识PasswordEncoder</p><p><code>DaoAuthenticationProvider</code>认证处理器通过<code>UserDetailsService</code>获取到<code>UserDetails</code>后，它是如何与请求<code>Authentication</code>中的密码做对比呢？</p><p>在这里<code>Spring Security</code>为了适应多种多样的加密类型，又做了抽象，<code>DaoAuthenticationProvider</code>通过<code>PasswordEncoder</code>接口的<code>matches</code>方法进行密码的对比，而具体的密码对比细节取决于实现：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">encode</span><span class="params">(CharSequence var1)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence var1, String var2)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">upgradeEncoding</span><span class="params">(String encodedPassword)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>而<code>Spring Security</code>提供很多内置的<code>PasswordEncoder</code>，能够开箱即用，使用某种<code>PasswordEncoder</code>只需要进行如下声明即可，如下：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span>  NoOpPasswordEncoder.getInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>NoOpPasswordEncoder</code>采用字符串匹配方法，不对密码进行加密比较处理，密码比较流程如下：</p><ol><li>用户输入密码（明文 ）</li><li><code>DaoAuthenticationProvider</code>获取<code>UserDetails</code>（其中存储了用户的正确密码）</li><li><code>DaoAuthenticationProvider</code>使用<code>PasswordEncoder</code>对输入的密码和正确的密码进行校验，密码一致则校验通过，否则校验失败。</li></ol><p><code>NoOpPasswordEncoder</code> 的校验规则拿 输入的密码和<code>UserDetails</code>中的正确密码进行字符串比较，字符串内容一致则校验通过，否则 校验失败。</p><p>实际项目中推荐使用<code>BCryptPasswordEncoder</code>, <code>Pbkdf2PasswordEncoder</code>, <code>SCryptPasswordEncoder</code>等，感兴趣的大家可以看看这些<strong>PasswordEncoder</strong>的具体实现。</p><p>2）使用<code>CryptPasswordEncoder</code></p><p>1、配置BCryptPasswordEncoder<br>在安全配置类中定义：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>测试发现认证失败，提示：<strong>Encoded password does not look like BCrypt</strong>。</p><p>原因：<br>由于<code>UserDetails</code>中存储的是原始密码（比如：123），它不是<code>BCrypt</code>格式。<br>跟踪 <code>DaoAuthenticationProvider</code>第 33 行代码查看 <code>userDetails</code>中的内容 ，跟踪第 38 行代码查看<br><code>PasswordEncoder</code>的类型。</p><p>2、测试BCrypt<br>通过下边的代码测试BCrypt加密及校验的方法</p><p>添加依赖：<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring‐boot‐starter‐test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>编写测试方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class) </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBCrypt</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//对原始密码加密</span></span><br><span class="line">        String hashpw = BCrypt.hashpw(<span class="string">"123"</span>,BCrypt.gensalt());</span><br><span class="line">        System.out.println(hashpw);</span><br><span class="line">        <span class="comment">//校验原始密码和BCrypt密码是否一致</span></span><br><span class="line">        <span class="keyword">boolean</span> checkpw = BCrypt.checkpw(<span class="string">"123"</span>,</span><br><span class="line"><span class="string">"$2a$10$NlBC84MVb7F95EXYTXwLneXgCca6/GipyWR5NHm8K0203bSQMLpvm"</span>);</span><br><span class="line">        System.out.println(checkpw);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、修改安全配置类<br>将UserDetails中的原始密码修改为BCrypt格式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">manager.createUser(User.withUsername(<span class="string">"zhangsan"</span>).password(<span class="string">"$2a$10$1b5mIkehqv5c4KRrX9bUj.A4Y2hug3I</span></span><br><span class="line"><span class="string">GCnMCL5i4RpQrYV12xNKye"</span>).authorities(<span class="string">"p1"</span>).build());</span><br></pre></td></tr></table></figure><p>实际项目中存储在数据库中的密码并不是原始密码，都是经过加密处理的密码。</p><h3 id="授权流程"><a href="#授权流程" class="headerlink" title="授权流程"></a>授权流程</h3><h4 id="授权流程-1"><a href="#授权流程-1" class="headerlink" title="授权流程"></a>授权流程</h4><p>通过快速上手我们知道，<code>Spring Security</code>可以通过 <code>http.authorizeRequests()</code>对web请求进行授权保护。<code>Spring Security</code>使用标准<code>Filter</code>建立了对web请求的拦截，最终实现对资源的授权访问。</p><p><code>Spring Security</code>的授权流程如下：</p><p><img src="https://tvax2.sinaimg.cn/large/006MOU0zgy1gjttzdkri4j30l00b0dhy.jpg" alt="SpringSecurity授权流程" referrerpolicy="no-referrer"></p><p>分析授权流程：</p><ol><li>拦截请求，已认证用户访问受保护的web资源将被<code>SecurityFilterChain</code>中的 <code>FilterSecurityInterceptor</code> 的子类拦截。</li><li><p>获取资源访问策略，<code>FilterSecurityInterceptor</code>会从 <code>SecurityMetadataSource</code> 的子类<code>DefaultFilterInvocationSecurityMetadataSource</code> 获取要访问当前资源所需要的权限<code>Collection&lt;ConfigAttribute&gt;</code> 。<br><code>SecurityMetadataSource</code>其实就是读取访问策略的抽象，而读取的内容，其实就是我们配置的访问规则， 读取访问策略如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> http</span><br><span class="line">.authorizeRequests()                                                               </span><br><span class="line">        .antMatchers(<span class="string">"/r/r1"</span>).hasAuthority(<span class="string">"p1"</span>)                                     </span><br><span class="line">        .antMatchers(<span class="string">"/r/r2"</span>).hasAuthority(<span class="string">"p2"</span>)</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure></li><li><p>最后，<code>FilterSecurityInterceptor</code>会调用 <code>AccessDecisionManager</code> 进行授权决策，若决策通过，则允许访问资源，否则将禁止访问。<br><code>AccessDecisionManager</code>（访问决策管理器）的核心接口如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccessDecisionManager</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**  </span></span><br><span class="line"><span class="comment">   * 通过传递的参数来决定用户是否有访问对应受保护资源的权限  </span></span><br><span class="line"><span class="comment">   */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication authentication , Object object, Collection&lt;ConfigAttribute&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">configAttributes )</span> <span class="keyword">throws</span> AccessDeniedException, InsufficientAuthenticationException</span>;</span><br><span class="line"> <span class="comment">//略..    </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>这里着重说明一下<code>decide</code>的参数：<br><strong>authentication：</strong>要访问资源的访问者的身份<br><strong>object：</strong>要访问的受保护资源，web请求对应<code>FilterInvocation</code><br><strong>configAttributes：</strong>是受保护资源的访问策略，通过<code>SecurityMetadataSource</code>获取。<br><strong>decide接口就是用来鉴定当前用户是否有访问对应受保护资源的权限。</strong></p><h4 id="授权决策"><a href="#授权决策" class="headerlink" title="授权决策"></a>授权决策</h4><p><code>AccessDecisionManager</code>采用投票的方式来确定是否能够访问受保护资源。</p><p><img src="https://tva2.sinaimg.cn/large/006MOU0zgy1gjtu5qcasdj30j2063gmr.jpg" alt="AccessDecisionManager" referrerpolicy="no-referrer"></p><p>通过上图可以看出，<code>AccessDecisionManager</code>中包含的一系列<code>AccessDecisionVoter</code>将会被用来对<code>Authentication</code>是否有权访问受保护对象进行投票，<code>AccessDecisionManage</code>r根据投票结果，做出最终决策。</p><p><code>AccessDecisionVoter</code>是一个接口，其中定义有三个方法，具体结构如下所示。<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccessDecisionVoter</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ACCESS_GRANTED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> ACCESS_ABSTAIN = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ACCESS_DENIED = ‐<span class="number">1</span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(ConfigAttribute var1)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; var1)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">vote</span><span class="params">(Authentication var1, S var2, Collection&lt;ConfigAttribute&gt; var3)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><code>vote()</code>方法的返回结果会是<code>AccessDecisionVoter</code>中定义的三个常量之一。<code>ACCESS_GRANTED</code>表示同意，<code>ACCESS_DENIED</code>表示拒绝，<code>ACCESS_ABSTAIN</code>表示弃权。如果一个<code>AccessDecisionVoter</code>不能判定当前<code>Authentication</code>是否拥有访问对应受保护对象的权限，则其<code>vote()</code>方法的返回值应当为弃权<code>ACCESS_ABSTAIN</code>。</p><p><code>Spring Security</code>内置了三个基于投票的<code>AccessDecisionManager</code>实现类如下，它们分别是<code>AffirmativeBased、ConsensusBased</code>和<code>UnanimousBased</code>。<br><code>AffirmativeBased</code>的逻辑是：</p><ol><li>只要有<code>AccessDecisionVoter</code>的投票为<code>ACCESS_GRANTED</code>则同意用户进行访问；</li><li>如果全部弃权也表示通过；</li><li>如果没有一个人投赞成票，但是有人投反对票，则将抛出<code>AccessDeniedException</code>。</li></ol><p>Spring security默认使用的是<strong>AffirmativeBased</strong>。</p><p><strong>ConsensusBased</strong>的逻辑是：</p><ol><li>如果赞成票多于反对票则表示通过。</li><li>反过来，如果反对票多于赞成票则将抛出<code>AccessDeniedException</code>。</li><li>如果赞成票与反对票相同且不等于0，并且属性<code>allowIfEqualGrantedDeniedDecisions</code>的值为true，则表示通过，否则将抛出异常<code>AccessDeniedException</code>。参数<code>allowIfEqualGrantedDeniedDecisions</code>的值默认为true。</li><li>如果所有的AccessDecisionVoter都弃权了，则将视参数<code>allowIfAllAbstainDecisions</code>的值而定，如果该值为true则表示通过，否则将抛出异常<code>AccessDeniedException</code>。参数<code>allowIfAllAbstainDecisions</code>的值默认为false。</li></ol><p><strong>UnanimousBased</strong>的逻辑与另外两种实现有点不一样，另外两种会一次性把受保护对象的配置属性全部传递给<code>AccessDecisionVoter</code>进行投票，而<code>UnanimousBased</code>会一次只传递一个<code>ConfigAttribute</code>给<code>AccessDecisionVoter</code>进行投票。这也就意味着如果我们的<code>AccessDecisionVoter</code>的逻辑是只要传递进来的<br><code>ConfigAttribute</code>中有一个能够匹配则投赞成票，但是放到<code>UnanimousBased</code>中其投票结果就不一定是赞成了。</p><p><strong>UnanimousBased</strong>的逻辑具体来说是这样的：</p><ol><li>如果受保护对象配置的某一个<code>ConfigAttribute</code>被任意的<code>AccessDecisionVoter</code>反对了，则将抛出<code>AccessDeniedException</code>。</li><li>如果没有反对票，但是有赞成票，则表示通过。</li><li>如果全部弃权了，则将视参数<code>allowIfAllAbstainDecisions</code>的值而定，true则通过，false则抛出<code>AccessDeniedException</code>。</li></ol><p>Spring Security也内置一些投票者实现类如<code>RoleVoter、AuthenticatedVoter和WebExpressionVoter</code>等，可以自行查阅资料进行学习。</p><h2 id="自定义认证"><a href="#自定义认证" class="headerlink" title="自定义认证"></a>自定义认证</h2><p>Spring Security提供了非常好的认证扩展方法，比如：快速上手中将用户信息存储到内存中，实际开发中用户信息通常在数据库，Spring security可以实现从数据库读取用户信息，Spring security还支持多种授权方法。</p><h3 id="自定义登录页面"><a href="#自定义登录页面" class="headerlink" title="自定义登录页面"></a>自定义登录页面</h3><p>在快速上手中，你可能会想知道登录页面从哪里来的？因为我们并没有提供任何的HTML或JSP文件。Spring Security的默认配置没有明确设定一个登录页面的URL，因此Spring Security会根据启用的功能自动生成一个登录页面URL，并使用默认URL处理登录的提交内容，登录后跳转的到默认URL等等。尽管自动生成的登录页面很方便快速启动和运行，但大多数应用程序都希望定义自己的登录页面。</p><h4 id="认证页面-1"><a href="#认证页面-1" class="headerlink" title="认证页面"></a>认证页面</h4><p>将security-springmvc工程的login.jsp拷贝到security-springboot下，目录保持一致。</p><h4 id="配置认证页面"><a href="#配置认证页面" class="headerlink" title="配置认证页面"></a>配置认证页面</h4><p>在WebConfig.java中配置认证页面地址：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认Url根路径跳转到/login，此url为spring security提供</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">    registry.addViewController(<span class="string">"/"</span>).setViewName(<span class="string">"redirect:/login‐view"</span>);</span><br><span class="line">    registry.addViewController(<span class="string">"/login‐view"</span>).setViewName(<span class="string">"login"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h4 id="安全配置-2"><a href="#安全配置-2" class="headerlink" title="安全配置"></a>安全配置</h4><p>在WebSecurityConfig中配置表章登录信息：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 配置安全拦截机制</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">            .antMatchers(<span class="string">"/r/**"</span>).authenticated()              </span><br><span class="line">            .anyRequest().permitAll()                          </span><br><span class="line">            .and()</span><br><span class="line">            .formLogin()                 (<span class="number">1</span>)</span><br><span class="line">          .loginPage(<span class="string">"/login‐view"</span>)        (<span class="number">2</span>)</span><br><span class="line">          .loginProcessingUrl(<span class="string">"/login"</span>)      (<span class="number">3</span>)</span><br><span class="line">          .successForwardUrl(<span class="string">"/login‐success"</span>)   (<span class="number">4</span>)</span><br><span class="line">          .permitAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>（1）允许表单登录<br>（2）指定我们自己的登录页,spring security以重定向方式跳转到/login-view<br>（3）指定登录处理的URL，也就是用户名、密码表单提交的目的路径<br>（4）指定登录成功后的跳转URL<br>（5）我们必须允许所有用户访问我们的登录页（例如为验证的用户），这个 <code>formLogin().permitAll()</code> 方法允许任意用户访问基于表单登录的所有的URL。</p><h4 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h4><p>当用户没有认证时访问系统的资源会重定向到login-view页面<br><img src="https://tva3.sinaimg.cn/large/006MOU0zgy1gjtc5wve76j30al03gjrc.jpg" alt="security登录" referrerpolicy="no-referrer"></p><p>输入账号和密码，点击登录,报错：</p><blockquote><p>Whitelabel Error Page<br>Type=Forbidden，Status=403</p></blockquote><p>问题解决：<br>spring security为防止<strong>CSRF（Cross-site request forgery跨站请求伪造）</strong>的发生，限制了除了get以外的大多数方法。</p><p>解决方法1：<br>屏蔽CSRF控制，即spring security不再限制CSRF。<br>配置WebSecurityConfig<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http.csrf().disable()  <span class="comment">//屏蔽CSRF控制，即spring security不再限制CSRF</span></span><br><span class="line">            ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>本案例采用方法1</p><p>解决方法2：<br>在login.jsp页面添加一个<code>token</code>，spring security会验证<code>token</code>，如果<code>token</code>合法则可以继续请求。<br>修改login.jsp<br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"login"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span>  <span class="attr">name</span>=<span class="string">"$&#123;_csrf.parameterName&#125;"</span>   <span class="attr">value</span>=<span class="string">"$&#123;_csrf.token&#125;"</span>/&gt;</span></span><br><span class="line">   ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><h3 id="连接数据库认证"><a href="#连接数据库认证" class="headerlink" title="连接数据库认证"></a>连接数据库认证</h3><p>前边的例子我们是将用户信息存储在内存中，实际项目中用户信息存储在数据库中，本节实现从数据库读取用户信息。根据前边对认证流程研究，只需要重新定义UserDetailService即可实现根据用户账号查询数据库。</p><h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><p>创建user_db数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="string">`user_db`</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> <span class="string">'utf8'</span> <span class="keyword">COLLATE</span> <span class="string">'utf8_general_ci'</span>;</span><br></pre></td></tr></table></figure><p>创建t_user表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_user`</span> ( </span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户id'</span>,</span><br><span class="line">  <span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`password`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`fullname`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户姓名'</span>,</span><br><span class="line">  <span class="string">`mobile`</span> <span class="built_in">varchar</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'手机号'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 ROW_FORMAT=DYNAMIC</span><br></pre></td></tr></table></figure><h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p>1）定义dataSource<br>在application.properties配置<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.url=jdbc:mysql://localhost:3306/user_db </span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=mysql</span><br><span class="line">spring.datasource.driver‐class‐name=com.mysql.jdbc.Driver</span><br></pre></td></tr></table></figure><p></p><p>2）添加依赖<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring‐boot‐starter‐test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring‐boot‐starter‐jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql‐connector‐java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>3）定义Dao<br>定义模型类型，在 model包定义UserDto：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String fullname;</span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>在Dao包定义UserDao：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JdbcTemplate jdbcTemplate;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDto <span class="title">getUserByUsername</span><span class="params">(String username)</span></span>&#123;</span><br><span class="line">        String sql =<span class="string">"select id,username,password,fullname from t_user where username = ?"</span>;</span><br><span class="line">        List&lt;UserDto&gt; list = jdbcTemplate.query(sql, <span class="keyword">new</span> Object[]&#123;username&#125;, <span class="keyword">new</span></span><br><span class="line">BeanPropertyRowMapper&lt;&gt;(UserDto.class));</span><br><span class="line">        <span class="keyword">if</span>(list == <span class="keyword">null</span> &amp;&amp; list.size() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h4 id="定义UserDetailService"><a href="#定义UserDetailService" class="headerlink" title="定义UserDetailService"></a>定义UserDetailService</h4><p>在service包下定义<code>SpringDataUserDetailsService</code>：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringDataUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserDao userDao;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">//登录账号</span></span><br><span class="line">        System.out.println(<span class="string">"username="</span>+username);</span><br><span class="line">        <span class="comment">//根据账号去数据库查询...</span></span><br><span class="line">        UserDto user = userDao.getUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;        <span class="comment">// 这里暂时使用静态数据</span></span><br><span class="line">        UserDetails userDetails =</span><br><span class="line">User.withUsername(user.getFullname()).password(user.getPassword()).authorities(<span class="string">"p1"</span>).build();</span><br><span class="line">        <span class="keyword">return</span> userDetails;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h4 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h4><p>输入账号和密码请求认证，跟踪代码。</p><h4 id="使用BCryptPasswordEncoder"><a href="#使用BCryptPasswordEncoder" class="headerlink" title="使用BCryptPasswordEncoder"></a>使用BCryptPasswordEncoder</h4><p>按照我们前边讲的PasswordEncoder的使用方法，使用BCryptPasswordEncoder需要完成如下工作：<br>1、在安全配置类中定义BCryptPasswordEncoder<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span>  <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>2、UserDetails中的密码存储BCrypt格式<br>前边实现了从数据库查询用户信息，所以数据库中的密码应该存储BCrypt格式</p><h2 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h2><p>用户认证通过后，为了避免用户的每次操作都进行认证可将用户的信息保存在会话中。<code>spring security</code>提供会话管理，认证通过后将身份信息放入<code>SecurityContextHolder</code>上下文，<code>SecurityContext</code>与当前线程进行绑定，方便获取用户身份。</p><h3 id="获取用户身份"><a href="#获取用户身份" class="headerlink" title="获取用户身份"></a>获取用户身份</h3><p>编写LoginController，实现<code>/r/r1、/r/r2</code>的测试资源，并修改<code>loginSuccess</code>方法，注意<code>getUsername</code>方法，Spring<br>Security获取当前登录用户信息的方法为<code>SecurityContextHolder.getContext().getAuthentication()</code><br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户登录成功</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/login‐success"</span>,produces = &#123;<span class="string">"text/plain;charset=UTF‐8"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">loginSuccess</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String username = getUsername();</span><br><span class="line">        <span class="keyword">return</span> username + <span class="string">" 登录成功"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前登录用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getUsername</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        <span class="keyword">if</span>(!authentication.isAuthenticated())&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Object principal = authentication.getPrincipal();</span><br><span class="line">        String username = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> org.springframework.security.core.userdetails.UserDetails) &#123;</span><br><span class="line">            username =</span><br><span class="line">((org.springframework.security.core.userdetails.UserDetails)principal).getUsername();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            username = principal.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试资源1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/r/r1"</span>,produces = &#123;<span class="string">"text/plain;charset=UTF‐8"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">r1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String username = getUsername();</span><br><span class="line">        <span class="keyword">return</span> username + <span class="string">" 访问资源1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试资源2</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/r/r2"</span>,produces = &#123;<span class="string">"text/plain;charset=UTF‐8"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">r2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String username = getUsername();</span><br><span class="line">        <span class="keyword">return</span> username + <span class="string">" 访问资源2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>测试<br>登录前访问资源<br>被重定向至登录页面。<br>登录后访问资源<br>成功访问资源，如下：</p><blockquote><p>zhangsan 访问资源1</p></blockquote><h3 id="会话控制"><a href="#会话控制" class="headerlink" title="会话控制"></a>会话控制</h3><p>我们可以通过以下选项准确控制会话何时创建以及Spring Security如何与之交互：</p><table><thead><tr><th style="text-align:center">机制</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">always</td><td style="text-align:center">总是创建一个session</td></tr><tr><td style="text-align:center">ifRequired</td><td style="text-align:center">如果需要就创建一个Session（默认）登录时</td></tr><tr><td style="text-align:center">never</td><td style="text-align:center">SpringSecurity 将不会创建Session，但是如果应用中其他地方创建了Session，那么SpringSecurity将会使用它。</td></tr><tr><td style="text-align:center">stateless</td><td style="text-align:center">SpringSecurity将绝对不会创建Session，也不使用Session</td></tr></tbody></table><p>通过以下配置方式对该选项进行配置：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   http.sessionManagement()</span><br><span class="line">        .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>默认情况下，Spring Security会为每个登录成功的用户会新建一个Session，就是<strong>ifRequired</strong> 。</p><p>若选用<strong>never</strong>，则指示Spring Security对登录成功的用户不创建Session了，但若你的应用程序在某地方新建了session，那么Spring Security会用它的。</p><p>若使用<strong>stateless</strong>，则说明Spring Security对登录成功的用户不会创建Session了，你的应用程序也不会允许新建session。并且它会暗示不使用<code>cookie</code>，所以每个请求都需要重新进行身份验证。这种无状态架构适用于<strong>REST API</strong>及其无状态认证机制。</p><p><strong>会话超时</strong></p><p>可以再sevlet容器中设置Session的超时时间，如下设置Session有效期为3600s；<br>spring boot 配置文件：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server.servlet.session.timeout=3600s</span><br></pre></td></tr></table></figure><p></p><p>session超时之后，可以通过Spring Security 设置跳转的路径。<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.sessionManagement()</span><br><span class="line">    .expiredUrl(<span class="string">"/login‐view?error=EXPIRED_SESSION"</span>)</span><br><span class="line">    .invalidSessionUrl(<span class="string">"/login‐view?error=INVALID_SESSION"</span>);</span><br></pre></td></tr></table></figure><p></p><p><code>expired</code>指<strong>session过期</strong>，<code>invalidSession</code>指传入的<strong>sessionid无效</strong>。</p><p><strong>安全会话cookie</strong><br>我们可以使用httpOnly和secure标签来保护我们的会话cookie：</p><ul><li>httpOnly ：如果为true，那么浏览器脚本将无法访问cookie</li><li>secure ：如果为true，则cookie将仅通过HTTPS连接发送<br>spring boot 配置文件：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server.servlet.session.cookie.http‐only=true</span><br><span class="line">server.servlet.session.cookie.secure=true</span><br></pre></td></tr></table></figure></li></ul><p>4.6 退出<br>Spring security默认实现了logout退出，访问/logout，果然不出所料，退出功能Spring也替我们做好了。</p><p><img src="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjtvc88t2pj308404zaa6.jpg" alt="SpringSecurityLogout" referrerpolicy="no-referrer"></p><p>点击<strong>“Log Out”</strong>退出 成功。<br>退出 后访问其它url判断是否成功退出。<br>这里也可以自定义退出成功的页面：<br>在WebSecurityConfig的<code>protected void configure(HttpSecurity http)</code>中配置：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.and() </span><br><span class="line">.logout()</span><br><span class="line">.logoutUrl(<span class="string">"/logout"</span>)</span><br><span class="line">.logoutSuccessUrl(<span class="string">"/login‐view?logout"</span>);</span><br></pre></td></tr></table></figure><p></p><p>当退出操作出发时，将发生：</p><ul><li>使 <code>HTTP Session</code> 无效</li><li>清除 <code>SecurityContextHolder</code></li><li>跳转到 <code>/login -view?logout</code><br>但是，类似于配置登录功能，咱们可以进一步自定义退出功能：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http</span><br><span class="line">            .authorizeRequests()</span><br><span class="line">       <span class="comment">//...      </span></span><br><span class="line">            .and()</span><br><span class="line">            .logout()                                                    (<span class="number">1</span>)</span><br><span class="line">                .logoutUrl(<span class="string">"/logout"</span>)                                    (<span class="number">2</span>)</span><br><span class="line">                .logoutSuccessUrl(<span class="string">"/login‐view?logout"</span>)                  (<span class="number">3</span>)</span><br><span class="line">                .logoutSuccessHandler(logoutSuccessHandler)              (<span class="number">4</span>)</span><br><span class="line">           .addLogoutHandler(logoutHandler)                         (<span class="number">5</span>)      </span><br><span class="line">                .invalidateHttpSession(<span class="keyword">true</span>);                             (<span class="number">6</span>)</span><br><span class="line">               </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>（1）提供系统退出支持，使用 WebSecurityConfigurerAdapter 会自动被应用<br>（2）设置触发退出操作的URL (默认是 /logout ).<br>（3）退出之后跳转的URL。默认是 /login?logout 。<br>（4）定制的 LogoutSuccessHandler ，用于实现用户退出成功时的处理。如果指定了这个选项那么logoutSuccessUrl() 的设置会被忽略。<br>（5）添加一个 LogoutHandler ，用于实现用户退出时的清理工作.默认 SecurityContextLogoutHandler 会被添加为最后一个 LogoutHandler 。<br>（6）指定是否在退出时让 HttpSession 无效。 默认设置为 true。<br><strong>注意：如果让logout在GET请求下生效，必须关闭防止CSRF攻击csrf().disable()。如果开启了CSRF，必须使用post方式请求/logout</strong></p><p>logoutHandler：<br>一般来说， LogoutHandler 的实现类被用来执行必要的清理，因而他们不应该抛出异常。<br>下面是Spring Security提供的一些实现：</p><ul><li><code>PersistentTokenBasedRememberMeServices</code> 基于持久化<code>token</code>的<strong>RememberMe</strong>功能的相关清理</li><li><code>TokenBasedRememberMeService</code> 基于<code>token</code>的<strong>RememberMe</strong>功能的相关清理</li><li><code>CookieClearingLogoutHandler</code> 退出时<code>Cookie</code>的相关清理</li><li><code>CsrfLogoutHandler</code> 负责在退出时移除<code>csrfToken</code></li><li><code>SecurityContextLogoutHandler</code> 退出时<code>SecurityContext</code>的相关清理</li></ul><p>链式API提供了调用相应的 <code>LogoutHandler</code> 实现的快捷方式，比如<code>deleteCookies()</code>。</p><h2 id="授权-1"><a href="#授权-1" class="headerlink" title="授权"></a>授权</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>授权的方式包括 web授权和方法授权，web授权是通过 url拦截进行授权，方法授权是通过 方法拦截进行授权。他们都会调用<code>accessDecisionManager</code>进行授权决策，若为web授权则拦截器为<code>FilterSecurityInterceptor</code>；若为方法授权则拦截器为<code>MethodSecurityInterceptor</code>。如果同时通过web授权和方法授权则先执行web授权，再执行方法授权，最后决策通过，则允许访问资源，否则将禁止访问。</p><p>类关系如下：<br><img src="https://tva1.sinaimg.cn/large/006MOU0zgy1gjtvhixrpwj30kc05cwfm.jpg" alt="SpringSecurity类关系图" referrerpolicy="no-referrer"></p><h3 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h3><h4 id="数据库环境"><a href="#数据库环境" class="headerlink" title="数据库环境"></a>数据库环境</h4><p>在t_user数据库创建如下表：</p><p>角色表：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_role`</span> ( </span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`role_name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`description`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`update_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`status`</span> <span class="built_in">char</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`unique_role_name`</span> (<span class="string">`role_name`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`t_role`</span>(<span class="string">`id`</span>,<span class="string">`role_name`</span>,<span class="string">`description`</span>,<span class="string">`create_time`</span>,<span class="string">`update_time`</span>,<span class="string">`status`</span>) <span class="keyword">values</span></span><br><span class="line">(<span class="string">'1'</span>,<span class="string">'管理员'</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="string">''</span>);</span><br></pre></td></tr></table></figure><p>用户角色关系表：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_user_role`</span> ( </span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`role_id`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`creator`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`user_id`</span>,<span class="string">`role_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`t_user_role`</span>(<span class="string">`user_id`</span>,<span class="string">`role_id`</span>,<span class="string">`create_time`</span>,<span class="string">`creator`</span>) <span class="keyword">values</span></span><br><span class="line">(<span class="string">'1'</span>,<span class="string">'1'</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>权限表：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_permission`</span> ( </span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`code`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'权限标识符'</span>,</span><br><span class="line">  <span class="string">`description`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'描述'</span>,</span><br><span class="line">  <span class="string">`url`</span> <span class="built_in">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'请求地址'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`t_permission`</span>(<span class="string">`id`</span>,<span class="string">`code`</span>,<span class="string">`description`</span>,<span class="string">`url`</span>) <span class="keyword">values</span> (<span class="string">'1'</span>,<span class="string">'p1'</span>,<span class="string">'测试资源</span></span><br><span class="line"><span class="string">1'</span>,<span class="string">'/r/r1'</span>),(<span class="string">'2'</span>,<span class="string">'p3'</span>,<span class="string">'测试资源2'</span>,<span class="string">'/r/r2'</span>);</span><br></pre></td></tr></table></figure><p></p><p>角色权限关系表：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_role_permission`</span> ( </span><br><span class="line">  <span class="string">`role_id`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`permission_id`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`role_id`</span>,<span class="string">`permission_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</span><br><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> <span class="string">`t_role_permission`</span>(<span class="string">`role_id`</span>,<span class="string">`permission_id`</span>) <span class="keyword">values</span> (<span class="string">'1'</span>,<span class="string">'1'</span>),(<span class="string">'1'</span>,<span class="string">'2'</span>);</span><br></pre></td></tr></table></figure><p></p><h4 id="修改UserDetailService"><a href="#修改UserDetailService" class="headerlink" title="修改UserDetailService"></a>修改UserDetailService</h4><p>1、修改dao接口<br>在UserDao中添加：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据用户id查询用户权限</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">findPermissionsByUserId</span><span class="params">(String userId)</span></span>&#123;</span><br><span class="line">    String sql=<span class="string">"SELECT * FROM t_permission WHERE id IN(\n"</span> +</span><br><span class="line">            <span class="string">"SELECT permission_id FROM t_role_permission WHERE role_id IN(\n"</span> +</span><br><span class="line">            <span class="string">"\tSELECT role_id FROM t_user_role WHERE user_id = ? \n"</span> +</span><br><span class="line">            <span class="string">")\n"</span> +</span><br><span class="line">            <span class="string">")"</span>;</span><br><span class="line">    List&lt;PermissionDto&gt; list = jdbcTemplate.query(sql, <span class="keyword">new</span> Object[]&#123;userId&#125;, <span class="keyword">new</span></span><br><span class="line">BeanPropertyRowMapper&lt;&gt;(PermissionDto.class));</span><br><span class="line">    List&lt;String&gt; permissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    list.iterator().forEachRemaining(c‐&gt;permissions.add(c.getCode()));</span><br><span class="line">    <span class="keyword">return</span> permissions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>2、修改UserDetailService<br>实现从数据库读取权限<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">    <span class="comment">//登录账号</span></span><br><span class="line">    System.out.println(<span class="string">"username="</span>+username);</span><br><span class="line">    <span class="comment">//根据账号去数据库查询...</span></span><br><span class="line">    UserDto user = userDao.getUserByUsername(username);</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查询用户权限</span></span><br><span class="line">    List&lt;String&gt; permissions = userDao.findPermissionsByUserId(user.getId());</span><br><span class="line">    String[] perarray = <span class="keyword">new</span> String[permissions.size()];</span><br><span class="line">    permissions.toArray(perarray);</span><br><span class="line">    <span class="comment">//创建userDetails</span></span><br><span class="line">    UserDetails userDetails =</span><br><span class="line">User.withUsername(user.getFullname()).password(user.getPassword()).authorities(perarray).build();</span><br><span class="line">    <span class="keyword">return</span> userDetails;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="web授权"><a href="#web授权" class="headerlink" title="web授权"></a>web授权</h3><p>在上面例子中我们完成了认证拦截，并对<code>/r/**</code>下的某些资源进行简单的授权保护，但是我们想进行灵活的授权控制该怎么做呢？通过给 <code>http.authorizeRequests()</code> 添加多个子节点来定制需求到我们的URL，如下代码：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http</span><br><span class="line">            .authorizeRequests()                                                           (<span class="number">1</span>)</span><br><span class="line">            .antMatchers(<span class="string">"/r/r1"</span>).hasAuthority(<span class="string">"p1"</span>)                                       (<span class="number">2</span>)</span><br><span class="line">            .antMatchers(<span class="string">"/r/r2"</span>).hasAuthority(<span class="string">"p2"</span>)                                       (<span class="number">3</span>)</span><br><span class="line">            .antMatchers(<span class="string">"/r/r3"</span>).access(<span class="string">"hasAuthority('p1') and hasAuthority('p2')"</span>)      (<span class="number">4</span>)</span><br><span class="line">            .antMatchers(<span class="string">"/r/**"</span>).authenticated()                                          (<span class="number">5</span>)</span><br><span class="line">           .anyRequest().permitAll()                                                      (<span class="number">6</span>)  </span><br><span class="line">       .and()      </span><br><span class="line">             .formLogin()</span><br><span class="line">        <span class="comment">// ...      </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>（1） http.authorizeRequests() 方法有多个子节点，每个macher按照他们的声明顺序执行。<br>（2）指定”/r/r1”URL，拥有p1权限能够访问<br>（3）指定”/r/r2”URL，拥有p2权限能够访问<br>（4）指定了”/r/r3”URL，同时拥有p1和p2权限才能够访问<br>（5）指定了除了r1、r2、r3之外”/r/**”资源，同时通过身份认证就能够访问，这里使用SpEL（Spring Expression Language）表达式。。<br>（6）剩余的尚未匹配的资源，不做保护。</p><p>注意：<br><strong>规则的顺序是重要的,更具体的规则应该先写</strong>.现在以<code>/admin</code>开始的所有内容都需要具有ADMIN角色的身份验证用户,即使是<code>/admin/login</code>路径(因为<code>/admin/login</code>已经被<code>/admin/**</code>规则匹配,因此第二个规则被忽略).</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers(<span class="string">"/admin/**"</span>).hasRole(<span class="string">"ADMIN"</span>) </span><br><span class="line">.antMatchers(<span class="string">"/admin/login"</span>).permitAll()</span><br></pre></td></tr></table></figure><p>因此,登录页面的规则应该在<code>/admin/**</code>规则之前.例如.<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.antMatchers(<span class="string">"/admin/login"</span>).permitAll() </span><br><span class="line">.antMatchers(<span class="string">"/admin/**"</span>).hasRole(<span class="string">"ADMIN"</span>)</span><br></pre></td></tr></table></figure><p></p><p>保护URL常用的方法有：<br><code>authenticated()</code> 保护URL，需要用户登录<br><code>permitAll()</code> 指定URL无需保护，一般应用与静态资源文件<br><code>hasRole(String role)</code> 限制单个角色访问，角色将被增加 <strong>“ROLE_”</strong> .<strong>所以”ADMIN”</strong> 将和 <strong>“ROLE_ADMIN”</strong>进行比较.<br><code>hasAuthority(String authority)</code> 限制单个权限访问<br><code>hasAnyRole(String… roles)</code>允许多个角色访问.<br><code>hasAnyAuthority(String… authorities)</code> 允许多个权限访问.<br><code>access(String attribute)</code> 该方法使用 SpEL表达式, 所以可以创建复杂的限制.<br><code>hasIpAddress(String ipaddressExpression)</code> 限制IP地址或子网</p><h3 id="方法授权"><a href="#方法授权" class="headerlink" title="方法授权"></a>方法授权</h3><p>现在我们已经掌握了使用如何使用 <code>http.authorizeRequests()</code> 对web资源进行授权保护，从Spring Security2.0版本开始，它支持服务层方法的安全性的支持。本节学习<code>@PreAuthorize</code>,<code>@PostAuthorize</code>, <code>@Secured</code>三类注解。我们可以在任何 <code>@Configuration</code> 实例上使用 <code>@EnableGlobalMethodSecurity</code> 注释来启用基于注解的安全性。<br>以下内容将启用Spring Security的 <code>@Secured</code> 注释。<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(securedEnabled = <span class="keyword">true</span>) </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodSecurityConfig</span> </span>&#123;<span class="comment">// ...&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>然后向方法（在类或接口上）添加注解就会限制对该方法的访问。 Spring Security的原生注释支持为该方法定义了<br>一组属性。 这些将被传递给<code>AccessDecisionManager</code>以供它作出实际的决定：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BankService</span> </span>&#123;</span><br><span class="line"><span class="meta">@Secured</span>(<span class="string">"IS_AUTHENTICATED_ANONYMOUSLY"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Account <span class="title">readAccount</span><span class="params">(Long id)</span></span>;</span><br><span class="line"><span class="meta">@Secured</span>(<span class="string">"IS_AUTHENTICATED_ANONYMOUSLY"</span>)</span><br><span class="line"><span class="keyword">public</span> Account[] findAccounts();</span><br><span class="line"><span class="meta">@Secured</span>(<span class="string">"ROLE_TELLER"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Account <span class="title">post</span><span class="params">(Account account, <span class="keyword">double</span> amount)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上配置标明<code>readAccount</code>、<code>findAccounts</code>方法可匿名访问，底层使用<code>WebExpressionVoter</code>投票器，可从<code>AffirmativeBased</code>第23行代码跟踪。。<br><code>post</code>方法需要有<code>TELLER</code>角色才能访问，底层使用<code>RoleVoter</code>投票器。<br>使用如下代码可启用<code>prePost</code>注解的支持</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>) </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodSecurityConfig</span> </span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>相应Java代码如下：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BankService</span> </span>&#123;</span><br><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"isAnonymous()"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Account <span class="title">readAccount</span><span class="params">(Long id)</span></span>;</span><br><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"isAnonymous()"</span>)</span><br><span class="line"><span class="keyword">public</span> Account[] findAccounts();</span><br><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"hasAuthority('p_transfer') and hasAuthority('p_read_account')"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Account <span class="title">post</span><span class="params">(Account account, <span class="keyword">double</span> amount)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>以上配置标明<code>readAccount</code>、<code>findAccounts</code>方法可匿名访问，<code>post</code>方法需要同时拥有<code>p_transfer</code>和<code>p_read_account</code>权限才能访问，底层使用<code>WebExpressionVoter</code>投票器，可从<code>AffirmativeBased</code>第23行代码跟踪。</p></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> 在线分享网</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://me.obey.fun/Spring-Security认证授权.html" title="Spring Security认证授权">https://me.obey.fun/Spring-Security认证授权.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均为原创。转载请注明出处！</li></ul></div><div><div><blockquote class="blockquote-center" style="color:#ccc">-------------本文结束 <i class="fa fa-apple"></i> 感谢您的阅读-------------</blockquote></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><button id="rewardButton" disable="enable" onclick='var e=document.getElementById("QR");"none"===e.style.display?e.style.display="block":e.style.display="none"'><span>打赏</span></button><div>文章对我有益，我要小额赞赏...</div><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/images/wechatpay.jpg" alt="HuiProgramer 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"><img id="alipay_qr" src="/images/alipay.jpg" alt="HuiProgramer 支付宝"><p>支付宝</p></div></div></div></div><footer class="post-footer"><div id="tags" class="post-tags"><a href="/tags/Web认证/" rel="tag">Web认证</a> <a href="/tags/Web授权/" rel="tag">Web授权</a></div><script type="text/javascript">for(var alltags=document.getElementById("tags"),tags=alltags.getElementsByTagName("a"),i=tags.length-1;i>=0;i--){var r=Math.floor(75*Math.random()+130),g=Math.floor(75*Math.random()+100),b=Math.floor(75*Math.random()+80);tags[i].style.background="rgb("+r+","+g+","+b+")"}var text="Spring Security认证授权";document.onreadystatechange=function(){"complete"==document.readyState&&wenkmTips.show("正在阅读 -> "+text)}</script><style type="text/css">.post-tags a{color:#fff;background-color:#f5f7f1;border-radius:6px;padding-right:10px;padding-left:10px;margin-right:5px;margin-left:0;margin-top:18px;margin-bottom:0}.post-tags a:before{content:"📜"}</style><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/centos7系统的配置.html" rel="next" title="Centos7系统的配置"><i class="fa fa-chevron-left"></i> Centos7系统的配置</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/ElasticSearch7-x简单使用.html" rel="prev" title="ElasticSearch7.x简单使用">ElasticSearch7.x简单使用 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><div title="返回顶部(或下方百分比按钮)" class="backtop" style="background-position:0 -1000px"></div><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="https://huiprogramer.gitee.io/medias/avatar.jpg" alt="HuiProgramer" referrerpolicy="no-referrer"><p class="site-author-name" itemprop="name">HuiProgramer</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">54</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">43</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">45</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a rel="external nofollow" href="https://github.com/HuiProgramer" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a rel="external nofollow" href="mailto:huiprogramer@outlook.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a rel="external nofollow" href="https://www.jianshu.com/u/1606b64f25b5" target="_blank" title="简书"><i class="fa fa-fw fa-heartbeat"></i>简书</a> </span><span class="links-of-author-item"><a rel="external nofollow" href="https://cnblogs.com/HuiProgramer" target="_blank" title="博客园"><i class="fa fa-fw fa-book"></i>博客园</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 推荐阅读</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a rel="external nofollow" href="https://me.obey.fun/Git教程.html" title="Git教程" target="_blank">Git教程</a></li><li class="links-of-blogroll-item"><a rel="external nofollow" href="https://me.obey.fun/Markdown基本语法.html" title="Markdown基本语法" target="_blank">Markdown基本语法</a></li><li class="links-of-blogroll-item"><a rel="external nofollow" href="https://me.obey.fun/Java学习路线图.html" title="Java学习路线图" target="_blank">Java学习路线图</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Security-快速上手"><span class="nav-number">1.</span> <span class="nav-text">Spring Security 快速上手</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Security介绍"><span class="nav-number">1.1.</span> <span class="nav-text">Spring Security介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建工程"><span class="nav-number">1.2.</span> <span class="nav-text">创建工程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建maven工程"><span class="nav-number">1.2.1.</span> <span class="nav-text">创建maven工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring容器配置"><span class="nav-number">1.2.2.</span> <span class="nav-text">Spring容器配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Servlet-Context配置"><span class="nav-number">1.2.3.</span> <span class="nav-text">Servlet Context配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加载-Spring容器"><span class="nav-number">1.2.4.</span> <span class="nav-text">加载 Spring容器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#认证"><span class="nav-number">1.3.</span> <span class="nav-text">认证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#认证页面"><span class="nav-number">1.3.1.</span> <span class="nav-text">认证页面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安全配置"><span class="nav-number">1.3.2.</span> <span class="nav-text">安全配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Security初始化"><span class="nav-number">1.3.3.</span> <span class="nav-text">Spring Security初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#默认根路径请求"><span class="nav-number">1.3.4.</span> <span class="nav-text">默认根路径请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#认证成功页面"><span class="nav-number">1.3.5.</span> <span class="nav-text">认证成功页面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试"><span class="nav-number">1.3.6.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#授权"><span class="nav-number">1.4.</span> <span class="nav-text">授权</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">1.5.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Security-应用详解"><span class="nav-number">2.</span> <span class="nav-text">Spring Security 应用详解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#集成SpringBoot"><span class="nav-number">2.1.</span> <span class="nav-text">集成SpringBoot</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Boot-介绍"><span class="nav-number">2.1.1.</span> <span class="nav-text">Spring Boot 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建maven工程-1"><span class="nav-number">2.1.2.</span> <span class="nav-text">创建maven工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spring-容器配置"><span class="nav-number">2.1.3.</span> <span class="nav-text">spring 容器配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Servlet-Context配置-1"><span class="nav-number">2.1.4.</span> <span class="nav-text">Servlet Context配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安全配置-1"><span class="nav-number">2.1.5.</span> <span class="nav-text">安全配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试-1"><span class="nav-number">2.1.6.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#工作原理"><span class="nav-number">2.2.</span> <span class="nav-text">工作原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#结构总览"><span class="nav-number">2.2.1.</span> <span class="nav-text">结构总览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#认证流程"><span class="nav-number">2.2.2.</span> <span class="nav-text">认证流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#认证流程-1"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">认证流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AuthenticationProvider"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">AuthenticationProvider</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UserDetailsService"><span class="nav-number">2.2.2.3.</span> <span class="nav-text">UserDetailsService</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PasswordEncoder"><span class="nav-number">2.2.2.4.</span> <span class="nav-text">PasswordEncoder</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#授权流程"><span class="nav-number">2.2.3.</span> <span class="nav-text">授权流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#授权流程-1"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">授权流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#授权决策"><span class="nav-number">2.2.3.2.</span> <span class="nav-text">授权决策</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自定义认证"><span class="nav-number">2.3.</span> <span class="nav-text">自定义认证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义登录页面"><span class="nav-number">2.3.1.</span> <span class="nav-text">自定义登录页面</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#认证页面-1"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">认证页面</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置认证页面"><span class="nav-number">2.3.1.2.</span> <span class="nav-text">配置认证页面</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安全配置-2"><span class="nav-number">2.3.1.3.</span> <span class="nav-text">安全配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试-2"><span class="nav-number">2.3.1.4.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#连接数据库认证"><span class="nav-number">2.3.2.</span> <span class="nav-text">连接数据库认证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建数据库"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">创建数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#代码实现"><span class="nav-number">2.3.2.2.</span> <span class="nav-text">代码实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义UserDetailService"><span class="nav-number">2.3.2.3.</span> <span class="nav-text">定义UserDetailService</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试-3"><span class="nav-number">2.3.2.4.</span> <span class="nav-text">测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用BCryptPasswordEncoder"><span class="nav-number">2.3.2.5.</span> <span class="nav-text">使用BCryptPasswordEncoder</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#会话"><span class="nav-number">2.4.</span> <span class="nav-text">会话</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#获取用户身份"><span class="nav-number">2.4.1.</span> <span class="nav-text">获取用户身份</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#会话控制"><span class="nav-number">2.4.2.</span> <span class="nav-text">会话控制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#授权-1"><span class="nav-number">2.5.</span> <span class="nav-text">授权</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概述"><span class="nav-number">2.5.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备环境"><span class="nav-number">2.5.2.</span> <span class="nav-text">准备环境</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#数据库环境"><span class="nav-number">2.5.2.1.</span> <span class="nav-text">数据库环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改UserDetailService"><span class="nav-number">2.5.2.2.</span> <span class="nav-text">修改UserDetailService</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#web授权"><span class="nav-number">2.5.3.</span> <span class="nav-text">web授权</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法授权"><span class="nav-number">2.5.4.</span> <span class="nav-text">方法授权</span></a></li></ol></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">Copyright&copy; <span itemprop="copyrightYear">2018-2021</span> <span class="with-love" id="heart"><i class="fa fa-heart" style="color:#ff71a8"></i> </span><span class="author" itemprop="copyrightHolder">HuiProgramer</span></div><div><span id="days"></span> <span class="my-face">ღゝ◡╹)ノ♡</span></div><div><span id="busuanzi_container_site_pv" style="display:inline-block">总访问量： <span id="busuanzi_value_site_pv"></span> 次 <span class="post-meta-divider">|</span> </span><span id="busuanzi_container_site_uv" style="display:inline-block">访问人数：<span id="busuanzi_value_site_uv"></span> 人 <span class="post-meta-divider">|</span></span><div class="theme-info"><span class="post-count">字数统计：236.3k 字</span></div></div><div><span id="cnzz_stat_icon_1277385852"></span><script src="https://s23.cnzz.com/z_stat.php?id=1277385852&amp;online=1&amp;show=line" type="text/javascript"></script><script src="https://c.cnzz.com/core.php?web_id=1277385852&amp;show=line&amp;online=1&amp;t=z" charset="utf-8" type="text/javascript"></script></div><script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("11/25/2018 08:18:26"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="本站已勉强运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;w<0&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("TCcAB5wC7Rjx4Xe9aFUYiMUU-gzGzoHsz","pC764tcMRXbraCg5anMgT3QF")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){var t=".leancloud-visitors-count";if(0===e.length)return void o.find(t).text(0);for(var i=0;i<e.length;i++){var r=e[i],s=r.get("url"),l=r.get("time"),c=document.getElementById(s);$(c).find(t).text(l)}for(var i=0;i<n.length;i++){var s=n[i],c=document.getElementById(s),u=$(c).find(t);""==u.text()&&u.text(0)}}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var r=new e,s=new AV.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!0),r.setACL(s),r.set("title",o),r.set("url",n),r.set("time",1),r.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><style>#wenkmTips{position:fixed;font-size:1.4em;text-shadow:none;border-radius:0 5px 5px 0;z-index:5000;top:10px;left:0;background-color:rgba(13,159,203,.6);padding:15px;color:#fff;-webkit-transition:.5s;-moz-transition:.5s;-ms-transition:.5s;transition:.5s;-webkit-transform:translate3d(-100%,0,0);-moz-transform:translate3d(-100%,0,0);-ms-transform:translate3d(-100%,0,0);transform:translate3d(-100%,0,0)}#wenkmTips.show{-webkit-transform:translate3d(0,0,0);-moz-transform:translate3d(0,0,0);-ms-transform:translate3d(0,0,0);transform:translate3d(0,0,0)}.backtop{position:absolute;top:50%;z-index:3;clear:both;display:none;margin-top:-50px;margin-left:0;idth:68px;height:100px;background:url(https://huiprogramer.gitee.io/images/backtop.png)}</style><script type="text/javascript">function lanye_popup_box(){$("#lanye_popup_bg").fadeIn(800),$("#lanye_popup_bg").after("<div class=lanye_popup_box><h2><strong>支付宝扫码领红包</strong><span class=lanye_popup_closebox onclick=lanye_popup_closebox();></span></h2><div class=lanye_popup_boxcont><div style = 'padding:0px 12px 0px 12px;'>打开支付宝扫描二维码领取红包或者在支付宝首页输入<font color=red>1347239</font>搜索领取红包，每天可领取一次哦。</div><p style=padding-top:5px;padding-bottom:5px;text-align:center><img referrerpolicy='no-referrer' style=width:260px;height:auto; src=https://ws4.sinaimg.cn/large/006MOU0zgy1g23dhnc12bj30fs0nojtf.jpg /></p></div></div>"),$(".hb_box").fadeIn()}function lanye_popup_closebox(){$(".lanye_popup_box").remove(),$("#lanye_popup_bg").fadeOut(800)}$(document).ready(function(){$(".lanye_popup_close").click(function(){$(".lanye_popup_box").fadeOut()}),$(".lanye_popup_closetop").click(function(){$(".lanye_popup_top").remove()})}),$("meta[name='generator']").prop("content","在线生成").prop("name","在线分享网"),$(function(){setTimeout(function(){$("#cnzz_stat_icon_1277040022 a").css("border-bottom","none"),$("#cnzz_stat_icon_1277040022 a").css("color","#999")},1e3)})</script><script id="cy_cmt_num" async src="https://changyan.sohu.com/upload/plugins/plugins.list.count.js?clientId=cyu7tijsf"></script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script async type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script async type="text/javascript" src="/js/src/fireworks.js"></script></body></html><!-- rebuild by neat -->