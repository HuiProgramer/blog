<!-- build time:Tue Oct 13 2020 21:46:49 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><script>!function(){var t,e="在线分享网";document.addEventListener("visibilitychange",function(){document.hidden?(document.title="您去哪里了！",clearTimeout(t)):(document.title="在线分享网欢迎您",t=setTimeout(function(){document.title=e},2e3))})}()</script><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script></script><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/icon.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/icon.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/icon.png?v=5.1.4"><link rel="mask-icon" href="/icon.png?v=5.1.4" color="#222"><meta name="keywords" content="中间件,RocketMQ,"><link rel="alternate" href="/atom.xml" title="在线分享网" type="application/atom+xml"><meta name="description" content="MQ介绍为什么要用MQ消息队列是一种“先进先出”的数据结构其应用场景主要包含以下3个方面应用解耦系统的耦合性越高，容错性就越低。以电商应用为例，用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障或者因为升级等原因暂时不可用，都会造成下单操作异常，影响用户使用体验。使用消息队列解耦合，系统的耦合性就会提高了。比如物流系统发生故障，需要几分钟才能来修复，在这段时间内，物流"><meta name="keywords" content="中间件,RocketMQ"><meta property="og:type" content="article"><meta property="og:title" content="初探RocketMQ"><meta property="og:url" content="https://me.obey.fun/初探RocketMQ.html"><meta property="og:site_name" content="在线分享网"><meta property="og:description" content="MQ介绍为什么要用MQ消息队列是一种“先进先出”的数据结构其应用场景主要包含以下3个方面应用解耦系统的耦合性越高，容错性就越低。以电商应用为例，用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障或者因为升级等原因暂时不可用，都会造成下单操作异常，影响用户使用体验。使用消息队列解耦合，系统的耦合性就会提高了。比如物流系统发生故障，需要几分钟才能来修复，在这段时间内，物流"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://tvax2.sinaimg.cn/large/006MOU0zgy1gjnu2lpt7oj30rs05jdgt.jpg"><meta property="og:image" content="https://tva3.sinaimg.cn/large/006MOU0zgy1gjnu3kzn1tj309e07adfu.jpg"><meta property="og:image" content="https://tva3.sinaimg.cn/large/006MOU0zgy1gjnu41r6jxj30f807at8s.jpg"><meta property="og:image" content="https://tva3.sinaimg.cn/large/006MOU0zgy1gjnumfqsn0j30av0b1wef.jpg"><meta property="og:image" content="https://tvax3.sinaimg.cn/large/006MOU0zgy1gjnumfldwoj30cb0atjrk.jpg"><meta property="og:image" content="https://tva2.sinaimg.cn/large/006MOU0zgy1gjnuq6lj8fj30jd0akgly.jpg"><meta property="og:image" content="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjnuq6fot0j30ii0bq74s.jpg"><meta property="og:image" content="https://tvax3.sinaimg.cn/large/006MOU0zgy1gjnurod1asj31bg0z60y9.jpg"><meta property="og:image" content="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjnussbkdlj30x90jgdil.jpg"><meta property="og:image" content="https://tva4.sinaimg.cn/large/006MOU0zgy1gjnutiqorxj30xs0fvwfv.jpg"><meta property="og:image" content="https://tva1.sinaimg.cn/large/006MOU0zgy1gjnuvutkp2j30w2032jra.jpg"><meta property="og:image" content="https://tva3.sinaimg.cn/large/006MOU0zgy1gjnxxodknrj30cp0mj0ti.jpg"><meta property="og:image" content="https://tvax3.sinaimg.cn/large/006MOU0zgy1gjnxylgieaj31gk11rtbw.jpg"><meta property="og:image" content="https://tvax1.sinaimg.cn/large/006MOU0zgy1gjnxyjngmkj31hc0cewfi.jpg"><meta property="og:image" content="https://tva2.sinaimg.cn/large/006MOU0zgy1gjnzi2do0vj30ry0d93z7.jpg"><meta property="og:updated_time" content="2020-06-15T02:21:32.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="初探RocketMQ"><meta name="twitter:description" content="MQ介绍为什么要用MQ消息队列是一种“先进先出”的数据结构其应用场景主要包含以下3个方面应用解耦系统的耦合性越高，容错性就越低。以电商应用为例，用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障或者因为升级等原因暂时不可用，都会造成下单操作异常，影响用户使用体验。使用消息队列解耦合，系统的耦合性就会提高了。比如物流系统发生故障，需要几分钟才能来修复，在这段时间内，物流"><meta name="twitter:image" content="https://tvax2.sinaimg.cn/large/006MOU0zgy1gjnu2lpt7oj30rs05jdgt.jpg"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!0,scrollpercent:!0,onmobile:!0},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement(o),n=t.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"2931888f"}),daovoice("update")</script><link rel="canonical" href="https://me.obey.fun/初探RocketMQ.html"><title>初探RocketMQ | 在线分享网</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div id="particles-js"></div><div class="container sidebar-position-left page-post-detail"><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">在线分享网</span> <span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">分享，成为你我之间的快乐！</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档 <span class="badge">47</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签 <span class="badge">33</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类 <span class="badge">29</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-message"><a href="/message/" rel="section"><i class="menu-item-icon fa fa-fw fa-comments"></i><br>留言板</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="menu-item-icon fa fa-fw fa-address-book-o"></i><br>友情链接</a></li><li class="menu-item menu-item-share"><a href="https://www.52share.online" rel="section"><i class="menu-item-icon fa fa-fw fa-hand-o-right"></i><br>资源分享</a></li><li class="menu-item menu-item-topx"><a href="/topx/" rel="section"><i class="menu-item-icon fa fa-fw fa-line-chart"></i><br>热度排序</a></li><li id="search" class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><div id="lanye_popup_bg" onclick="lanye_popup_closebox()" style="display:none"></div><div class="lanye_popup_top"><a style="border-bottom:0" href="javascript:lanye_popup_box();" target="_blank" rel="external nofollow"></a><div class="lanye_popup_closetop"></div></div><script async src="/js/src/ribbon.js" type="text/javascript"></script><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://me.obey.fun/初探RocketMQ.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="HuiProgramer"><meta itemprop="description" content=""><meta itemprop="image" content="https://huiprogramer.gitee.io/medias/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="在线分享网"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">初探RocketMQ</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-13T20:37:29+08:00">2020-06-13 </time><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于&#58;</span> <time title="更新于" itemprop="dateModified" datetime="2020-06-15T10:21:32+08:00">2020-06-15 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MessageQueue/" itemprop="url" rel="index"><span itemprop="name">MessageQueue</span> </a></span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/MessageQueue/RocketMQ/" itemprop="url" rel="index"><span itemprop="name">RocketMQ</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span>评论: <span id="sourceId::初探RocketMQ" class="cy_cmt_count"></span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">14.4k 字 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">58 分钟 </span><span id="/初探RocketMQ.html" class="leancloud_visitors" data-flag-title="初探RocketMQ"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-thermometer-1"></i> </span><span class="post-meta-item-text">热度&#58;</span> <span class="leancloud-visitors-count"></span> <span>℃</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="MQ介绍"><a href="#MQ介绍" class="headerlink" title="MQ介绍"></a>MQ介绍</h1><h2 id="为什么要用MQ"><a href="#为什么要用MQ" class="headerlink" title="为什么要用MQ"></a>为什么要用MQ</h2><p>消息队列是一种“先进先出”的数据结构<br><img src="https://tvax2.sinaimg.cn/large/006MOU0zgy1gjnu2lpt7oj30rs05jdgt.jpg" referrerpolicy="no-referrer"></p><p>其应用场景主要包含以下3个方面</p><ul><li>应用解耦</li></ul><p>系统的耦合性越高，容错性就越低。以电商应用为例，用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障或者因为升级等原因暂时不可用，都会造成下单操作异常，影响用户使用体验。</p><p><img src="https://tva3.sinaimg.cn/large/006MOU0zgy1gjnu3kzn1tj309e07adfu.jpg" referrerpolicy="no-referrer"></p><p>使用消息队列解耦合，系统的耦合性就会提高了。比如物流系统发生故障，需要几分钟才能来修复，在这段时间内，物流系统要处理的数据被缓存到消息队列中，用户的下单操作正常完成。当物流系统回复后，补充处理存在消息队列中的订单消息即可，终端系统感知不到物流系统发生过几分钟故障。</p><p><img src="https://tva3.sinaimg.cn/large/006MOU0zgy1gjnu41r6jxj30f807at8s.jpg" referrerpolicy="no-referrer"></p><ul><li>流量削峰</li></ul><p><img src="https://tva3.sinaimg.cn/large/006MOU0zgy1gjnumfqsn0j30av0b1wef.jpg" referrerpolicy="no-referrer"></p><p>应用系统如果遇到系统请求流量的瞬间猛增，有可能会将系统压垮。有了消息队列可以将大量请求缓存起来，分散到很长一段时间处理，这样可以大大提到系统的稳定性和用户体验。<br><img src="https://tvax3.sinaimg.cn/large/006MOU0zgy1gjnumfldwoj30cb0atjrk.jpg" referrerpolicy="no-referrer"></p><p>一般情况，为了保证系统的稳定性，如果系统负载超过阈值，就会阻止用户请求，这会影响用户体验，而如果使用消息队列将请求缓存起来，等待系统处理完毕后通知用户下单完毕，这样总不能下单体验要好。</p><p><u>处于经济考量目的：</u></p><p>业务系统正常时段的QPS如果是1000，流量最高峰是10000，为了应对流量高峰配置高性能的服务器显然不划算，这时可以使用消息队列对峰值流量削峰</p><ul><li>数据分发<br><img src="https://tva2.sinaimg.cn/large/006MOU0zgy1gjnuq6lj8fj30jd0akgly.jpg" referrerpolicy="no-referrer"></li></ul><p>通过消息队列可以让数据在多个系统更加之间进行流通。数据的产生方不需要关心谁来使用数据，只需要将数据发送到消息队列，数据使用方直接在消息队列中直接获取数据即可<br><img src="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjnuq6fot0j30ii0bq74s.jpg" referrerpolicy="no-referrer"></p><h2 id="MQ的优点和缺点"><a href="#MQ的优点和缺点" class="headerlink" title="MQ的优点和缺点"></a>MQ的优点和缺点</h2><p>优点：解耦、削峰、数据分发</p><p>缺点包含以下几点：</p><ul><li><p>系统可用性降低</p><p>系统引入的外部依赖越多，系统稳定性越差。一旦MQ宕机，就会对业务造成影响。</p><p>如何保证MQ的高可用？</p></li><li><p>系统复杂度提高</p><p>MQ的加入大大增加了系统的复杂度，以前系统间是同步的远程调用，现在是通过MQ进行异步调用。</p><p>如何保证消息没有被重复消费？怎么处理消息丢失情况？那么保证消息传递的顺序性？</p></li><li><p>一致性问题</p><p>A系统处理完业务，通过MQ给B、C、D三个系统发消息数据，如果B系统、C系统处理成功，D系统处理失败。</p><p>如何保证消息数据处理的一致性？</p></li></ul><h2 id="各种MQ产品的比较"><a href="#各种MQ产品的比较" class="headerlink" title="各种MQ产品的比较"></a>各种MQ产品的比较</h2><p>常见的MQ产品包括Kafka、ActiveMQ、RabbitMQ、RocketMQ。<br><img src="https://tvax3.sinaimg.cn/large/006MOU0zgy1gjnurod1asj31bg0z60y9.jpg" referrerpolicy="no-referrer"></p><h1 id="RocketMQ快速入门"><a href="#RocketMQ快速入门" class="headerlink" title="RocketMQ快速入门"></a>RocketMQ快速入门</h1><p>RocketMQ是阿里巴巴2016年MQ中间件，使用Java语言开发，在阿里内部，RocketMQ承接了例如“双11”等高并发场景的消息流转，能够处理万亿级别的消息。</p><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="下载RocketMQ"><a href="#下载RocketMQ" class="headerlink" title="下载RocketMQ"></a>下载RocketMQ</h3><p>RocketMQ最新版本：4.5.1</p><p><a href="https://www.apache.org/dyn/closer.cgi?path=rocketmq/4.5.1/rocketmq-all-4.5.1-bin-release.zip" target="_blank" rel="noopener">下载地址</a></p><h3 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h3><ul><li><p>Linux64位系统</p></li><li><p>JDK1.8(64位)</p></li><li><p>源码安装需要安装Maven 3.2.x</p></li></ul><h2 id="安装RocketMQ"><a href="#安装RocketMQ" class="headerlink" title="安装RocketMQ"></a>安装RocketMQ</h2><h3 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h3><p>本教程以二进制包方式安装</p><ol><li>解压安装包</li><li>进入安装目录</li></ol><h3 id="目录介绍"><a href="#目录介绍" class="headerlink" title="目录介绍"></a>目录介绍</h3><ul><li>bin：启动脚本，包括shell脚本和CMD脚本</li><li>conf：实例配置文件 ，包括broker配置文件、logback配置文件等</li><li>lib：依赖jar包，包括Netty、commons-lang、FastJSON等</li></ul><h2 id="启动RocketMQ"><a href="#启动RocketMQ" class="headerlink" title="启动RocketMQ"></a>启动RocketMQ</h2><ol><li>启动NameServer</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 1.启动NameServer</span><br><span class="line">nohup sh bin/mqnamesrv &amp;</span><br><span class="line"><span class="meta">#</span> 2.查看启动日志</span><br><span class="line">tail -f ~/logs/rocketmqlogs/namesrv.log</span><br></pre></td></tr></table></figure><ol start="2"><li>启动Broker</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 1.启动Broker</span><br><span class="line">nohup sh bin/mqbroker -n localhost:9876 &amp;</span><br><span class="line"><span class="meta">#</span> 2.查看启动日志</span><br><span class="line">tail -f ~/logs/rocketmqlogs/broker.log</span><br></pre></td></tr></table></figure><ul><li><p>问题描述：</p><p>RocketMQ默认的虚拟机内存较大，启动Broker如果因为内存不足失败，需要编辑如下两个配置文件，修改JVM内存大小</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 编辑runbroker.sh和runserver.sh修改默认JVM大小</span><br><span class="line">vi runbroker.sh</span><br><span class="line">vi runserver.sh</span><br></pre></td></tr></table></figure><ul><li>参考设置：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 测试RocketMQ</span><br><span class="line"></span><br><span class="line">### 发送消息</span><br><span class="line"></span><br><span class="line">```sh</span><br><span class="line"># 1.设置环境变量</span><br><span class="line">export NAMESRV_ADDR=localhost:9876</span><br><span class="line"># 2.使用安装包的Demo发送消息</span><br><span class="line">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br></pre></td></tr></table></figure><h3 id="接收消息"><a href="#接收消息" class="headerlink" title="接收消息"></a>接收消息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 1.设置环境变量</span><br><span class="line">export NAMESRV_ADDR=localhost:9876</span><br><span class="line"><span class="meta">#</span> 2.接收消息</span><br><span class="line">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer</span><br></pre></td></tr></table></figure><h2 id="关闭RocketMQ"><a href="#关闭RocketMQ" class="headerlink" title="关闭RocketMQ"></a>关闭RocketMQ</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 1.关闭NameServer</span><br><span class="line">sh bin/mqshutdown namesrv</span><br><span class="line"><span class="meta">#</span> 2.关闭Broker</span><br><span class="line">sh bin/mqshutdown broker</span><br></pre></td></tr></table></figure><h1 id="RocketMQ集群搭建"><a href="#RocketMQ集群搭建" class="headerlink" title="RocketMQ集群搭建"></a>RocketMQ集群搭建</h1><h2 id="各角色介绍"><a href="#各角色介绍" class="headerlink" title="各角色介绍"></a>各角色介绍</h2><ul><li>Producer：消息的发送者；举例：发信者</li><li>Consumer：消息接收者；举例：收信者</li><li>Broker：暂存和传输消息；举例：邮局</li><li>NameServer：管理Broker；举例：各个邮局的管理机构</li><li>Topic：区分消息的种类；一个发送者可以发送消息给一个或者多个Topic；一个消息的接收者可以订阅一个或者多个Topic消息</li><li>Message Queue：相当于是Topic的分区；用于并行发送和接收消息</li></ul><p><img src="https://tvax4.sinaimg.cn/large/006MOU0zgy1gjnussbkdlj30x90jgdil.jpg" referrerpolicy="no-referrer"></p><h2 id="集群搭建方式"><a href="#集群搭建方式" class="headerlink" title="集群搭建方式"></a>集群搭建方式</h2><h3 id="集群特点"><a href="#集群特点" class="headerlink" title="集群特点"></a>集群特点</h3><ul><li><p>NameServer是一个几乎无状态节点，可集群部署，节点之间无任何信息同步。</p></li><li><p>Broker部署相对复杂，Broker分为Master与Slave，一个Master可以对应多个Slave，但是一个Slave只能对应一个Master，Master与Slave的对应关系通过指定相同的BrokerName，不同的BrokerId来定义，BrokerId为0表示Master，非0表示Slave。Master也可以部署多个。每个Broker与NameServer集群中的所有节点建立长连接，定时注册Topic信息到所有NameServer。</p></li><li>Producer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer取Topic路由信息，并向提供Topic服务的Master建立长连接，且定时向Master发送心跳。Producer完全无状态，可集群部署。</li><li>Consumer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer取Topic路由信息，并向提供Topic服务的Master、Slave建立长连接，且定时向Master、Slave发送心跳。Consumer既可以从Master订阅消息，也可以从Slave订阅消息，订阅规则由Broker配置决定。</li></ul><h3 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h3><h4 id="单Master模式"><a href="#单Master模式" class="headerlink" title="单Master模式"></a>单Master模式</h4><p>这种方式风险较大，一旦Broker重启或者宕机时，会导致整个服务不可用。不建议线上环境使用,可以用于本地测试。</p><h4 id="多Master模式"><a href="#多Master模式" class="headerlink" title="多Master模式"></a>多Master模式</h4><p>一个集群无Slave，全是Master，例如2个Master或者3个Master，这种模式的优缺点如下：</p><ul><li>优点：配置简单，单个Master宕机或重启维护对应用无影响，在磁盘配置为RAID10时，即使机器宕机不可恢复情况下，由于RAID10磁盘非常可靠，消息也不会丢（异步刷盘丢失少量消息，同步刷盘一条不丢），性能最高；</li><li>缺点：单台机器宕机期间，这台机器上未被消费的消息在机器恢复之前不可订阅，消息实时性会受到影响。</li></ul><h4 id="多Master多Slave模式（异步）"><a href="#多Master多Slave模式（异步）" class="headerlink" title="多Master多Slave模式（异步）"></a>多Master多Slave模式（异步）</h4><p>每个Master配置一个Slave，有多对Master-Slave，HA采用异步复制方式，主备有短暂消息延迟（毫秒级），这种模式的优缺点如下：</p><ul><li>优点：即使磁盘损坏，消息丢失的非常少，且消息实时性不会受影响，同时Master宕机后，消费者仍然可以从Slave消费，而且此过程对应用透明，不需要人工干预，性能同多Master模式几乎一样；</li><li>缺点：Master宕机，磁盘损坏情况下会丢失少量消息。</li></ul><h4 id="多Master多Slave模式（同步）"><a href="#多Master多Slave模式（同步）" class="headerlink" title="多Master多Slave模式（同步）"></a>多Master多Slave模式（同步）</h4><p>每个Master配置一个Slave，有多对Master-Slave，HA采用同步双写方式，即只有主备都写成功，才向应用返回成功，这种模式的优缺点如下：</p><ul><li>优点：数据与服务都无单点故障，Master宕机情况下，消息无延迟，服务可用性与数据可用性都非常高；</li><li>缺点：性能比异步复制模式略低（大约低10%左右），发送单个消息的RT会略高，且目前版本在主节点宕机后，备机不能自动切换为主机。</li></ul><h2 id="双主双从集群搭建"><a href="#双主双从集群搭建" class="headerlink" title="双主双从集群搭建"></a>双主双从集群搭建</h2><h3 id="总体架构"><a href="#总体架构" class="headerlink" title="总体架构"></a>总体架构</h3><p>消息高可用采用2m-2s（同步双写）方式<br><img src="https://tva4.sinaimg.cn/large/006MOU0zgy1gjnutiqorxj30xs0fvwfv.jpg" referrerpolicy="no-referrer"></p><h3 id="集群工作流程"><a href="#集群工作流程" class="headerlink" title="集群工作流程"></a>集群工作流程</h3><ol><li>启动NameServer，NameServer起来后监听端口，等待Broker、Producer、Consumer连上来，相当于一个路由控制中心。</li><li>Broker启动，跟所有的NameServer保持长连接，定时发送心跳包。心跳包中包含当前Broker信息(IP+端口等)以及存储所有Topic信息。注册成功后，NameServer集群中就有Topic跟Broker的映射关系。</li><li>收发消息前，先创建Topic，创建Topic时需要指定该Topic要存储在哪些Broker上，也可以在发送消息时自动创建Topic。</li><li>Producer发送消息，启动时先跟NameServer集群中的其中一台建立长连接，并从NameServer中获取当前发送的Topic存在哪些Broker上，轮询从队列列表中选择一个队列，然后与队列所在的Broker建立长连接从而向Broker发消息。</li><li>Consumer跟Producer类似，跟其中一台NameServer建立长连接，获取当前订阅Topic存在哪些Broker上，然后直接跟Broker建立连接通道，开始消费消息。</li></ol><h3 id="服务器环境"><a href="#服务器环境" class="headerlink" title="服务器环境"></a>服务器环境</h3><table><thead><tr><th><strong>序号</strong></th><th><strong>IP</strong></th><th><strong>角色</strong></th><th><strong>架构模式</strong></th></tr></thead><tbody><tr><td>1</td><td>192.168.25.135</td><td>nameserver、brokerserver</td><td>Master1、Slave2</td></tr><tr><td>2</td><td>192.168.25.138</td><td>nameserver、brokerserver</td><td>Master2、Slave1</td></tr></tbody></table><h3 id="Host添加信息"><a href="#Host添加信息" class="headerlink" title="Host添加信息"></a>Host添加信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br></pre></td></tr></table></figure><p>配置如下:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nameserver</span></span><br><span class="line">192.168.25.135 rocketmq-nameserver1</span><br><span class="line">192.168.25.138 rocketmq-nameserver2</span><br><span class="line"><span class="comment"># broker</span></span><br><span class="line">192.168.25.135 rocketmq-master1</span><br><span class="line">192.168.25.135 rocketmq-slave2</span><br><span class="line">192.168.25.138 rocketmq-master2</span><br><span class="line">192.168.25.138 rocketmq-slave1</span><br></pre></td></tr></table></figure><p>配置完成后, 重启网卡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure><h3 id="防火墙配置"><a href="#防火墙配置" class="headerlink" title="防火墙配置"></a>防火墙配置</h3><p>宿主机需要远程访问虚拟机的rocketmq服务和web服务，需要开放相关的端口号，简单粗暴的方式是直接关闭防火墙</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭防火墙</span></span><br><span class="line">systemctl stop firewalld.service </span><br><span class="line"><span class="comment"># 查看防火墙的状态</span></span><br><span class="line">firewall-cmd --state </span><br><span class="line"><span class="comment"># 禁止firewall开机启动</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br></pre></td></tr></table></figure><p>或者为了安全，只开放特定的端口号，RocketMQ默认使用3个端口：9876 、10911 、11011 。如果防火墙没有关闭的话，那么防火墙就必须开放这些端口：</p><ul><li><code>nameserver</code> 默认使用 9876 端口</li><li><code>master</code> 默认使用 10911 端口</li><li><code>slave</code> 默认使用11011 端口</li></ul><p>执行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开放name server默认端口</span></span><br><span class="line">firewall-cmd --remove-port=9876/tcp --permanent</span><br><span class="line"><span class="comment"># 开放master默认端口</span></span><br><span class="line">firewall-cmd --remove-port=10911/tcp --permanent</span><br><span class="line"><span class="comment"># 开放slave默认端口 (当前集群模式可不开启)</span></span><br><span class="line">firewall-cmd --remove-port=11011/tcp --permanent </span><br><span class="line"><span class="comment"># 重启防火墙</span></span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><h3 id="环境变量配置"><a href="#环境变量配置" class="headerlink" title="环境变量配置"></a>环境变量配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure><p>在profile文件的末尾加入如下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#set rocketmq</span></span><br><span class="line">ROCKETMQ_HOME=/usr/<span class="built_in">local</span>/rocketmq/rocketmq-all-4.4.0-bin-release</span><br><span class="line">PATH=<span class="variable">$PATH</span>:<span class="variable">$ROCKETMQ_HOME</span>/bin</span><br><span class="line"><span class="built_in">export</span> ROCKETMQ_HOME PATH</span><br></pre></td></tr></table></figure><p>输入:wq! 保存并退出， 并使得配置立刻生效：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><h3 id="创建消息存储路径"><a href="#创建消息存储路径" class="headerlink" title="创建消息存储路径"></a>创建消息存储路径</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/<span class="built_in">local</span>/rocketmq/store</span><br><span class="line">mkdir /usr/<span class="built_in">local</span>/rocketmq/store/commitlog</span><br><span class="line">mkdir /usr/<span class="built_in">local</span>/rocketmq/store/consumequeue</span><br><span class="line">mkdir /usr/<span class="built_in">local</span>/rocketmq/store/index</span><br></pre></td></tr></table></figure><h3 id="broker配置文件"><a href="#broker配置文件" class="headerlink" title="broker配置文件"></a>broker配置文件</h3><h4 id="master1"><a href="#master1" class="headerlink" title="master1"></a>master1</h4><p>服务器：192.168.25.135</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/soft/rocketmq/conf/2m-2s-sync/broker-a.properties</span><br></pre></td></tr></table></figure><p>修改配置如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所属集群名字</span></span><br><span class="line">brokerClusterName=rocketmq-cluster</span><br><span class="line"><span class="comment">#broker名字，注意此处不同的配置文件填写的不一样</span></span><br><span class="line">brokerName=broker<span class="_">-a</span></span><br><span class="line"><span class="comment">#0 表示 Master，&gt;0 表示 Slave</span></span><br><span class="line">brokerId=0</span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line">namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span><br><span class="line"><span class="comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span></span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line">listenPort=10911</span><br><span class="line"><span class="comment">#删除文件时间点，默认凌晨 4点</span></span><br><span class="line">deleteWhen=04</span><br><span class="line"><span class="comment">#文件保留时间，默认 48 小时</span></span><br><span class="line">fileReservedTime=120</span><br><span class="line"><span class="comment">#commitLog每个文件的大小默认1G</span></span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line"><span class="comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span></span><br><span class="line">mapedFileSizeConsumeQueue=300000</span><br><span class="line"><span class="comment">#destroyMapedFileIntervalForcibly=120000</span></span><br><span class="line"><span class="comment">#redeleteHangedFileInterval=120000</span></span><br><span class="line"><span class="comment">#检测物理文件磁盘空间</span></span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line">storePathRootDir=/usr/<span class="built_in">local</span>/rocketmq/store</span><br><span class="line"><span class="comment">#commitLog 存储路径</span></span><br><span class="line">storePathCommitLog=/usr/<span class="built_in">local</span>/rocketmq/store/commitlog</span><br><span class="line"><span class="comment">#消费队列存储路径存储路径</span></span><br><span class="line">storePathConsumeQueue=/usr/<span class="built_in">local</span>/rocketmq/store/consumequeue</span><br><span class="line"><span class="comment">#消息索引存储路径</span></span><br><span class="line">storePathIndex=/usr/<span class="built_in">local</span>/rocketmq/store/index</span><br><span class="line"><span class="comment">#checkpoint 文件存储路径</span></span><br><span class="line">storeCheckpoint=/usr/<span class="built_in">local</span>/rocketmq/store/checkpoint</span><br><span class="line"><span class="comment">#abort 文件存储路径</span></span><br><span class="line">abortFile=/usr/<span class="built_in">local</span>/rocketmq/store/abort</span><br><span class="line"><span class="comment">#限制的消息大小</span></span><br><span class="line">maxMessageSize=65536</span><br><span class="line"><span class="comment">#flushCommitLogLeastPages=4</span></span><br><span class="line"><span class="comment">#flushConsumeQueueLeastPages=2</span></span><br><span class="line"><span class="comment">#flushCommitLogThoroughInterval=10000</span></span><br><span class="line"><span class="comment">#flushConsumeQueueThoroughInterval=60000</span></span><br><span class="line"><span class="comment">#Broker 的角色</span></span><br><span class="line"><span class="comment">#- ASYNC_MASTER 异步复制Master</span></span><br><span class="line"><span class="comment">#- SYNC_MASTER 同步双写Master</span></span><br><span class="line"><span class="comment">#- SLAVE</span></span><br><span class="line">brokerRole=SYNC_MASTER</span><br><span class="line"><span class="comment">#刷盘方式</span></span><br><span class="line"><span class="comment">#- ASYNC_FLUSH 异步刷盘</span></span><br><span class="line"><span class="comment">#- SYNC_FLUSH 同步刷盘</span></span><br><span class="line">flushDiskType=SYNC_FLUSH</span><br><span class="line"><span class="comment">#checkTransactionMessageEnable=false</span></span><br><span class="line"><span class="comment">#发消息线程池数量</span></span><br><span class="line"><span class="comment">#sendMessageThreadPoolNums=128</span></span><br><span class="line"><span class="comment">#拉消息线程池数量</span></span><br><span class="line"><span class="comment">#pullMessageThreadPoolNums=128</span></span><br></pre></td></tr></table></figure><h4 id="slave2"><a href="#slave2" class="headerlink" title="slave2"></a>slave2</h4><p>服务器：192.168.25.135</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/soft/rocketmq/conf/2m-2s-sync/broker-b-s.properties</span><br></pre></td></tr></table></figure><p>修改配置如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所属集群名字</span></span><br><span class="line">brokerClusterName=rocketmq-cluster</span><br><span class="line"><span class="comment">#broker名字，注意此处不同的配置文件填写的不一样</span></span><br><span class="line">brokerName=broker-b</span><br><span class="line"><span class="comment">#0 表示 Master，&gt;0 表示 Slave</span></span><br><span class="line">brokerId=1</span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line">namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span><br><span class="line"><span class="comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span></span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line">listenPort=11011</span><br><span class="line"><span class="comment">#删除文件时间点，默认凌晨 4点</span></span><br><span class="line">deleteWhen=04</span><br><span class="line"><span class="comment">#文件保留时间，默认 48 小时</span></span><br><span class="line">fileReservedTime=120</span><br><span class="line"><span class="comment">#commitLog每个文件的大小默认1G</span></span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line"><span class="comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span></span><br><span class="line">mapedFileSizeConsumeQueue=300000</span><br><span class="line"><span class="comment">#destroyMapedFileIntervalForcibly=120000</span></span><br><span class="line"><span class="comment">#redeleteHangedFileInterval=120000</span></span><br><span class="line"><span class="comment">#检测物理文件磁盘空间</span></span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line">storePathRootDir=/usr/<span class="built_in">local</span>/rocketmq/store</span><br><span class="line"><span class="comment">#commitLog 存储路径</span></span><br><span class="line">storePathCommitLog=/usr/<span class="built_in">local</span>/rocketmq/store/commitlog</span><br><span class="line"><span class="comment">#消费队列存储路径存储路径</span></span><br><span class="line">storePathConsumeQueue=/usr/<span class="built_in">local</span>/rocketmq/store/consumequeue</span><br><span class="line"><span class="comment">#消息索引存储路径</span></span><br><span class="line">storePathIndex=/usr/<span class="built_in">local</span>/rocketmq/store/index</span><br><span class="line"><span class="comment">#checkpoint 文件存储路径</span></span><br><span class="line">storeCheckpoint=/usr/<span class="built_in">local</span>/rocketmq/store/checkpoint</span><br><span class="line"><span class="comment">#abort 文件存储路径</span></span><br><span class="line">abortFile=/usr/<span class="built_in">local</span>/rocketmq/store/abort</span><br><span class="line"><span class="comment">#限制的消息大小</span></span><br><span class="line">maxMessageSize=65536</span><br><span class="line"><span class="comment">#flushCommitLogLeastPages=4</span></span><br><span class="line"><span class="comment">#flushConsumeQueueLeastPages=2</span></span><br><span class="line"><span class="comment">#flushCommitLogThoroughInterval=10000</span></span><br><span class="line"><span class="comment">#flushConsumeQueueThoroughInterval=60000</span></span><br><span class="line"><span class="comment">#Broker 的角色</span></span><br><span class="line"><span class="comment">#- ASYNC_MASTER 异步复制Master</span></span><br><span class="line"><span class="comment">#- SYNC_MASTER 同步双写Master</span></span><br><span class="line"><span class="comment">#- SLAVE</span></span><br><span class="line">brokerRole=SLAVE</span><br><span class="line"><span class="comment">#刷盘方式</span></span><br><span class="line"><span class="comment">#- ASYNC_FLUSH 异步刷盘</span></span><br><span class="line"><span class="comment">#- SYNC_FLUSH 同步刷盘</span></span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br><span class="line"><span class="comment">#checkTransactionMessageEnable=false</span></span><br><span class="line"><span class="comment">#发消息线程池数量</span></span><br><span class="line"><span class="comment">#sendMessageThreadPoolNums=128</span></span><br><span class="line"><span class="comment">#拉消息线程池数量</span></span><br><span class="line"><span class="comment">#pullMessageThreadPoolNums=128</span></span><br></pre></td></tr></table></figure><h4 id="master2"><a href="#master2" class="headerlink" title="master2"></a>master2</h4><p>服务器：192.168.25.138</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/soft/rocketmq/conf/2m-2s-sync/broker-b.properties</span><br></pre></td></tr></table></figure><p>修改配置如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所属集群名字</span></span><br><span class="line">brokerClusterName=rocketmq-cluster</span><br><span class="line"><span class="comment">#broker名字，注意此处不同的配置文件填写的不一样</span></span><br><span class="line">brokerName=broker-b</span><br><span class="line"><span class="comment">#0 表示 Master，&gt;0 表示 Slave</span></span><br><span class="line">brokerId=0</span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line">namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span><br><span class="line"><span class="comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span></span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line">listenPort=10911</span><br><span class="line"><span class="comment">#删除文件时间点，默认凌晨 4点</span></span><br><span class="line">deleteWhen=04</span><br><span class="line"><span class="comment">#文件保留时间，默认 48 小时</span></span><br><span class="line">fileReservedTime=120</span><br><span class="line"><span class="comment">#commitLog每个文件的大小默认1G</span></span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line"><span class="comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span></span><br><span class="line">mapedFileSizeConsumeQueue=300000</span><br><span class="line"><span class="comment">#destroyMapedFileIntervalForcibly=120000</span></span><br><span class="line"><span class="comment">#redeleteHangedFileInterval=120000</span></span><br><span class="line"><span class="comment">#检测物理文件磁盘空间</span></span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line">storePathRootDir=/usr/<span class="built_in">local</span>/rocketmq/store</span><br><span class="line"><span class="comment">#commitLog 存储路径</span></span><br><span class="line">storePathCommitLog=/usr/<span class="built_in">local</span>/rocketmq/store/commitlog</span><br><span class="line"><span class="comment">#消费队列存储路径存储路径</span></span><br><span class="line">storePathConsumeQueue=/usr/<span class="built_in">local</span>/rocketmq/store/consumequeue</span><br><span class="line"><span class="comment">#消息索引存储路径</span></span><br><span class="line">storePathIndex=/usr/<span class="built_in">local</span>/rocketmq/store/index</span><br><span class="line"><span class="comment">#checkpoint 文件存储路径</span></span><br><span class="line">storeCheckpoint=/usr/<span class="built_in">local</span>/rocketmq/store/checkpoint</span><br><span class="line"><span class="comment">#abort 文件存储路径</span></span><br><span class="line">abortFile=/usr/<span class="built_in">local</span>/rocketmq/store/abort</span><br><span class="line"><span class="comment">#限制的消息大小</span></span><br><span class="line">maxMessageSize=65536</span><br><span class="line"><span class="comment">#flushCommitLogLeastPages=4</span></span><br><span class="line"><span class="comment">#flushConsumeQueueLeastPages=2</span></span><br><span class="line"><span class="comment">#flushCommitLogThoroughInterval=10000</span></span><br><span class="line"><span class="comment">#flushConsumeQueueThoroughInterval=60000</span></span><br><span class="line"><span class="comment">#Broker 的角色</span></span><br><span class="line"><span class="comment">#- ASYNC_MASTER 异步复制Master</span></span><br><span class="line"><span class="comment">#- SYNC_MASTER 同步双写Master</span></span><br><span class="line"><span class="comment">#- SLAVE</span></span><br><span class="line">brokerRole=SYNC_MASTER</span><br><span class="line"><span class="comment">#刷盘方式</span></span><br><span class="line"><span class="comment">#- ASYNC_FLUSH 异步刷盘</span></span><br><span class="line"><span class="comment">#- SYNC_FLUSH 同步刷盘</span></span><br><span class="line">flushDiskType=SYNC_FLUSH</span><br><span class="line"><span class="comment">#checkTransactionMessageEnable=false</span></span><br><span class="line"><span class="comment">#发消息线程池数量</span></span><br><span class="line"><span class="comment">#sendMessageThreadPoolNums=128</span></span><br><span class="line"><span class="comment">#拉消息线程池数量</span></span><br><span class="line"><span class="comment">#pullMessageThreadPoolNums=128</span></span><br></pre></td></tr></table></figure><h4 id="slave1"><a href="#slave1" class="headerlink" title="slave1"></a>slave1</h4><p>服务器：192.168.25.138</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/soft/rocketmq/conf/2m-2s-sync/broker<span class="_">-a</span>-s.properties</span><br></pre></td></tr></table></figure><p>修改配置如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所属集群名字</span></span><br><span class="line">brokerClusterName=rocketmq-cluster</span><br><span class="line"><span class="comment">#broker名字，注意此处不同的配置文件填写的不一样</span></span><br><span class="line">brokerName=broker<span class="_">-a</span></span><br><span class="line"><span class="comment">#0 表示 Master，&gt;0 表示 Slave</span></span><br><span class="line">brokerId=1</span><br><span class="line"><span class="comment">#nameServer地址，分号分割</span></span><br><span class="line">namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span><br><span class="line"><span class="comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span></span><br><span class="line">defaultTopicQueueNums=4</span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateTopicEnable=<span class="literal">true</span></span><br><span class="line"><span class="comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span></span><br><span class="line">autoCreateSubscriptionGroup=<span class="literal">true</span></span><br><span class="line"><span class="comment">#Broker 对外服务的监听端口</span></span><br><span class="line">listenPort=11011</span><br><span class="line"><span class="comment">#删除文件时间点，默认凌晨 4点</span></span><br><span class="line">deleteWhen=04</span><br><span class="line"><span class="comment">#文件保留时间，默认 48 小时</span></span><br><span class="line">fileReservedTime=120</span><br><span class="line"><span class="comment">#commitLog每个文件的大小默认1G</span></span><br><span class="line">mapedFileSizeCommitLog=1073741824</span><br><span class="line"><span class="comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span></span><br><span class="line">mapedFileSizeConsumeQueue=300000</span><br><span class="line"><span class="comment">#destroyMapedFileIntervalForcibly=120000</span></span><br><span class="line"><span class="comment">#redeleteHangedFileInterval=120000</span></span><br><span class="line"><span class="comment">#检测物理文件磁盘空间</span></span><br><span class="line">diskMaxUsedSpaceRatio=88</span><br><span class="line"><span class="comment">#存储路径</span></span><br><span class="line">storePathRootDir=/usr/<span class="built_in">local</span>/rocketmq/store</span><br><span class="line"><span class="comment">#commitLog 存储路径</span></span><br><span class="line">storePathCommitLog=/usr/<span class="built_in">local</span>/rocketmq/store/commitlog</span><br><span class="line"><span class="comment">#消费队列存储路径存储路径</span></span><br><span class="line">storePathConsumeQueue=/usr/<span class="built_in">local</span>/rocketmq/store/consumequeue</span><br><span class="line"><span class="comment">#消息索引存储路径</span></span><br><span class="line">storePathIndex=/usr/<span class="built_in">local</span>/rocketmq/store/index</span><br><span class="line"><span class="comment">#checkpoint 文件存储路径</span></span><br><span class="line">storeCheckpoint=/usr/<span class="built_in">local</span>/rocketmq/store/checkpoint</span><br><span class="line"><span class="comment">#abort 文件存储路径</span></span><br><span class="line">abortFile=/usr/<span class="built_in">local</span>/rocketmq/store/abort</span><br><span class="line"><span class="comment">#限制的消息大小</span></span><br><span class="line">maxMessageSize=65536</span><br><span class="line"><span class="comment">#flushCommitLogLeastPages=4</span></span><br><span class="line"><span class="comment">#flushConsumeQueueLeastPages=2</span></span><br><span class="line"><span class="comment">#flushCommitLogThoroughInterval=10000</span></span><br><span class="line"><span class="comment">#flushConsumeQueueThoroughInterval=60000</span></span><br><span class="line"><span class="comment">#Broker 的角色</span></span><br><span class="line"><span class="comment">#- ASYNC_MASTER 异步复制Master</span></span><br><span class="line"><span class="comment">#- SYNC_MASTER 同步双写Master</span></span><br><span class="line"><span class="comment">#- SLAVE</span></span><br><span class="line">brokerRole=SLAVE</span><br><span class="line"><span class="comment">#刷盘方式</span></span><br><span class="line"><span class="comment">#- ASYNC_FLUSH 异步刷盘</span></span><br><span class="line"><span class="comment">#- SYNC_FLUSH 同步刷盘</span></span><br><span class="line">flushDiskType=ASYNC_FLUSH</span><br><span class="line"><span class="comment">#checkTransactionMessageEnable=false</span></span><br><span class="line"><span class="comment">#发消息线程池数量</span></span><br><span class="line"><span class="comment">#sendMessageThreadPoolNums=128</span></span><br><span class="line"><span class="comment">#拉消息线程池数量</span></span><br><span class="line"><span class="comment">#pullMessageThreadPoolNums=128</span></span><br></pre></td></tr></table></figure><h3 id="修改启动脚本文件"><a href="#修改启动脚本文件" class="headerlink" title="修改启动脚本文件"></a>修改启动脚本文件</h3><h4 id="runbroker-sh"><a href="#runbroker-sh" class="headerlink" title="runbroker.sh"></a>runbroker.sh</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/<span class="built_in">local</span>/rocketmq/bin/runbroker.sh</span><br></pre></td></tr></table></figure><p>需要根据内存大小进行适当的对JVM参数进行调整：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#===================================================</span></span><br><span class="line"><span class="comment"># 开发环境配置 JVM Configuration</span></span><br><span class="line">JAVA_OPT=<span class="string">"<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms256m -Xmx256m -Xmn128m"</span></span><br></pre></td></tr></table></figure><h4 id="runserver-sh"><a href="#runserver-sh" class="headerlink" title="runserver.sh"></a>runserver.sh</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/<span class="built_in">local</span>/rocketmq/bin/runserver.sh</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JAVA_OPT=<span class="string">"<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms256m -Xmx256m -Xmn128m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m"</span></span><br></pre></td></tr></table></figure><h3 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h3><h4 id="启动NameServe集群"><a href="#启动NameServe集群" class="headerlink" title="启动NameServe集群"></a>启动NameServe集群</h4><p>分别在192.168.25.135和192.168.25.138启动NameServer</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/rocketmq/bin</span><br><span class="line">nohup sh mqnamesrv &amp;</span><br></pre></td></tr></table></figure><h4 id="启动Broker集群"><a href="#启动Broker集群" class="headerlink" title="启动Broker集群"></a>启动Broker集群</h4><ul><li>在192.168.25.135上启动master1和slave2</li></ul><p>master1：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/rocketmq/bin</span><br><span class="line">nohup sh mqbroker -c /usr/<span class="built_in">local</span>/rocketmq/conf/2m-2s-syncbroker-a.properties &amp;</span><br></pre></td></tr></table></figure><p>slave2：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/rocketmq/bin</span><br><span class="line">nohup sh mqbroker -c /usr/<span class="built_in">local</span>/rocketmq/conf/2m-2s-sync/broker-b-s.properties &amp;</span><br></pre></td></tr></table></figure><ul><li>在192.168.25.138上启动master2和slave2</li></ul><p>master2</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/rocketmq/bin</span><br><span class="line">nohup sh mqbroker -c /usr/<span class="built_in">local</span>/rocketmq/conf/2m-2s-sync/broker-b.properties &amp;</span><br></pre></td></tr></table></figure><p>slave1</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/rocketmq/bin</span><br><span class="line">nohup sh mqbroker -c /usr/<span class="built_in">local</span>/rocketmq/conf/2m-2s-sync/broker<span class="_">-a</span>-s.properties &amp;</span><br></pre></td></tr></table></figure><h3 id="查看进程状态"><a href="#查看进程状态" class="headerlink" title="查看进程状态"></a>查看进程状态</h3><p>启动后通过JPS查看启动进程<br><img src="https://tva1.sinaimg.cn/large/006MOU0zgy1gjnuvutkp2j30w2032jra.jpg" referrerpolicy="no-referrer"></p><h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看nameServer日志</span></span><br><span class="line">tail -500f ~/logs/rocketmqlogs/namesrv.log</span><br><span class="line"><span class="comment"># 查看broker日志</span></span><br><span class="line">tail -500f ~/logs/rocketmqlogs/broker.log</span><br></pre></td></tr></table></figure><h2 id="mqadmin管理工具"><a href="#mqadmin管理工具" class="headerlink" title="mqadmin管理工具"></a>mqadmin管理工具</h2><h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><p>进入RocketMQ安装位置，在bin目录下执行<code>./mqadmin {command} {args}</code></p><h3 id="命令介绍"><a href="#命令介绍" class="headerlink" title="命令介绍"></a>命令介绍</h3><h4 id="Topic相关"><a href="#Topic相关" class="headerlink" title="Topic相关"></a>Topic相关</h4><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">含义</th><th style="text-align:center">命令选项</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">updateTopic</td><td style="text-align:center">创建更新Topic配置</td><td style="text-align:center">-b</td><td style="text-align:center">Broker 地址，表示 topic 所在<br>Broker，只支持单台Broker，地址为ip:port</td></tr><tr><td style="text-align:center">updateTopic</td><td style="text-align:center">创建更新Topic配置</td><td style="text-align:center">-c</td><td style="text-align:center">cluster 名称，表示 topic 所在集群（集群可通过clusterList 查询）</td></tr><tr><td style="text-align:center">updateTopic</td><td style="text-align:center">创建更新Topic配置</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">updateTopic</td><td style="text-align:center">创建更新Topic配置</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">updateTopic</td><td style="text-align:center">创建更新Topic配置</td><td style="text-align:center">-p</td><td style="text-align:center">指定新topic的读写权限( W=2,R=4,WR=6 )</td></tr><tr><td style="text-align:center">updateTopic</td><td style="text-align:center">创建更新Topic配置</td><td style="text-align:center">-r</td><td style="text-align:center">可读队列数（默认为 8）</td></tr><tr><td style="text-align:center">updateTopic</td><td style="text-align:center">创建更新Topic配置</td><td style="text-align:center">-w</td><td style="text-align:center">可写队列数（默认为 8）</td></tr><tr><td style="text-align:center">updateTopic</td><td style="text-align:center">创建更新Topic配置</td><td style="text-align:center">-t</td><td style="text-align:center">topic 名称（名称只能使用字符^[a-zA-Z0-9_-]+$ ）</td></tr><tr><td style="text-align:center">deleteTopic</td><td style="text-align:center">删除Topic</td><td style="text-align:center">-c</td><td style="text-align:center">cluster 名称，表示 topic 所在集群（集群可通过clusterList 查询）</td></tr><tr><td style="text-align:center">deleteTopic</td><td style="text-align:center">删除Topic</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">deleteTopic</td><td style="text-align:center">删除Topic</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">deleteTopic</td><td style="text-align:center">删除Topic</td><td style="text-align:center">-p</td><td style="text-align:center">指定新topic的读写权限( W=2,R=4,WR=6 )</td></tr><tr><td style="text-align:center">topicList</td><td style="text-align:center">查看 Topic 列表信息</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">topicList</td><td style="text-align:center">查看 Topic 列表信息</td><td style="text-align:center">-c</td><td style="text-align:center">不配置-c只返回topic列表，增加-c返回clusterName,topic, consumerGroup信息，即topic的所属集群和订阅关系，没有参数</td></tr><tr><td style="text-align:center">topicList</td><td style="text-align:center">查看 Topic 列表信息</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">topicRoute</td><td style="text-align:center">查看 Topic 路由信息</td><td style="text-align:center">-t</td><td style="text-align:center">topic 名称（名称只能使用字符^[a-zA-Z0-9_-]+$ ）</td></tr><tr><td style="text-align:center">topicRoute</td><td style="text-align:center">查看 Topic 路由信息</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">topicRoute</td><td style="text-align:center">查看 Topic 路由信息</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">topicStatus</td><td style="text-align:center">查看 Topic 消息队列offset</td><td style="text-align:center">-t</td><td style="text-align:center">topic 名称（名称只能使用字符^[a-zA-Z0-9_-]+$ ）</td></tr><tr><td style="text-align:center">topicStatus</td><td style="text-align:center">查看 Topic 消息队列offset</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">topicStatus</td><td style="text-align:center">查看 Topic 消息队列offset</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">topicClusterList</td><td style="text-align:center">查看 Topic 所在集群列表</td><td style="text-align:center">-t</td><td style="text-align:center">topic 名称（名称只能使用字符^[a-zA-Z0-9_-]+$ ）</td></tr><tr><td style="text-align:center">topicClusterList</td><td style="text-align:center">查看 Topic 所在集群列表</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">topicClusterList</td><td style="text-align:center">查看 Topic 所在集群列表</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">updateTopicPerm</td><td style="text-align:center">更新 Topic 读写权限</td><td style="text-align:center">-t</td><td style="text-align:center">topic 名称（名称只能使用字符^[a-zA-Z0-9_-]+$ ）</td></tr><tr><td style="text-align:center">updateTopicPerm</td><td style="text-align:center">更新 Topic 读写权限</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">updateTopicPerm</td><td style="text-align:center">更新 Topic 读写权限</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">updateTopicPerm</td><td style="text-align:center">更新 Topic 读写权限</td><td style="text-align:center">-b</td><td style="text-align:center">Broker 地址，表示 topic 所在<br>Broker，只支持单台Broker，地址为ip:port</td></tr><tr><td style="text-align:center">updateTopicPerm</td><td style="text-align:center">更新 Topic 读写权限</td><td style="text-align:center">-c</td><td style="text-align:center">cluster 名称，表示 topic 所在集群（集群可通过clusterList 查询）</td></tr><tr><td style="text-align:center">updateTopicPerm</td><td style="text-align:center">更新 Topic 读写权限</td><td style="text-align:center">-p</td><td style="text-align:center">指定新topic的读写权限( W=2,R=4,WR=6 )</td></tr><tr><td style="text-align:center">updateOrderConf</td><td style="text-align:center">从NameServer上创建、删除、获取特定命名空间的kv配置，目前还未启用</td><td style="text-align:center">-t</td><td style="text-align:center">topic 名称（名称只能使用字符^[a-zA-Z0-9_-]+$ ）</td></tr><tr><td style="text-align:center">updateOrderConf</td><td style="text-align:center">从NameServer上创建、删除、获取特定命名空间的kv配置，目前还未启用</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">updateOrderConf</td><td style="text-align:center">从NameServer上创建、删除、获取特定命名空间的kv配置，目前还未启用</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">updateOrderConf</td><td style="text-align:center">从NameServer上创建、删除、获取特定命名空间的kv配置，目前还未启用</td><td style="text-align:center">-v</td><td style="text-align:center">orderConf，值</td></tr><tr><td style="text-align:center">updateOrderConf</td><td style="text-align:center">从NameServer上创建、删除、获取特定命名空间的kv配置，目前还未启用</td><td style="text-align:center">-m</td><td style="text-align:center">method，可选get、put、delete</td></tr><tr><td style="text-align:center">allocateMQ</td><td style="text-align:center">以平均负载算法计算消费者列表负载消息队列的负载结果</td><td style="text-align:center">-t</td><td style="text-align:center">topic 名称（名称只能使用字符^[a-zA-Z0-9_-]+$ ）</td></tr><tr><td style="text-align:center">allocateMQ</td><td style="text-align:center">以平均负载算法计算消费者列表负载消息队列的负载结果</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">allocateMQ</td><td style="text-align:center">以平均负载算法计算消费者列表负载消息队列的负载结果</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">allocateMQ</td><td style="text-align:center">以平均负载算法计算消费者列表负载消息队列的负载结果</td><td style="text-align:center">-i</td><td style="text-align:center">ipList，用逗号分隔，计算这些ip去负载Topic的消息队列</td></tr><tr><td style="text-align:center">statsAll</td><td style="text-align:center">打印Topic订阅关系、TPS、积累量、24h读写总量等信息</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">statsAll</td><td style="text-align:center">打印Topic订阅关系、TPS、积累量、24h读写总量等信息</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">statsAll</td><td style="text-align:center">打印Topic订阅关系、TPS、积累量、24h读写总量等信息</td><td style="text-align:center">-a</td><td style="text-align:center">是否只打印活跃topic</td></tr><tr><td style="text-align:center">statsAll</td><td style="text-align:center">打印Topic订阅关系、TPS、积累量、24h读写总量等信息</td><td style="text-align:center">-t</td><td style="text-align:center">指定topic</td></tr></tbody></table><h4 id="集群相关"><a href="#集群相关" class="headerlink" title="集群相关"></a>集群相关</h4><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">含义</th><th style="text-align:center">命令选项</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">clusterList</td><td style="text-align:center">查看集群信息，集群、BrokerName、BrokerId、TPS等信息</td><td style="text-align:center">-m</td><td style="text-align:center">打印更多信息 (增加打印出如下信息 #InTotalYest,#OutTotalYest, #InTotalToday ,#OutTotalToday)</td></tr><tr><td style="text-align:center">clusterList</td><td style="text-align:center">查看集群信息，集群、BrokerName、BrokerId、TPS等信息</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">clusterList</td><td style="text-align:center">查看集群信息，集群、BrokerName、BrokerId、TPS等信息</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">clusterList</td><td style="text-align:center">查看集群信息，集群、BrokerName、BrokerId、TPS等信息</td><td style="text-align:center">-i</td><td style="text-align:center">打印间隔，单位秒</td></tr><tr><td style="text-align:center">clusterRT</td><td style="text-align:center">发送消息检测集群各Broker RT。消息发往${BrokerName} Topic。</td><td style="text-align:center">-a</td><td style="text-align:center">amount，每次探测的总数，RT = 总时间 /amount</td></tr><tr><td style="text-align:center">clusterRT</td><td style="text-align:center">发送消息检测集群各Broker RT。消息发往${BrokerName} Topic。</td><td style="text-align:center">-s</td><td style="text-align:center">消息大小，单位B</td></tr><tr><td style="text-align:center">clusterRT</td><td style="text-align:center">发送消息检测集群各Broker RT。消息发往${BrokerName} Topic。</td><td style="text-align:center">-c</td><td style="text-align:center">探测哪个集群</td></tr><tr><td style="text-align:center">clusterRT</td><td style="text-align:center">发送消息检测集群各Broker RT。消息发往${BrokerName} Topic。</td><td style="text-align:center">-p</td><td style="text-align:center">是否打印格式化日志，以丨分割，默认不打印</td></tr><tr><td style="text-align:center">clusterRT</td><td style="text-align:center">发送消息检测集群各Broker RT。消息发往${BrokerName} Topic。</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">clusterRT</td><td style="text-align:center">发送消息检测集群各Broker RT。消息发往${BrokerName} Topic。</td><td style="text-align:center">-m</td><td style="text-align:center">所属机房，打印使用</td></tr><tr><td style="text-align:center">clusterRT</td><td style="text-align:center">发送消息检测集群各Broker RT。消息发往${BrokerName} Topic。</td><td style="text-align:center">-i</td><td style="text-align:center">发送间隔，单位秒</td></tr><tr><td style="text-align:center">clusterRT</td><td style="text-align:center">发送消息检测集群各Broker RT。消息发往${BrokerName} Topic。</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr></tbody></table><h4 id="Broker相关"><a href="#Broker相关" class="headerlink" title="Broker相关"></a>Broker相关</h4><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">含义</th><th style="text-align:center">命令选项</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">updateBrokerConfig</td><td style="text-align:center">更新 Broker 配置文件，会修改Broker.conf</td><td style="text-align:center">-b</td><td style="text-align:center">Broker 地址，格式为ip:port</td></tr><tr><td style="text-align:center">updateBrokerConfig</td><td style="text-align:center">更新 Broker 配置文件，会修改Broker.conf</td><td style="text-align:center">-c</td><td style="text-align:center">cluster 名称</td></tr><tr><td style="text-align:center">updateBrokerConfig</td><td style="text-align:center">更新 Broker 配置文件，会修改Broker.conf</td><td style="text-align:center">-k</td><td style="text-align:center">key 值</td></tr><tr><td style="text-align:center">updateBrokerConfig</td><td style="text-align:center">更新 Broker 配置文件，会修改Broker.conf</td><td style="text-align:center">-v</td><td style="text-align:center">value 值</td></tr><tr><td style="text-align:center">updateBrokerConfig</td><td style="text-align:center">更新 Broker 配置文件，会修改Broker.conf</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">updateBrokerConfig</td><td style="text-align:center">更新 Broker 配置文件，会修改Broker.conf</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">brokerStatus</td><td style="text-align:center">查看 Broker 统计信息、运行状态（你想要的信息几乎都在里面）</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">brokerStatus</td><td style="text-align:center">查看 Broker 统计信息、运行状态（你想要的信息几乎都在里面）</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">brokerStatus</td><td style="text-align:center">查看 Broker 统计信息、运行状态（你想要的信息几乎都在里面）</td><td style="text-align:center">-b</td><td style="text-align:center">Broker 地址，格式为ip:port</td></tr><tr><td style="text-align:center">brokerConsumeStats</td><td style="text-align:center">Broker中各个消费者的消费情况，按Message Queue维度返回Consume Offset，Broker Offset，Diff，TImestamp等信息</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">brokerConsumeStats</td><td style="text-align:center">Broker中各个消费者的消费情况，按Message Queue维度返回Consume Offset，Broker Offset，Diff，TImestamp等信息</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">brokerConsumeStats</td><td style="text-align:center">Broker中各个消费者的消费情况，按Message Queue维度返回Consume Offset，Broker Offset，Diff，TImestamp等信息</td><td style="text-align:center">-b</td><td style="text-align:center">Broker 地址，格式为ip:port</td></tr><tr><td style="text-align:center">brokerConsumeStats</td><td style="text-align:center">Broker中各个消费者的消费情况，按Message Queue维度返回Consume Offset，Broker Offset，Diff，TImestamp等信息</td><td style="text-align:center">-t</td><td style="text-align:center">请求超时时间</td></tr><tr><td style="text-align:center">brokerConsumeStats</td><td style="text-align:center">Broker中各个消费者的消费情况，按Message Queue维度返回Consume Offset，Broker Offset，Diff，TImestamp等信息</td><td style="text-align:center">-l</td><td style="text-align:center">diff阈值，超过阈值才打印</td></tr><tr><td style="text-align:center">brokerConsumeStats</td><td style="text-align:center">Broker中各个消费者的消费情况，按Message Queue维度返回Consume Offset，Broker Offset，Diff，TImestamp等信息</td><td style="text-align:center">-o</td><td style="text-align:center">是否为顺序topic，一般为false</td></tr><tr><td style="text-align:center">getBrokerConfig</td><td style="text-align:center">获取Broker配置</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">getBrokerConfig</td><td style="text-align:center">获取Broker配置</td><td style="text-align:center">-b</td><td style="text-align:center">Broker 地址，格式为ip:port</td></tr><tr><td style="text-align:center">wipeWritePerm</td><td style="text-align:center">从NameServer上清除 Broker写权限</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">wipeWritePerm</td><td style="text-align:center">从NameServer上清除 Broker写权限</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">wipeWritePerm</td><td style="text-align:center">从NameServer上清除 Broker写权限</td><td style="text-align:center">-b</td><td style="text-align:center">Broker 地址，格式为ip:port</td></tr><tr><td style="text-align:center">cleanExpiredCQ</td><td style="text-align:center">清理Broker上过期的Consume Queue，如果手动减少对列数可能产生过期队列</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">cleanExpiredCQ</td><td style="text-align:center">清理Broker上过期的Consume Queue，如果手动减少对列数可能产生过期队列</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">cleanExpiredCQ</td><td style="text-align:center">清理Broker上过期的Consume Queue，如果手动减少对列数可能产生过期队列</td><td style="text-align:center">-b</td><td style="text-align:center">Broker 地址，格式为ip:port</td></tr><tr><td style="text-align:center">cleanExpiredCQ</td><td style="text-align:center">清理Broker上过期的Consume Queue，如果手动减少对列数可能产生过期队列</td><td style="text-align:center">-c</td><td style="text-align:center">cluster 名称</td></tr><tr><td style="text-align:center">cleanUnusedTopic</td><td style="text-align:center">清理Broker上不使用的Topic，从内存中释放Topic的Consume Queue，如果手动删除Topic会产生不使用的Topic</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">cleanUnusedTopic</td><td style="text-align:center">清理Broker上不使用的Topic，从内存中释放Topic的Consume Queue，如果手动删除Topic会产生不使用的Topic</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">cleanUnusedTopic</td><td style="text-align:center">清理Broker上不使用的Topic，从内存中释放Topic的Consume Queue，如果手动删除Topic会产生不使用的Topic</td><td style="text-align:center">-b</td><td style="text-align:center">Broker 地址，格式为ip:port</td></tr><tr><td style="text-align:center">cleanUnusedTopic</td><td style="text-align:center">清理Broker上不使用的Topic，从内存中释放Topic的Consume Queue，如果手动删除Topic会产生不使用的Topic</td><td style="text-align:center">-c</td><td style="text-align:center">cluster 名称</td></tr><tr><td style="text-align:center">sendMsgStatus</td><td style="text-align:center">向Broker发消息，返回发送状态和RT</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">sendMsgStatus</td><td style="text-align:center">向Broker发消息，返回发送状态和RT</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">sendMsgStatus</td><td style="text-align:center">向Broker发消息，返回发送状态和RT</td><td style="text-align:center">-b</td><td style="text-align:center">Broker 地址，格式为ip:port</td></tr><tr><td style="text-align:center">sendMsgStatus</td><td style="text-align:center">向Broker发消息，返回发送状态和RT</td><td style="text-align:center">-c</td><td style="text-align:center">cluster 名称</td></tr><tr><td style="text-align:center">sendMsgStatus</td><td style="text-align:center">向Broker发消息，返回发送状态和RT</td><td style="text-align:center">-s</td><td style="text-align:center">消息大小，单位B</td></tr></tbody></table><h4 id="消息相关"><a href="#消息相关" class="headerlink" title="消息相关"></a>消息相关</h4><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">含义</th><th style="text-align:center">命令选项</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">queryMsgById</td><td style="text-align:center">根据offsetMsgId查询msg，如果使用开源控制台，应使用offsetMsgId，此命令还有其他参数，具体作用请阅读QueryMsgByIdSubCommand。</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">queryMsgById</td><td style="text-align:center">根据offsetMsgId查询msg，如果使用开源控制台，应使用offsetMsgId，此命令还有其他参数，具体作用请阅读QueryMsgByIdSubCommand。</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">queryMsgById</td><td style="text-align:center">根据offsetMsgId查询msg，如果使用开源控制台，应使用offsetMsgId，此命令还有其他参数，具体作用请阅读QueryMsgByIdSubCommand。</td><td style="text-align:center">-i</td><td style="text-align:center">queueId</td></tr><tr><td style="text-align:center">queryMsgByKey</td><td style="text-align:center">根据消息 Key 查询消息</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">queryMsgByKey</td><td style="text-align:center">根据消息 Key 查询消息</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">queryMsgByKey</td><td style="text-align:center">根据消息 Key 查询消息</td><td style="text-align:center">-k</td><td style="text-align:center">msgKey</td></tr><tr><td style="text-align:center">queryMsgByKey</td><td style="text-align:center">根据消息 Key 查询消息</td><td style="text-align:center">-t</td><td style="text-align:center">topic名称</td></tr><tr><td style="text-align:center">queryMsgByOffset</td><td style="text-align:center">根据 Offset 查询消息</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">queryMsgByOffset</td><td style="text-align:center">根据 Offset 查询消息</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">queryMsgByOffset</td><td style="text-align:center">根据 Offset 查询消息</td><td style="text-align:center">-o</td><td style="text-align:center">offset 值</td></tr><tr><td style="text-align:center">queryMsgByOffset</td><td style="text-align:center">根据 Offset 查询消息</td><td style="text-align:center">-i</td><td style="text-align:center">queueId</td></tr><tr><td style="text-align:center">queryMsgByOffset</td><td style="text-align:center">根据 Offset 查询消息</td><td style="text-align:center">-b</td><td style="text-align:center">开始时间戳，格式参见-h</td></tr><tr><td style="text-align:center">queryMsgByUniqueKey</td><td style="text-align:center">根据msgId查询，msgId不同于offsetMsgId，区别详见常见运维问题。-g，-d配合使用，查到消息后尝试让特定的消费者消费消息并返回消费结果</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">queryMsgByUniqueKey</td><td style="text-align:center">根据msgId查询，msgId不同于offsetMsgId，区别详见常见运维问题。-g，-d配合使用，查到消息后尝试让特定的消费者消费消息并返回消费结果</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">queryMsgByUniqueKey</td><td style="text-align:center">根据msgId查询，msgId不同于offsetMsgId，区别详见常见运维问题。-g，-d配合使用，查到消息后尝试让特定的消费者消费消息并返回消费结果</td><td style="text-align:center">-g</td><td style="text-align:center">consumerGroup</td></tr><tr><td style="text-align:center">queryMsgByUniqueKey</td><td style="text-align:center">根据msgId查询，msgId不同于offsetMsgId，区别详见常见运维问题。-g，-d配合使用，查到消息后尝试让特定的消费者消费消息并返回消费结果</td><td style="text-align:center">-d</td><td style="text-align:center">是否打印消息体</td></tr><tr><td style="text-align:center">queryMsgByUniqueKey</td><td style="text-align:center">根据msgId查询，msgId不同于offsetMsgId，区别详见常见运维问题。-g，-d配合使用，查到消息后尝试让特定的消费者消费消息并返回消费结果</td><td style="text-align:center">-i</td><td style="text-align:center">uniqe msg id</td></tr><tr><td style="text-align:center">queryMsgByUniqueKey</td><td style="text-align:center">根据msgId查询，msgId不同于offsetMsgId，区别详见常见运维问题。-g，-d配合使用，查到消息后尝试让特定的消费者消费消息并返回消费结果</td><td style="text-align:center">-t</td><td style="text-align:center">topic名称</td></tr><tr><td style="text-align:center">checkMsgSendRT</td><td style="text-align:center">检测向topic发消息的RT，功能类似clusterRT</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">checkMsgSendRT</td><td style="text-align:center">检测向topic发消息的RT，功能类似clusterRT</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">checkMsgSendRT</td><td style="text-align:center">检测向topic发消息的RT，功能类似clusterRT</td><td style="text-align:center">-t</td><td style="text-align:center">topic名称</td></tr><tr><td style="text-align:center">checkMsgSendRT</td><td style="text-align:center">检测向topic发消息的RT，功能类似clusterRT</td><td style="text-align:center">-a</td><td style="text-align:center">BrokerName</td></tr><tr><td style="text-align:center">checkMsgSendRT</td><td style="text-align:center">检测向topic发消息的RT，功能类似clusterRT</td><td style="text-align:center">-s</td><td style="text-align:center">subExpress，过滤表达式</td></tr><tr><td style="text-align:center">sendMessage</td><td style="text-align:center">发送一条消息，可以根据配置发往特定Message Queue，或普通发送。</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">sendMessage</td><td style="text-align:center">发送一条消息，可以根据配置发往特定Message Queue，或普通发送。</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">sendMessage</td><td style="text-align:center">发送一条消息，可以根据配置发往特定Message Queue，或普通发送。</td><td style="text-align:center">-t</td><td style="text-align:center">topic名称</td></tr><tr><td style="text-align:center">sendMessage</td><td style="text-align:center">发送一条消息，可以根据配置发往特定Message Queue，或普通发送。</td><td style="text-align:center">-p</td><td style="text-align:center">是否打印消息</td></tr><tr><td style="text-align:center">sendMessage</td><td style="text-align:center">发送一条消息，可以根据配置发往特定Message Queue，或普通发送。</td><td style="text-align:center">-k</td><td style="text-align:center">msgKey</td></tr><tr><td style="text-align:center">sendMessage</td><td style="text-align:center">发送一条消息，可以根据配置发往特定Message Queue，或普通发送。</td><td style="text-align:center">-c</td><td style="text-align:center">字符集，例如UTF-8</td></tr><tr><td style="text-align:center">sendMessage</td><td style="text-align:center">发送一条消息，可以根据配置发往特定Message Queue，或普通发送。</td><td style="text-align:center">-b</td><td style="text-align:center">开始时间戳，格式参见-h</td></tr><tr><td style="text-align:center">sendMessage</td><td style="text-align:center">发送一条消息，可以根据配置发往特定Message Queue，或普通发送。</td><td style="text-align:center">-i</td><td style="text-align:center">queueId</td></tr><tr><td style="text-align:center">consumeMessage</td><td style="text-align:center">消费消息。可以根据offset、开始&amp;结束时间戳、消息队列消费消息，配置不同执行不同消费逻辑，详见ConsumeMessageCommand。</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">consumeMessage</td><td style="text-align:center">消费消息。可以根据offset、开始&amp;结束时间戳、消息队列消费消息，配置不同执行不同消费逻辑，详见ConsumeMessageCommand。</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">consumeMessage</td><td style="text-align:center">消费消息。可以根据offset、开始&amp;结束时间戳、消息队列消费消息，配置不同执行不同消费逻辑，详见ConsumeMessageCommand。</td><td style="text-align:center">-t</td><td style="text-align:center">topic名称</td></tr><tr><td style="text-align:center">consumeMessage</td><td style="text-align:center">消费消息。可以根据offset、开始&amp;结束时间戳、消息队列消费消息，配置不同执行不同消费逻辑，详见ConsumeMessageCommand。</td><td style="text-align:center">-b</td><td style="text-align:center">开始时间戳，格式参见-h</td></tr><tr><td style="text-align:center">consumeMessage</td><td style="text-align:center">消费消息。可以根据offset、开始&amp;结束时间戳、消息队列消费消息，配置不同执行不同消费逻辑，详见ConsumeMessageCommand。</td><td style="text-align:center">-o</td><td style="text-align:center">offset 值</td></tr><tr><td style="text-align:center">consumeMessage</td><td style="text-align:center">消费消息。可以根据offset、开始&amp;结束时间戳、消息队列消费消息，配置不同执行不同消费逻辑，详见ConsumeMessageCommand。</td><td style="text-align:center">-i</td><td style="text-align:center">queueId</td></tr><tr><td style="text-align:center">consumeMessage</td><td style="text-align:center">消费消息。可以根据offset、开始&amp;结束时间戳、消息队列消费消息，配置不同执行不同消费逻辑，详见ConsumeMessageCommand。</td><td style="text-align:center">-g</td><td style="text-align:center">consumerGroup</td></tr><tr><td style="text-align:center">consumeMessage</td><td style="text-align:center">消费消息。可以根据offset、开始&amp;结束时间戳、消息队列消费消息，配置不同执行不同消费逻辑，详见ConsumeMessageCommand。</td><td style="text-align:center">-s</td><td style="text-align:center">subExpress，过滤表达式</td></tr><tr><td style="text-align:center">consumeMessage</td><td style="text-align:center">消费消息。可以根据offset、开始&amp;结束时间戳、消息队列消费消息，配置不同执行不同消费逻辑，详见ConsumeMessageCommand。</td><td style="text-align:center">-d</td><td style="text-align:center">是否打印消息体</td></tr><tr><td style="text-align:center">consumeMessage</td><td style="text-align:center">消费消息。可以根据offset、开始&amp;结束时间戳、消息队列消费消息，配置不同执行不同消费逻辑，详见ConsumeMessageCommand。</td><td style="text-align:center">-c</td><td style="text-align:center">字符集，例如UTF-8</td></tr><tr><td style="text-align:center">printMsg</td><td style="text-align:center">从Broker消费消息并打印，可选时间段</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">printMsg</td><td style="text-align:center">从Broker消费消息并打印，可选时间段</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">printMsg</td><td style="text-align:center">从Broker消费消息并打印，可选时间段</td><td style="text-align:center">-t</td><td style="text-align:center">topic名称</td></tr><tr><td style="text-align:center">printMsg</td><td style="text-align:center">从Broker消费消息并打印，可选时间段</td><td style="text-align:center">-s</td><td style="text-align:center">subExpress，过滤表达式</td></tr><tr><td style="text-align:center">printMsg</td><td style="text-align:center">从Broker消费消息并打印，可选时间段</td><td style="text-align:center">-b</td><td style="text-align:center">开始时间戳，格式参见-h</td></tr><tr><td style="text-align:center">printMsg</td><td style="text-align:center">从Broker消费消息并打印，可选时间段</td><td style="text-align:center">-e</td><td style="text-align:center">结束时间戳</td></tr><tr><td style="text-align:center">printMsg</td><td style="text-align:center">从Broker消费消息并打印，可选时间段</td><td style="text-align:center">-d</td><td style="text-align:center">是否打印消息体</td></tr><tr><td style="text-align:center">printMsgByQueue</td><td style="text-align:center">类似printMsg，但指定Message Queue</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">printMsgByQueue</td><td style="text-align:center">类似printMsg，但指定Message Queue</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">printMsgByQueue</td><td style="text-align:center">类似printMsg，但指定Message Queue</td><td style="text-align:center">-t</td><td style="text-align:center">topic名称</td></tr><tr><td style="text-align:center">printMsgByQueue</td><td style="text-align:center">类似printMsg，但指定Message Queue</td><td style="text-align:center">-i</td><td style="text-align:center">queueId</td></tr><tr><td style="text-align:center">printMsgByQueue</td><td style="text-align:center">类似printMsg，但指定Message Queue</td><td style="text-align:center">-a</td><td style="text-align:center">BrokerName</td></tr><tr><td style="text-align:center">printMsgByQueue</td><td style="text-align:center">类似printMsg，但指定Message Queue</td><td style="text-align:center">-c</td><td style="text-align:center">字符集，例如UTF-8</td></tr><tr><td style="text-align:center">printMsgByQueue</td><td style="text-align:center">类似printMsg，但指定Message Queue</td><td style="text-align:center">-s</td><td style="text-align:center">subExpress，过滤表达式</td></tr><tr><td style="text-align:center">printMsgByQueue</td><td style="text-align:center">类似printMsg，但指定Message Queue</td><td style="text-align:center">-b</td><td style="text-align:center">开始时间戳，格式参见-h</td></tr><tr><td style="text-align:center">printMsgByQueue</td><td style="text-align:center">类似printMsg，但指定Message Queue</td><td style="text-align:center">-e</td><td style="text-align:center">结束时间戳</td></tr><tr><td style="text-align:center">printMsgByQueue</td><td style="text-align:center">类似printMsg，但指定Message Queue</td><td style="text-align:center">-p</td><td style="text-align:center">是否打印消息</td></tr><tr><td style="text-align:center">printMsgByQueue</td><td style="text-align:center">类似printMsg，但指定Message Queue</td><td style="text-align:center">-d</td><td style="text-align:center">是否打印消息体</td></tr><tr><td style="text-align:center">printMsgByQueue</td><td style="text-align:center">类似printMsg，但指定Message Queue</td><td style="text-align:center">-f</td><td style="text-align:center">是否统计tag数量并打印</td></tr><tr><td style="text-align:center">resetOffsetByTime</td><td style="text-align:center">按时间戳重置offset，Broker和consumer都会重置</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">resetOffsetByTime</td><td style="text-align:center">按时间戳重置offset，Broker和consumer都会重置</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">resetOffsetByTime</td><td style="text-align:center">按时间戳重置offset，Broker和consumer都会重置</td><td style="text-align:center">-g</td><td style="text-align:center">consumerGroup</td></tr><tr><td style="text-align:center">resetOffsetByTime</td><td style="text-align:center">按时间戳重置offset，Broker和consumer都会重置</td><td style="text-align:center">-t</td><td style="text-align:center">topic名称</td></tr><tr><td style="text-align:center">resetOffsetByTime</td><td style="text-align:center">按时间戳重置offset，Broker和consumer都会重置</td><td style="text-align:center">-s</td><td style="text-align:center">subExpress，过滤表达式</td></tr><tr><td style="text-align:center">resetOffsetByTime</td><td style="text-align:center">按时间戳重置offset，Broker和consumer都会重置</td><td style="text-align:center">-f</td><td style="text-align:center">是否统计tag数量并打印</td></tr><tr><td style="text-align:center">resetOffsetByTime</td><td style="text-align:center">按时间戳重置offset，Broker和consumer都会重置</td><td style="text-align:center">-c</td><td style="text-align:center">字符集，例如UTF-8</td></tr></tbody></table><h4 id="消费者、消费组相关"><a href="#消费者、消费组相关" class="headerlink" title="消费者、消费组相关"></a>消费者、消费组相关</h4><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">含义</th><th style="text-align:center">命令选项</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">consumerProgress</td><td style="text-align:center">查看订阅组消费状态，可以查看具体的client IP的消息积累量</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">consumerProgress</td><td style="text-align:center">查看订阅组消费状态，可以查看具体的client IP的消息积累量</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">consumerProgress</td><td style="text-align:center">查看订阅组消费状态，可以查看具体的client IP的消息积累量</td><td style="text-align:center">-g</td><td style="text-align:center">消费者所属组名</td></tr><tr><td style="text-align:center">consumerProgress</td><td style="text-align:center">查看订阅组消费状态，可以查看具体的client IP的消息积累量</td><td style="text-align:center">-s</td><td style="text-align:center">是否打印client IP</td></tr><tr><td style="text-align:center">consumerStatus</td><td style="text-align:center">查看消费者状态，包括同一个分组中是否都是相同的订阅，分析Process Queue是否堆积，返回消费者jstack结果，内容较多，使用者参见ConsumerStatusSubCommand</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">consumerStatus</td><td style="text-align:center">查看消费者状态，包括同一个分组中是否都是相同的订阅，分析Process Queue是否堆积，返回消费者jstack结果，内容较多，使用者参见ConsumerStatusSubCommand</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">consumerStatus</td><td style="text-align:center">查看消费者状态，包括同一个分组中是否都是相同的订阅，分析Process Queue是否堆积，返回消费者jstack结果，内容较多，使用者参见ConsumerStatusSubCommand</td><td style="text-align:center">-g</td><td style="text-align:center">消费者所属组名</td></tr><tr><td style="text-align:center">consumerStatus</td><td style="text-align:center">查看消费者状态，包括同一个分组中是否都是相同的订阅，分析Process Queue是否堆积，返回消费者jstack结果，内容较多，使用者参见ConsumerStatusSubCommand</td><td style="text-align:center">-i</td><td style="text-align:center">clientId</td></tr><tr><td style="text-align:center">consumerStatus</td><td style="text-align:center">查看消费者状态，包括同一个分组中是否都是相同的订阅，分析Process Queue是否堆积，返回消费者jstack结果，内容较多，使用者参见ConsumerStatusSubCommand</td><td style="text-align:center">-s</td><td style="text-align:center">是否执行jstack</td></tr><tr><td style="text-align:center">getConsumerStatus</td><td style="text-align:center">获取 Consumer 消费进度</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">getConsumerStatus</td><td style="text-align:center">获取 Consumer 消费进度</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">getConsumerStatus</td><td style="text-align:center">获取 Consumer 消费进度</td><td style="text-align:center">-g</td><td style="text-align:center">消费者所属组名</td></tr><tr><td style="text-align:center">getConsumerStatus</td><td style="text-align:center">获取 Consumer 消费进度</td><td style="text-align:center">-i</td><td style="text-align:center">clientId</td></tr><tr><td style="text-align:center">getConsumerStatus</td><td style="text-align:center">获取 Consumer 消费进度</td><td style="text-align:center">-t</td><td style="text-align:center">查询主题</td></tr><tr><td style="text-align:center">updateSubGroup</td><td style="text-align:center">更新或创建订阅关系</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">updateSubGroup</td><td style="text-align:center">更新或创建订阅关系</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">updateSubGroup</td><td style="text-align:center">更新或创建订阅关系</td><td style="text-align:center">-b</td><td style="text-align:center">Broker地址</td></tr><tr><td style="text-align:center">updateSubGroup</td><td style="text-align:center">更新或创建订阅关系</td><td style="text-align:center">-c</td><td style="text-align:center">集群名称</td></tr><tr><td style="text-align:center">updateSubGroup</td><td style="text-align:center">更新或创建订阅关系</td><td style="text-align:center">-g</td><td style="text-align:center">消费者分组名称</td></tr><tr><td style="text-align:center">updateSubGroup</td><td style="text-align:center">更新或创建订阅关系</td><td style="text-align:center">-s</td><td style="text-align:center">分组是否允许消费</td></tr><tr><td style="text-align:center">updateSubGroup</td><td style="text-align:center">更新或创建订阅关系</td><td style="text-align:center">-m</td><td style="text-align:center">是否从最小offset开始消费</td></tr><tr><td style="text-align:center">updateSubGroup</td><td style="text-align:center">更新或创建订阅关系</td><td style="text-align:center">-d</td><td style="text-align:center">是否是广播模式</td></tr><tr><td style="text-align:center">updateSubGroup</td><td style="text-align:center">更新或创建订阅关系</td><td style="text-align:center">-q</td><td style="text-align:center">重试队列数量</td></tr><tr><td style="text-align:center">updateSubGroup</td><td style="text-align:center">更新或创建订阅关系</td><td style="text-align:center">-r</td><td style="text-align:center">最大重试次数</td></tr><tr><td style="text-align:center">updateSubGroup</td><td style="text-align:center">更新或创建订阅关系</td><td style="text-align:center">-i</td><td style="text-align:center">当slaveReadEnable开启时有效，且还未达到从slave消费时建议从哪个BrokerId消费，可以配置备机id，主动从备机消费</td></tr><tr><td style="text-align:center">updateSubGroup</td><td style="text-align:center">更新或创建订阅关系</td><td style="text-align:center">-w</td><td style="text-align:center">如果Broker建议从slave消费，配置决定从哪个slave消费，配置BrokerId，例如1</td></tr><tr><td style="text-align:center">updateSubGroup</td><td style="text-align:center">更新或创建订阅关系</td><td style="text-align:center">-a</td><td style="text-align:center">当消费者数量变化时是否通知其他消费者负载均衡</td></tr><tr><td style="text-align:center">deleteSubGroup</td><td style="text-align:center">从Broker删除订阅关系</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">deleteSubGroup</td><td style="text-align:center">从Broker删除订阅关系</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">deleteSubGroup</td><td style="text-align:center">从Broker删除订阅关系</td><td style="text-align:center">-b</td><td style="text-align:center">Broker地址</td></tr><tr><td style="text-align:center">deleteSubGroup</td><td style="text-align:center">从Broker删除订阅关系</td><td style="text-align:center">-c</td><td style="text-align:center">集群名称</td></tr><tr><td style="text-align:center">deleteSubGroup</td><td style="text-align:center">从Broker删除订阅关系</td><td style="text-align:center">-g</td><td style="text-align:center">消费者分组名称</td></tr><tr><td style="text-align:center">cloneGroupOffset</td><td style="text-align:center">在目标群组中使用源群组的offset</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">cloneGroupOffset</td><td style="text-align:center">在目标群组中使用源群组的offset</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">cloneGroupOffset</td><td style="text-align:center">在目标群组中使用源群组的offset</td><td style="text-align:center">-s</td><td style="text-align:center">源消费者组</td></tr><tr><td style="text-align:center">cloneGroupOffset</td><td style="text-align:center">在目标群组中使用源群组的offset</td><td style="text-align:center">-d</td><td style="text-align:center">目标消费者组</td></tr><tr><td style="text-align:center">cloneGroupOffset</td><td style="text-align:center">在目标群组中使用源群组的offset</td><td style="text-align:center">-t</td><td style="text-align:center">topic名称</td></tr></tbody></table><h4 id="连接相关"><a href="#连接相关" class="headerlink" title="连接相关"></a>连接相关</h4><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">含义</th><th style="text-align:center">命令选项</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">consumerConnec tion</td><td style="text-align:center">查询 Consumer 的网络连接</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">consumerConnec tion</td><td style="text-align:center">查询 Consumer 的网络连接</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">consumerConnec tion</td><td style="text-align:center">查询 Consumer 的网络连接</td><td style="text-align:center">-g</td><td style="text-align:center">消费者组名称</td></tr><tr><td style="text-align:center">producerConnec tion</td><td style="text-align:center">查询 Producer 的网络连接</td><td style="text-align:center">-g</td><td style="text-align:center">消费者组名称</td></tr><tr><td style="text-align:center">producerConnec tion</td><td style="text-align:center">查询 Producer 的网络连接</td><td style="text-align:center">t</td><td style="text-align:center">topic名称</td></tr><tr><td style="text-align:center">producerConnec tion</td><td style="text-align:center">查询 Producer 的网络连接</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">producerConnec tion</td><td style="text-align:center">查询 Producer 的网络连接</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr></tbody></table><h4 id="NameServer相关"><a href="#NameServer相关" class="headerlink" title="NameServer相关"></a>NameServer相关</h4><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">含义</th><th style="text-align:center">命令选项</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">updateKvConfig</td><td style="text-align:center">更新NameServer的kv配置，目前还未使用</td><td style="text-align:center">-s</td><td style="text-align:center">命名空间</td></tr><tr><td style="text-align:center">updateKvConfig</td><td style="text-align:center">更新NameServer的kv配置，目前还未使用</td><td style="text-align:center">-k</td><td style="text-align:center">key</td></tr><tr><td style="text-align:center">updateKvConfig</td><td style="text-align:center">更新NameServer的kv配置，目前还未使用</td><td style="text-align:center">-v</td><td style="text-align:center">value</td></tr><tr><td style="text-align:center">updateKvConfig</td><td style="text-align:center">更新NameServer的kv配置，目前还未使用</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">updateKvConfig</td><td style="text-align:center">更新NameServer的kv配置，目前还未使用</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">deleteKvConfig</td><td style="text-align:center">删除NameServer的kv配置</td><td style="text-align:center">-s</td><td style="text-align:center">命名空间</td></tr><tr><td style="text-align:center">deleteKvConfig</td><td style="text-align:center">删除NameServer的kv配置</td><td style="text-align:center">-k</td><td style="text-align:center">key</td></tr><tr><td style="text-align:center">deleteKvConfig</td><td style="text-align:center">删除NameServer的kv配置</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">deleteKvConfig</td><td style="text-align:center">删除NameServer的kv配置</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">getNamesrvConfig</td><td style="text-align:center">获取NameServer配置</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">getNamesrvConfig</td><td style="text-align:center">获取NameServer配置</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr><tr><td style="text-align:center">updateNamesrvConfig</td><td style="text-align:center">修改NameServer配置</td><td style="text-align:center">-k</td><td style="text-align:center">key</td></tr><tr><td style="text-align:center">updateNamesrvConfig</td><td style="text-align:center">修改NameServer配置</td><td style="text-align:center">-v</td><td style="text-align:center">value</td></tr><tr><td style="text-align:center">updateNamesrvConfig</td><td style="text-align:center">修改NameServer配置</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">updateNamesrvConfig</td><td style="text-align:center">修改NameServer配置</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr></tbody></table><h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><table><thead><tr><th style="text-align:center">名称</th><th style="text-align:center">含义</th><th style="text-align:center">命令选项</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">startMonitoring</td><td style="text-align:center">开启监控进程，监控消息误删、重试队列消息数等</td><td style="text-align:center">-n</td><td style="text-align:center">NameServer 服务地址，格式 ip:port</td></tr><tr><td style="text-align:center">startMonitoring</td><td style="text-align:center">开启监控进程，监控消息误删、重试队列消息数等</td><td style="text-align:center">-h</td><td style="text-align:center">打印帮助</td></tr></tbody></table><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul><li>几乎所有命令都需要配置-n表示NameServer地址，格式为ip:port</li><li>几乎所有命令都可以通过-h获取帮助</li><li>如果既有Broker地址（-b）配置项又有clusterName（-c）配置项，则优先以Broker地址执行命令；如果不配置Broker地址，则对集群中所有主机执行命令</li></ul><h2 id="集群监控平台搭建"><a href="#集群监控平台搭建" class="headerlink" title="集群监控平台搭建"></a>集群监控平台搭建</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p><code>RocketMQ</code>有一个对其扩展的开源项目<a href="https://github.com/apache/rocketmq-externals" target="_blank" rel="noopener">incubator-rocketmq-externals</a>，这个项目中有一个子模块叫<code>rocketmq-console</code>，这个便是管理控制台项目了，先将<a href="https://github.com/apache/rocketmq-externals" target="_blank" rel="noopener">incubator-rocketmq-externals</a>拉到本地，因为我们需要自己对<code>rocketmq-console</code>进行编译打包运行。<br><img src="https://tva3.sinaimg.cn/large/006MOU0zgy1gjnxxodknrj30cp0mj0ti.jpg" referrerpolicy="no-referrer"></p><h3 id="下载并编译打包"><a href="#下载并编译打包" class="headerlink" title="下载并编译打包"></a>下载并编译打包</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/apache/rocketmq-externals</span><br><span class="line"><span class="built_in">cd</span> rocketmq-console</span><br><span class="line">mvn clean package -Dmaven.test.skip=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p>注意：打包前在<code>rocketmq-console</code>中配置<code>namesrv</code>集群地址：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rocketmq.config.namesrvAddr=192.168.25.135:9876;192.168.25.138:9876</span><br></pre></td></tr></table></figure><p>启动rocketmq-console：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar rocketmq-console-ng-1.0.0.jar</span><br></pre></td></tr></table></figure><p>启动成功后，我们就可以通过浏览器访问<code>http://localhost:8080</code>进入控制台界面了，如下图：<br><img src="https://tvax3.sinaimg.cn/large/006MOU0zgy1gjnxylgieaj31gk11rtbw.jpg" referrerpolicy="no-referrer"></p><p>集群状态：<br><img src="https://tvax1.sinaimg.cn/large/006MOU0zgy1gjnxyjngmkj31hc0cewfi.jpg" referrerpolicy="no-referrer"></p><h1 id="消息发送样例"><a href="#消息发送样例" class="headerlink" title="消息发送样例"></a>消息发送样例</h1><ul><li>导入MQ客户端依赖</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>消息发送者步骤分析r</li></ul><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.创建消息生产者producer，并制定生产者组名</span><br><span class="line">2.指定Nameserver地址</span><br><span class="line">3.启动producer</span><br><span class="line">4.创建消息对象，指定主题Topic、Tag和消息体</span><br><span class="line">5.发送消息</span><br><span class="line">6.关闭生产者producer</span><br></pre></td></tr></table></figure><ul><li>消息消费者步骤分析</li></ul><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.创建消费者Consumer，制定消费者组名</span><br><span class="line">2.指定Nameserver地址</span><br><span class="line">3.订阅主题Topic和Tag</span><br><span class="line">4.设置回调函数，处理消息</span><br><span class="line">5.启动消费者consumer</span><br></pre></td></tr></table></figure><h2 id="基本样例"><a href="#基本样例" class="headerlink" title="基本样例"></a>基本样例</h2><h3 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h3><h4 id="发送同步消息"><a href="#发送同步消息" class="headerlink" title="发送同步消息"></a>发送同步消息</h4><p>这种可靠性同步地发送方式使用的比较广泛，比如：重要的消息通知，短信通知。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncProducer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    	<span class="comment">// 实例化消息生产者Producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line">    	<span class="comment">// 设置NameServer的地址</span></span><br><span class="line">    	producer.setNamesrvAddr(<span class="string">"localhost:9876"</span>);</span><br><span class="line">    	<span class="comment">// 启动Producer实例</span></span><br><span class="line">        producer.start();</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    	    <span class="comment">// 创建消息，并指定Topic，Tag和消息体</span></span><br><span class="line">    	    Message msg = <span class="keyword">new</span> Message(<span class="string">"TopicTest"</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">        	<span class="string">"TagA"</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">        	(<span class="string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">        	);</span><br><span class="line">        	<span class="comment">// 发送消息到一个Broker</span></span><br><span class="line">            SendResult sendResult = producer.send(msg);</span><br><span class="line">            <span class="comment">// 通过sendResult返回消息是否成功送达</span></span><br><span class="line">            System.out.printf(<span class="string">"%s%n"</span>, sendResult);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="comment">// 如果不再发送消息，关闭Producer实例。</span></span><br><span class="line">    	producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="发送异步消息"><a href="#发送异步消息" class="headerlink" title="发送异步消息"></a>发送异步消息</h4><p>异步消息通常用在对响应时间敏感的业务场景，即发送端不能容忍长时间地等待Broker的响应。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncProducer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    	<span class="comment">// 实例化消息生产者Producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line">    	<span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"localhost:9876"</span>);</span><br><span class="line">    	<span class="comment">// 启动Producer实例</span></span><br><span class="line">        producer.start();</span><br><span class="line">        producer.setRetryTimesWhenSendAsyncFailed(<span class="number">0</span>);</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> index = i;</span><br><span class="line">            	<span class="comment">// 创建消息，并指定Topic，Tag和消息体</span></span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">"TopicTest"</span>,</span><br><span class="line">                    <span class="string">"TagA"</span>,</span><br><span class="line">                    <span class="string">"OrderID188"</span>,</span><br><span class="line">                    <span class="string">"Hello world"</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                <span class="comment">// SendCallback接收异步返回结果的回调</span></span><br><span class="line">                producer.send(msg, <span class="keyword">new</span> SendCallback() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(SendResult sendResult)</span> </span>&#123;</span><br><span class="line">                        System.out.printf(<span class="string">"%-10d OK %s %n"</span>, index,</span><br><span class="line">                            sendResult.getMsgId());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onException</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">      	              System.out.printf(<span class="string">"%-10d Exception %s %n"</span>, index, e);</span><br><span class="line">      	              e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">            	&#125;);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="comment">// 如果不再发送消息，关闭Producer实例。</span></span><br><span class="line">    	producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="单向发送消息"><a href="#单向发送消息" class="headerlink" title="单向发送消息"></a>单向发送消息</h4><p>这种方式主要用在不特别关心发送结果的场景，例如日志发送。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnewayProducer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    	<span class="comment">// 实例化消息生产者Producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line">    	<span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"localhost:9876"</span>);</span><br><span class="line">    	<span class="comment">// 启动Producer实例</span></span><br><span class="line">        producer.start();</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        	<span class="comment">// 创建消息，并指定Topic，Tag和消息体</span></span><br><span class="line">        	Message msg = <span class="keyword">new</span> Message(<span class="string">"TopicTest"</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">                <span class="string">"TagA"</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">                (<span class="string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">        	);</span><br><span class="line">        	<span class="comment">// 发送单向消息，没有任何返回结果</span></span><br><span class="line">        	producer.sendOneway(msg);</span><br><span class="line"></span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="comment">// 如果不再发送消息，关闭Producer实例。</span></span><br><span class="line">    	producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="消费消息"><a href="#消费消息" class="headerlink" title="消费消息"></a>消费消息</h3><h4 id="负载均衡模式"><a href="#负载均衡模式" class="headerlink" title="负载均衡模式"></a>负载均衡模式</h4><p>消费者采用负载均衡方式消费消息，多个消费者共同消费队列消息，每个消费者处理的消息不同</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 实例化消息生产者,指定组名</span></span><br><span class="line">    DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"group1"</span>);</span><br><span class="line">    <span class="comment">// 指定Namesrv地址信息.</span></span><br><span class="line">    consumer.setNamesrvAddr(<span class="string">"localhost:9876"</span>);</span><br><span class="line">    <span class="comment">// 订阅Topic</span></span><br><span class="line">    consumer.subscribe(<span class="string">"Test"</span>, <span class="string">"*"</span>);</span><br><span class="line">    <span class="comment">//负载均衡模式消费</span></span><br><span class="line">    consumer.setMessageModel(MessageModel.CLUSTERING);</span><br><span class="line">    <span class="comment">// 注册回调函数，处理消息</span></span><br><span class="line">    consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                        ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">            System.out.printf(<span class="string">"%s Receive New Messages: %s %n"</span>, </span><br><span class="line">                              Thread.currentThread().getName(), msgs);</span><br><span class="line">            <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//启动消息者</span></span><br><span class="line">    consumer.start();</span><br><span class="line">    System.out.printf(<span class="string">"Consumer Started.%n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="广播模式"><a href="#广播模式" class="headerlink" title="广播模式"></a>广播模式</h4><p>消费者采用广播的方式消费消息，每个消费者消费的消息都是相同的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 实例化消息生产者,指定组名</span></span><br><span class="line">    DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"group1"</span>);</span><br><span class="line">    <span class="comment">// 指定Namesrv地址信息.</span></span><br><span class="line">    consumer.setNamesrvAddr(<span class="string">"localhost:9876"</span>);</span><br><span class="line">    <span class="comment">// 订阅Topic</span></span><br><span class="line">    consumer.subscribe(<span class="string">"Test"</span>, <span class="string">"*"</span>);</span><br><span class="line">    <span class="comment">//广播模式消费</span></span><br><span class="line">    consumer.setMessageModel(MessageModel.BROADCASTING);</span><br><span class="line">    <span class="comment">// 注册回调函数，处理消息</span></span><br><span class="line">    consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                        ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">            System.out.printf(<span class="string">"%s Receive New Messages: %s %n"</span>, </span><br><span class="line">                              Thread.currentThread().getName(), msgs);</span><br><span class="line">            <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//启动消息者</span></span><br><span class="line">    consumer.start();</span><br><span class="line">    System.out.printf(<span class="string">"Consumer Started.%n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="顺序消息"><a href="#顺序消息" class="headerlink" title="顺序消息"></a>顺序消息</h2><p>消息有序指的是可以按照消息的发送顺序来消费(FIFO)。RocketMQ可以严格的保证消息有序，可以分为分区有序或者全局有序。</p><p>顺序消费的原理解析，在默认的情况下消息发送会采取Round Robin轮询方式把消息发送到不同的queue(分区队列)；而消费消息的时候从多个queue上拉取消息，这种情况发送和消费是不能保证顺序。但是如果控制发送的顺序消息只依次发送到同一个queue中，消费的时候只从这个queue上依次拉取，则就保证了顺序。当发送和消费参与的queue只有一个，则是全局有序；如果多个queue参与，则为分区有序，即相对每个queue，消息都是有序的。</p><p>下面用订单进行分区有序的示例。一个订单的顺序流程是：创建、付款、推送、完成。订单号相同的消息会被先后发送到同一个队列中，消费时，同一个OrderId获取到的肯定是同一个队列。</p><h3 id="顺序消息生产"><a href="#顺序消息生产" class="headerlink" title="顺序消息生产"></a>顺序消息生产</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Producer，发送顺序消息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line"></span><br><span class="line">       producer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line"></span><br><span class="line">       producer.start();</span><br><span class="line"></span><br><span class="line">       String[] tags = <span class="keyword">new</span> String[]&#123;<span class="string">"TagA"</span>, <span class="string">"TagC"</span>, <span class="string">"TagD"</span>&#125;;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 订单列表</span></span><br><span class="line">       List&lt;OrderStep&gt; orderList = <span class="keyword">new</span> Producer().buildOrders();</span><br><span class="line"></span><br><span class="line">       Date date = <span class="keyword">new</span> Date();</span><br><span class="line">       SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">       String dateStr = sdf.format(date);</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">           <span class="comment">// 加个时间前缀</span></span><br><span class="line">           String body = dateStr + <span class="string">" Hello RocketMQ "</span> + orderList.get(i);</span><br><span class="line">           Message msg = <span class="keyword">new</span> Message(<span class="string">"TopicTest"</span>, tags[i % tags.length], <span class="string">"KEY"</span> + i, body.getBytes());</span><br><span class="line"></span><br><span class="line">           SendResult sendResult = producer.send(msg, <span class="keyword">new</span> MessageQueueSelector() &#123;</span><br><span class="line">               <span class="meta">@Override</span></span><br><span class="line">               <span class="function"><span class="keyword">public</span> MessageQueue <span class="title">select</span><span class="params">(List&lt;MessageQueue&gt; mqs, Message msg, Object arg)</span> </span>&#123;</span><br><span class="line">                   Long id = (Long) arg;  <span class="comment">//根据订单id选择发送queue</span></span><br><span class="line">                   <span class="keyword">long</span> index = id % mqs.size();</span><br><span class="line">                   <span class="keyword">return</span> mqs.get((<span class="keyword">int</span>) index);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;, orderList.get(i).getOrderId());<span class="comment">//订单id</span></span><br><span class="line"></span><br><span class="line">           System.out.println(String.format(<span class="string">"SendResult status:%s, queueId:%d, body:%s"</span>,</span><br><span class="line">               sendResult.getSendStatus(),</span><br><span class="line">               sendResult.getMessageQueue().getQueueId(),</span><br><span class="line">               body));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       producer.shutdown();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 订单的步骤</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderStep</span> </span>&#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">long</span> orderId;</span><br><span class="line">       <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getOrderId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> orderId;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderId</span><span class="params">(<span class="keyword">long</span> orderId)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.orderId = orderId;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> String <span class="title">getDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> desc;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDesc</span><span class="params">(String desc)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.desc = desc;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="string">"OrderStep&#123;"</span> +</span><br><span class="line">               <span class="string">"orderId="</span> + orderId +</span><br><span class="line">               <span class="string">", desc='"</span> + desc + <span class="string">'\''</span> +</span><br><span class="line">               <span class="string">'&#125;'</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 生成模拟订单数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> List&lt;OrderStep&gt; <span class="title">buildOrders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       List&lt;OrderStep&gt; orderList = <span class="keyword">new</span> ArrayList&lt;OrderStep&gt;();</span><br><span class="line"></span><br><span class="line">       OrderStep orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111039L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"创建"</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111065L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"创建"</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111039L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"付款"</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103117235L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"创建"</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111065L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"付款"</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103117235L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"付款"</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111065L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"完成"</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111039L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"推送"</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103117235L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"完成"</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111039L</span>);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"完成"</span>);</span><br><span class="line">       orderList.add(orderDemo);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> orderList;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="顺序消费消息"><a href="#顺序消费消息" class="headerlink" title="顺序消费消息"></a>顺序消费消息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 顺序消息消费，带事务方式（应用可控制Offset什么时候提交）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerInOrder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       DefaultMQPushConsumer consumer = <span class="keyword">new</span> </span><br><span class="line">           DefaultMQPushConsumer(<span class="string">"please_rename_unique_group_name_3"</span>);</span><br><span class="line">       consumer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 设置Consumer第一次启动是从队列头部开始消费还是队列尾部开始消费&lt;br&gt;</span></span><br><span class="line"><span class="comment">        * 如果非第一次启动，那么按照上次消费的位置继续消费</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);</span><br><span class="line"></span><br><span class="line">       consumer.subscribe(<span class="string">"TopicTest"</span>, <span class="string">"TagA || TagC || TagD"</span>);</span><br><span class="line"></span><br><span class="line">       consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerOrderly() &#123;</span><br><span class="line"></span><br><span class="line">           Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> ConsumeOrderlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeOrderlyContext context)</span> </span>&#123;</span><br><span class="line">               context.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">               <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</span><br><span class="line">                   <span class="comment">// 可以看到每个queue有唯一的consume线程来消费, 订单对每个queue(分区)有序</span></span><br><span class="line">                   System.out.println(<span class="string">"consumeThread="</span> + Thread.currentThread().getName() + <span class="string">"queueId="</span> + msg.getQueueId() + <span class="string">", content:"</span> + <span class="keyword">new</span> String(msg.getBody()));</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">//模拟业务逻辑处理中...</span></span><br><span class="line">                   TimeUnit.SECONDS.sleep(random.nextInt(<span class="number">10</span>));</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> ConsumeOrderlyStatus.SUCCESS;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       consumer.start();</span><br><span class="line"></span><br><span class="line">       System.out.println(<span class="string">"Consumer Started."</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="延时消息"><a href="#延时消息" class="headerlink" title="延时消息"></a>延时消息</h2><p>比如电商里，提交了一个订单就可以发送一个延时消息，1h后去检查这个订单的状态，如果还是未付款就取消订单释放库存。</p><h3 id="启动消息消费者"><a href="#启动消息消费者" class="headerlink" title="启动消息消费者"></a>启动消息消费者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledMessageConsumer</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">// 实例化消费者</span></span><br><span class="line">      DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"ExampleConsumer"</span>);</span><br><span class="line">      <span class="comment">// 订阅Topics</span></span><br><span class="line">      consumer.subscribe(<span class="string">"TestTopic"</span>, <span class="string">"*"</span>);</span><br><span class="line">      <span class="comment">// 注册消息监听者</span></span><br><span class="line">      consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; messages, ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">              <span class="keyword">for</span> (MessageExt message : messages) &#123;</span><br><span class="line">                  <span class="comment">// Print approximate delay time period</span></span><br><span class="line">                  System.out.println(<span class="string">"Receive message[msgId="</span> + message.getMsgId() + <span class="string">"] "</span> + (System.currentTimeMillis() - message.getStoreTimestamp()) + <span class="string">"ms later"</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// 启动消费者</span></span><br><span class="line">      consumer.start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="发送延时消息"><a href="#发送延时消息" class="headerlink" title="发送延时消息"></a>发送延时消息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledMessageProducer</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">// 实例化一个生产者来产生延时消息</span></span><br><span class="line">      DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"ExampleProducerGroup"</span>);</span><br><span class="line">      <span class="comment">// 启动生产者</span></span><br><span class="line">      producer.start();</span><br><span class="line">      <span class="keyword">int</span> totalMessagesToSend = <span class="number">100</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; totalMessagesToSend; i++) &#123;</span><br><span class="line">          Message message = <span class="keyword">new</span> Message(<span class="string">"TestTopic"</span>, (<span class="string">"Hello scheduled message "</span> + i).getBytes());</span><br><span class="line">          <span class="comment">// 设置延时等级3,这个消息将在10s之后发送(现在只支持固定的几个时间,详看delayTimeLevel)</span></span><br><span class="line">          message.setDelayTimeLevel(<span class="number">3</span>);</span><br><span class="line">          <span class="comment">// 发送消息</span></span><br><span class="line">          producer.send(message);</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="comment">// 关闭生产者</span></span><br><span class="line">      producer.shutdown();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>您将会看到消息的消费比存储时间晚10秒</p><h3 id="使用限制"><a href="#使用限制" class="headerlink" title="使用限制"></a>使用限制</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org/apache/rocketmq/store/config/MessageStoreConfig.java</span></span><br><span class="line"><span class="keyword">private</span> String messageDelayLevel = <span class="string">"1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h"</span>;</span><br></pre></td></tr></table></figure><p>现在RocketMq并不支持任意时间的延时，需要设置几个固定的延时等级，从1s到2h分别对应着等级1到18</p><h2 id="批量消息"><a href="#批量消息" class="headerlink" title="批量消息"></a>批量消息</h2><p>批量发送消息能显著提高传递小消息的性能。限制是这些批量消息应该有相同的topic，相同的waitStoreMsgOK，而且不能是延时消息。此外，这一批消息的总大小不应超过4MB。</p><h3 id="发送批量消息"><a href="#发送批量消息" class="headerlink" title="发送批量消息"></a>发送批量消息</h3><p>如果您每次只发送不超过4MB的消息，则很容易使用批处理，样例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">String topic = <span class="string">"BatchTest"</span>;</span><br><span class="line">List&lt;Message&gt; messages = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">messages.add(<span class="keyword">new</span> Message(topic, <span class="string">"TagA"</span>, <span class="string">"OrderID001"</span>, <span class="string">"Hello world 0"</span>.getBytes()));</span><br><span class="line">messages.add(<span class="keyword">new</span> Message(topic, <span class="string">"TagA"</span>, <span class="string">"OrderID002"</span>, <span class="string">"Hello world 1"</span>.getBytes()));</span><br><span class="line">messages.add(<span class="keyword">new</span> Message(topic, <span class="string">"TagA"</span>, <span class="string">"OrderID003"</span>, <span class="string">"Hello world 2"</span>.getBytes()));</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   producer.send(messages);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">   e.printStackTrace();</span><br><span class="line">   <span class="comment">//处理error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果消息的总长度可能大于4MB时，这时候最好把消息进行分割</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListSplitter</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">List</span>&lt;<span class="title">Message</span>&gt;&gt; </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZE_LIMIT = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">4</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Message&gt; messages;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> currIndex;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ListSplitter</span><span class="params">(List&lt;Message&gt; messages)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.messages = messages;</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> currIndex &lt; messages.size();</span><br><span class="line">   &#125;</span><br><span class="line">   	<span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Message&gt; <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> nextIndex = currIndex;</span><br><span class="line">       <span class="keyword">int</span> totalSize = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span> (; nextIndex &lt; messages.size(); nextIndex++) &#123;</span><br><span class="line">           Message message = messages.get(nextIndex);</span><br><span class="line">           <span class="keyword">int</span> tmpSize = message.getTopic().length() + message.getBody().length;</span><br><span class="line">           Map&lt;String, String&gt; properties = message.getProperties();</span><br><span class="line">           <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">               tmpSize += entry.getKey().length() + entry.getValue().length();</span><br><span class="line">           &#125;</span><br><span class="line">           tmpSize = tmpSize + <span class="number">20</span>; <span class="comment">// 增加日志的开销20字节</span></span><br><span class="line">           <span class="keyword">if</span> (tmpSize &gt; SIZE_LIMIT) &#123;</span><br><span class="line">               <span class="comment">//单个消息超过了最大的限制</span></span><br><span class="line">               <span class="comment">//忽略,否则会阻塞分裂的进程</span></span><br><span class="line">               <span class="keyword">if</span> (nextIndex - currIndex == <span class="number">0</span>) &#123;</span><br><span class="line">                  <span class="comment">//假如下一个子列表没有元素,则添加这个子列表然后退出循环,否则只是退出循环</span></span><br><span class="line">                  nextIndex++;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (tmpSize + totalSize &gt; SIZE_LIMIT) &#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               totalSize += tmpSize;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">       List&lt;Message&gt; subList = messages.subList(currIndex, nextIndex);</span><br><span class="line">       currIndex = nextIndex;</span><br><span class="line">       <span class="keyword">return</span> subList;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//把大的消息分裂成若干个小的消息</span></span><br><span class="line">ListSplitter splitter = <span class="keyword">new</span> ListSplitter(messages);</span><br><span class="line"><span class="keyword">while</span> (splitter.hasNext()) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      List&lt;Message&gt;  listItem = splitter.next();</span><br><span class="line">      producer.send(listItem);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">      <span class="comment">//处理error</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="过滤消息"><a href="#过滤消息" class="headerlink" title="过滤消息"></a>过滤消息</h2><p>在大多数情况下，TAG是一个简单而有用的设计，其可以来选择您想要的消息。例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"CID_EXAMPLE"</span>);</span><br><span class="line">consumer.subscribe(<span class="string">"TOPIC"</span>, <span class="string">"TAGA || TAGB || TAGC"</span>);</span><br></pre></td></tr></table></figure><p>消费者将接收包含TAGA或TAGB或TAGC的消息。但是限制是一个消息只能有一个标签，这对于复杂的场景可能不起作用。在这种情况下，可以使用SQL表达式筛选消息。SQL特性可以通过发送消息时的属性来进行计算。在RocketMQ定义的语法下，可以实现一些简单的逻辑。下面是一个例子：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">| message  |</span><br><span class="line">|----------|  a &gt; 5 AND b = &apos;abc&apos;</span><br><span class="line">| a = 10   |  --------------------&gt; Gotten</span><br><span class="line">| b = &apos;abc&apos;|</span><br><span class="line">| c = true |</span><br><span class="line">------------</span><br><span class="line">------------</span><br><span class="line">| message  |</span><br><span class="line">|----------|   a &gt; 5 AND b = &apos;abc&apos;</span><br><span class="line">| a = 1    |  --------------------&gt; Missed</span><br><span class="line">| b = &apos;abc&apos;|</span><br><span class="line">| c = true |</span><br><span class="line">------------</span><br></pre></td></tr></table></figure><h3 id="SQL基本语法"><a href="#SQL基本语法" class="headerlink" title="SQL基本语法"></a>SQL基本语法</h3><p>RocketMQ只定义了一些基本语法来支持这个特性。你也可以很容易地扩展它。</p><ul><li>数值比较，比如：<strong>&gt;，&gt;=，&lt;，&lt;=，BETWEEN，=；</strong></li><li>字符比较，比如：<strong>=，&lt;&gt;，IN；</strong></li><li><strong>IS NULL</strong> 或者 <strong>IS NOT NULL；</strong></li><li>逻辑符号 <strong>AND，OR，NOT；</strong></li></ul><p>常量支持类型为：</p><ul><li>数值，比如：<strong>123，3.1415；</strong></li><li>字符，比如：<strong>‘abc’，必须用单引号包裹起来；</strong></li><li><strong>NULL</strong>，特殊的常量</li><li>布尔值，<strong>TRUE</strong> 或 <strong>FALSE</strong></li></ul><p>只有使用push模式的消费者才能用使用SQL92标准的sql语句，接口如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(finalString topic, <span class="keyword">final</span> MessageSelector messageSelector)</span></span></span><br></pre></td></tr></table></figure><h3 id="消息生产者"><a href="#消息生产者" class="headerlink" title="消息生产者"></a>消息生产者</h3><p>发送消息时，你能通过<code>putUserProperty</code>来设置消息的属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line">producer.start();</span><br><span class="line">Message msg = <span class="keyword">new</span> Message(<span class="string">"TopicTest"</span>,</span><br><span class="line">   tag,</span><br><span class="line">   (<span class="string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET)</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 设置一些属性</span></span><br><span class="line">msg.putUserProperty(<span class="string">"a"</span>, String.valueOf(i));</span><br><span class="line">SendResult sendResult = producer.send(msg);</span><br><span class="line"></span><br><span class="line">producer.shutdown();</span><br></pre></td></tr></table></figure><h3 id="消息消费者"><a href="#消息消费者" class="headerlink" title="消息消费者"></a>消息消费者</h3><p>用MessageSelector.bySql来使用sql筛选消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"please_rename_unique_group_name_4"</span>);</span><br><span class="line"><span class="comment">// 只有订阅的消息有这个属性a, a &gt;=0 and a &lt;= 3</span></span><br><span class="line">consumer.subscribe(<span class="string">"TopicTest"</span>, MessageSelector.bySql(<span class="string">"a between 0 and 3"</span>);</span><br><span class="line">consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;);</span><br><span class="line">consumer.start();</span><br></pre></td></tr></table></figure><h2 id="事务消息"><a href="#事务消息" class="headerlink" title="事务消息"></a>事务消息</h2><h3 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h3><p><img src="https://tva2.sinaimg.cn/large/006MOU0zgy1gjnzi2do0vj30ry0d93z7.jpg" referrerpolicy="no-referrer"></p><p>上图说明了事务消息的大致方案，其中分为两个流程：正常事务消息的发送及提交、事务消息的补偿流程。</p><h4 id="事务消息发送及提交"><a href="#事务消息发送及提交" class="headerlink" title="事务消息发送及提交"></a>事务消息发送及提交</h4><p>(1) 发送消息（half消息）。</p><p>(2) 服务端响应消息写入结果。</p><p>(3) 根据发送结果执行本地事务（如果写入失败，此时half消息对业务不可见，本地逻辑不执行）。</p><p>(4) 根据本地事务状态执行Commit或者Rollback（Commit操作生成消息索引，消息对消费者可见）</p><h4 id="事务补偿"><a href="#事务补偿" class="headerlink" title="事务补偿"></a>事务补偿</h4><p>(1) 对没有Commit/Rollback的事务消息（pending状态的消息），从服务端发起一次“回查”</p><p>(2) Producer收到回查消息，检查回查消息对应的本地事务的状态</p><p>(3) 根据本地事务状态，重新Commit或者Rollback</p><p>其中，补偿阶段用于解决消息Commit或者Rollback发生超时或者失败的情况。</p><h4 id="事务消息状态"><a href="#事务消息状态" class="headerlink" title="事务消息状态"></a>事务消息状态</h4><p>事务消息共有三种状态，提交状态、回滚状态、中间状态：</p><ul><li>TransactionStatus.CommitTransaction: 提交事务，它允许消费者消费此消息。</li><li>TransactionStatus.RollbackTransaction: 回滚事务，它代表该消息将被删除，不允许被消费。</li><li>TransactionStatus.Unknown: 中间状态，它代表需要检查消息队列来确定状态。</li></ul><h3 id="发送事务消息"><a href="#发送事务消息" class="headerlink" title="发送事务消息"></a>发送事务消息</h3><h4 id="创建事务性生产者"><a href="#创建事务性生产者" class="headerlink" title="创建事务性生产者"></a>创建事务性生产者</h4><p>使用 <code>TransactionMQProducer</code>类创建生产者，并指定唯一的 <code>ProducerGroup</code>，就可以设置自定义线程池来处理这些检查请求。执行本地事务后、需要根据执行结果对消息队列进行回复。回传的事务状态在请参考前一节。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//创建事务监听器</span></span><br><span class="line">        TransactionListener transactionListener = <span class="keyword">new</span> TransactionListenerImpl();</span><br><span class="line">        <span class="comment">//创建消息生产者</span></span><br><span class="line">        TransactionMQProducer producer = <span class="keyword">new</span> TransactionMQProducer(<span class="string">"group6"</span>);</span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"192.168.25.135:9876;192.168.25.138:9876"</span>);</span><br><span class="line">        <span class="comment">//生产者这是监听器</span></span><br><span class="line">        producer.setTransactionListener(transactionListener);</span><br><span class="line">        <span class="comment">//启动消息生产者</span></span><br><span class="line">        producer.start();</span><br><span class="line">        String[] tags = <span class="keyword">new</span> String[]&#123;<span class="string">"TagA"</span>, <span class="string">"TagB"</span>, <span class="string">"TagC"</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">"TransactionTopic"</span>, tags[i % tags.length], <span class="string">"KEY"</span> + i,</span><br><span class="line">                        (<span class="string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                SendResult sendResult = producer.sendMessageInTransaction(msg, <span class="keyword">null</span>);</span><br><span class="line">                System.out.printf(<span class="string">"%s%n"</span>, sendResult);</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (MQClientException | UnsupportedEncodingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//producer.shutdown();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="实现事务的监听接口"><a href="#实现事务的监听接口" class="headerlink" title="实现事务的监听接口"></a>实现事务的监听接口</h4><p>当发送半消息成功时，我们使用 <code>executeLocalTransaction</code> 方法来执行本地事务。它返回前一节中提到的三个事务状态之一。<code>checkLocalTranscation</code> 方法用于检查本地事务状态，并回应消息队列的检查请求。它也是返回前一节中提到的三个事务状态之一。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionListenerImpl</span> <span class="keyword">implements</span> <span class="title">TransactionListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalTransactionState <span class="title">executeLocalTransaction</span><span class="params">(Message msg, Object arg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"执行本地事务"</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.equals(<span class="string">"TagA"</span>, msg.getTags())) &#123;</span><br><span class="line">            <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.equals(<span class="string">"TagB"</span>, msg.getTags())) &#123;</span><br><span class="line">            <span class="keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> LocalTransactionState.UNKNOW;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalTransactionState <span class="title">checkLocalTransaction</span><span class="params">(MessageExt msg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"MQ检查消息Tag【"</span>+msg.getTags()+<span class="string">"】的本地事务执行结果"</span>);</span><br><span class="line">        <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用限制-1"><a href="#使用限制-1" class="headerlink" title="使用限制"></a>使用限制</h3><ol><li>事务消息不支持延时消息和批量消息。</li><li>为了避免单个消息被检查太多次而导致半队列消息累积，我们默认将单个消息的检查次数限制为 15 次，但是用户可以通过 Broker 配置文件的 <code>transactionCheckMax</code>参数来修改此限制。如果已经检查某条消息超过 N 次的话（ N = <code>transactionCheckMax</code> ） 则 Broker 将丢弃此消息，并在默认情况下同时打印错误日志。用户可以通过重写 <code>AbstractTransactionCheckListener</code> 类来修改这个行为。</li><li>事务消息将在 Broker 配置文件中的参数 transactionMsgTimeout 这样的特定时间长度之后被检查。当发送事务消息时，用户还可以通过设置用户属性 CHECK_IMMUNITY_TIME_IN_SECONDS 来改变这个限制，该参数优先于 <code>transactionMsgTimeout</code> 参数。</li><li>事务性消息可能不止一次被检查或消费。</li><li>提交给用户的目标主题消息可能会失败，目前这依日志的记录而定。它的高可用性通过 RocketMQ 本身的高可用性机制来保证，如果希望确保事务消息不丢失、并且事务完整性得到保证，建议使用同步的双重写入机制。</li><li>事务消息的生产者 ID 不能与其他类型消息的生产者 ID 共享。与其他类型的消息不同，事务消息允许反向查询、MQ服务器能通过它们的生产者 ID 查询到消费者。</li></ol></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> 在线分享网</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://me.obey.fun/初探RocketMQ.html" title="初探RocketMQ">https://me.obey.fun/初探RocketMQ.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均为原创。转载请注明出处！</li></ul></div><div><div><blockquote class="blockquote-center" style="color:#ccc">-------------本文结束 <i class="fa fa-apple"></i> 感谢您的阅读-------------</blockquote></div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><button id="rewardButton" disable="enable" onclick='var e=document.getElementById("QR");"none"===e.style.display?e.style.display="block":e.style.display="none"'><span>打赏</span></button><div>文章对我有益，我要小额赞赏...</div><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/images/wechatpay.jpg" alt="HuiProgramer 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"><img id="alipay_qr" src="/images/alipay.jpg" alt="HuiProgramer 支付宝"><p>支付宝</p></div></div></div></div><footer class="post-footer"><div id="tags" class="post-tags"><a href="/tags/中间件/" rel="tag">中间件</a> <a href="/tags/RocketMQ/" rel="tag">RocketMQ</a></div><script type="text/javascript">for(var alltags=document.getElementById("tags"),tags=alltags.getElementsByTagName("a"),i=tags.length-1;i>=0;i--){var r=Math.floor(75*Math.random()+130),g=Math.floor(75*Math.random()+100),b=Math.floor(75*Math.random()+80);tags[i].style.background="rgb("+r+","+g+","+b+")"}var text="初探RocketMQ";document.onreadystatechange=function(){"complete"==document.readyState&&wenkmTips.show("正在阅读 -> "+text)}</script><style type="text/css">.post-tags a{color:#fff;background-color:#f5f7f1;border-radius:6px;padding-right:10px;padding-left:10px;margin-right:5px;margin-left:0;margin-top:18px;margin-bottom:0}.post-tags a:before{content:"📜"}</style><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/Mybatis-Plus必知必会.html" rel="next" title="Mybatis-Plus必知必会"><i class="fa fa-chevron-left"></i> Mybatis-Plus必知必会</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/RocketMQ电商下单案例.html" rel="prev" title="RocketMQ电商下单案例">RocketMQ电商下单案例 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div id="sidebar-dimmer"></div><div class="sidebar-inner"><div title="返回顶部(或下方百分比按钮)" class="backtop" style="background-position:0 -1000px"></div><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="https://huiprogramer.gitee.io/medias/avatar.jpg" alt="HuiProgramer" referrerpolicy="no-referrer"><p class="site-author-name" itemprop="name">HuiProgramer</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">47</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">29</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">33</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a rel="external nofollow" href="https://github.com/HuiProgramer" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a rel="external nofollow" href="mailto:huiprogramer@outlook.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a rel="external nofollow" href="https://www.jianshu.com/u/1606b64f25b5" target="_blank" title="简书"><i class="fa fa-fw fa-heartbeat"></i>简书</a> </span><span class="links-of-author-item"><a rel="external nofollow" href="https://cnblogs.com/HuiProgramer" target="_blank" title="博客园"><i class="fa fa-fw fa-book"></i>博客园</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 推荐阅读</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a rel="external nofollow" href="https://me.obey.fun/Git教程.html" title="Git教程" target="_blank">Git教程</a></li><li class="links-of-blogroll-item"><a rel="external nofollow" href="https://me.obey.fun/Markdown基本语法.html" title="Markdown基本语法" target="_blank">Markdown基本语法</a></li><li class="links-of-blogroll-item"><a rel="external nofollow" href="https://me.obey.fun/Java学习路线图.html" title="Java学习路线图" target="_blank">Java学习路线图</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MQ介绍"><span class="nav-number">1.</span> <span class="nav-text">MQ介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么要用MQ"><span class="nav-number">1.1.</span> <span class="nav-text">为什么要用MQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MQ的优点和缺点"><span class="nav-number">1.2.</span> <span class="nav-text">MQ的优点和缺点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#各种MQ产品的比较"><span class="nav-number">1.3.</span> <span class="nav-text">各种MQ产品的比较</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RocketMQ快速入门"><span class="nav-number">2.</span> <span class="nav-text">RocketMQ快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#准备工作"><span class="nav-number">2.1.</span> <span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载RocketMQ"><span class="nav-number">2.1.1.</span> <span class="nav-text">下载RocketMQ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#环境要求"><span class="nav-number">2.1.2.</span> <span class="nav-text">环境要求</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装RocketMQ"><span class="nav-number">2.2.</span> <span class="nav-text">安装RocketMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装步骤"><span class="nav-number">2.2.1.</span> <span class="nav-text">安装步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#目录介绍"><span class="nav-number">2.2.2.</span> <span class="nav-text">目录介绍</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动RocketMQ"><span class="nav-number">2.3.</span> <span class="nav-text">启动RocketMQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#接收消息"><span class="nav-number">2.3.1.</span> <span class="nav-text">接收消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关闭RocketMQ"><span class="nav-number">2.4.</span> <span class="nav-text">关闭RocketMQ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RocketMQ集群搭建"><span class="nav-number">3.</span> <span class="nav-text">RocketMQ集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#各角色介绍"><span class="nav-number">3.1.</span> <span class="nav-text">各角色介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群搭建方式"><span class="nav-number">3.2.</span> <span class="nav-text">集群搭建方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群特点"><span class="nav-number">3.2.1.</span> <span class="nav-text">集群特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群模式"><span class="nav-number">3.2.2.</span> <span class="nav-text">集群模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#单Master模式"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">单Master模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多Master模式"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">多Master模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多Master多Slave模式（异步）"><span class="nav-number">3.2.2.3.</span> <span class="nav-text">多Master多Slave模式（异步）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多Master多Slave模式（同步）"><span class="nav-number">3.2.2.4.</span> <span class="nav-text">多Master多Slave模式（同步）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#双主双从集群搭建"><span class="nav-number">3.3.</span> <span class="nav-text">双主双从集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总体架构"><span class="nav-number">3.3.1.</span> <span class="nav-text">总体架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群工作流程"><span class="nav-number">3.3.2.</span> <span class="nav-text">集群工作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器环境"><span class="nav-number">3.3.3.</span> <span class="nav-text">服务器环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Host添加信息"><span class="nav-number">3.3.4.</span> <span class="nav-text">Host添加信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#防火墙配置"><span class="nav-number">3.3.5.</span> <span class="nav-text">防火墙配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#环境变量配置"><span class="nav-number">3.3.6.</span> <span class="nav-text">环境变量配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建消息存储路径"><span class="nav-number">3.3.7.</span> <span class="nav-text">创建消息存储路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#broker配置文件"><span class="nav-number">3.3.8.</span> <span class="nav-text">broker配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#master1"><span class="nav-number">3.3.8.1.</span> <span class="nav-text">master1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#slave2"><span class="nav-number">3.3.8.2.</span> <span class="nav-text">slave2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#master2"><span class="nav-number">3.3.8.3.</span> <span class="nav-text">master2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#slave1"><span class="nav-number">3.3.8.4.</span> <span class="nav-text">slave1</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改启动脚本文件"><span class="nav-number">3.3.9.</span> <span class="nav-text">修改启动脚本文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#runbroker-sh"><span class="nav-number">3.3.9.1.</span> <span class="nav-text">runbroker.sh</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#runserver-sh"><span class="nav-number">3.3.9.2.</span> <span class="nav-text">runserver.sh</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务启动"><span class="nav-number">3.3.10.</span> <span class="nav-text">服务启动</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#启动NameServe集群"><span class="nav-number">3.3.10.1.</span> <span class="nav-text">启动NameServe集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动Broker集群"><span class="nav-number">3.3.10.2.</span> <span class="nav-text">启动Broker集群</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看进程状态"><span class="nav-number">3.3.11.</span> <span class="nav-text">查看进程状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看日志"><span class="nav-number">3.3.12.</span> <span class="nav-text">查看日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mqadmin管理工具"><span class="nav-number">3.4.</span> <span class="nav-text">mqadmin管理工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用方式"><span class="nav-number">3.4.1.</span> <span class="nav-text">使用方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#命令介绍"><span class="nav-number">3.4.2.</span> <span class="nav-text">命令介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Topic相关"><span class="nav-number">3.4.2.1.</span> <span class="nav-text">Topic相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集群相关"><span class="nav-number">3.4.2.2.</span> <span class="nav-text">集群相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Broker相关"><span class="nav-number">3.4.2.3.</span> <span class="nav-text">Broker相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消息相关"><span class="nav-number">3.4.2.4.</span> <span class="nav-text">消息相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消费者、消费组相关"><span class="nav-number">3.4.2.5.</span> <span class="nav-text">消费者、消费组相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#连接相关"><span class="nav-number">3.4.2.6.</span> <span class="nav-text">连接相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NameServer相关"><span class="nav-number">3.4.2.7.</span> <span class="nav-text">NameServer相关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他"><span class="nav-number">3.4.2.8.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#注意事项"><span class="nav-number">3.4.3.</span> <span class="nav-text">注意事项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群监控平台搭建"><span class="nav-number">3.5.</span> <span class="nav-text">集群监控平台搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概述"><span class="nav-number">3.5.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载并编译打包"><span class="nav-number">3.5.2.</span> <span class="nav-text">下载并编译打包</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#消息发送样例"><span class="nav-number">4.</span> <span class="nav-text">消息发送样例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基本样例"><span class="nav-number">4.1.</span> <span class="nav-text">基本样例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#消息发送"><span class="nav-number">4.1.1.</span> <span class="nav-text">消息发送</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#发送同步消息"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">发送同步消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发送异步消息"><span class="nav-number">4.1.1.2.</span> <span class="nav-text">发送异步消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#单向发送消息"><span class="nav-number">4.1.1.3.</span> <span class="nav-text">单向发送消息</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消费消息"><span class="nav-number">4.1.2.</span> <span class="nav-text">消费消息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#负载均衡模式"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">负载均衡模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#广播模式"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">广播模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#顺序消息"><span class="nav-number">4.2.</span> <span class="nav-text">顺序消息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#顺序消息生产"><span class="nav-number">4.2.1.</span> <span class="nav-text">顺序消息生产</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#顺序消费消息"><span class="nav-number">4.2.2.</span> <span class="nav-text">顺序消费消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#延时消息"><span class="nav-number">4.3.</span> <span class="nav-text">延时消息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动消息消费者"><span class="nav-number">4.3.1.</span> <span class="nav-text">启动消息消费者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送延时消息"><span class="nav-number">4.3.2.</span> <span class="nav-text">发送延时消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证"><span class="nav-number">4.3.3.</span> <span class="nav-text">验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用限制"><span class="nav-number">4.3.4.</span> <span class="nav-text">使用限制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#批量消息"><span class="nav-number">4.4.</span> <span class="nav-text">批量消息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#发送批量消息"><span class="nav-number">4.4.1.</span> <span class="nav-text">发送批量消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#过滤消息"><span class="nav-number">4.5.</span> <span class="nav-text">过滤消息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL基本语法"><span class="nav-number">4.5.1.</span> <span class="nav-text">SQL基本语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息生产者"><span class="nav-number">4.5.2.</span> <span class="nav-text">消息生产者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息消费者"><span class="nav-number">4.5.3.</span> <span class="nav-text">消息消费者</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务消息"><span class="nav-number">4.6.</span> <span class="nav-text">事务消息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#流程分析"><span class="nav-number">4.6.1.</span> <span class="nav-text">流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#事务消息发送及提交"><span class="nav-number">4.6.1.1.</span> <span class="nav-text">事务消息发送及提交</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事务补偿"><span class="nav-number">4.6.1.2.</span> <span class="nav-text">事务补偿</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事务消息状态"><span class="nav-number">4.6.1.3.</span> <span class="nav-text">事务消息状态</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发送事务消息"><span class="nav-number">4.6.2.</span> <span class="nav-text">发送事务消息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建事务性生产者"><span class="nav-number">4.6.2.1.</span> <span class="nav-text">创建事务性生产者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实现事务的监听接口"><span class="nav-number">4.6.2.2.</span> <span class="nav-text">实现事务的监听接口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用限制-1"><span class="nav-number">4.6.3.</span> <span class="nav-text">使用限制</span></a></li></ol></li></ol></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">Copyright&copy; <span itemprop="copyrightYear">2018-2020</span> <span class="with-love" id="heart"><i class="fa fa-heart" style="color:#ff71a8"></i> </span><span class="author" itemprop="copyrightHolder">HuiProgramer</span></div><div><span id="days"></span> <span class="my-face">ღゝ◡╹)ノ♡</span></div><div><span id="busuanzi_container_site_pv" style="display:inline-block">总访问量： <span id="busuanzi_value_site_pv"></span> 次 <span class="post-meta-divider">|</span> </span><span id="busuanzi_container_site_uv" style="display:inline-block">访问人数：<span id="busuanzi_value_site_uv"></span> 人 <span class="post-meta-divider">|</span></span><div class="theme-info"><span class="post-count">字数统计：154.2k 字</span></div></div><div><span id="cnzz_stat_icon_1277385852"></span><script src="https://s23.cnzz.com/z_stat.php?id=1277385852&amp;online=1&amp;show=line" type="text/javascript"></script><script src="https://c.cnzz.com/core.php?web_id=1277385852&amp;show=line&amp;online=1&amp;t=z" charset="utf-8" type="text/javascript"></script></div><script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("11/25/2018 08:18:26"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="本站已勉强运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;w<0&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("TCcAB5wC7Rjx4Xe9aFUYiMUU-gzGzoHsz","pC764tcMRXbraCg5anMgT3QF")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){var t=".leancloud-visitors-count";if(0===e.length)return void o.find(t).text(0);for(var i=0;i<e.length;i++){var r=e[i],s=r.get("url"),l=r.get("time"),c=document.getElementById(s);$(c).find(t).text(l)}for(var i=0;i<n.length;i++){var s=n[i],c=document.getElementById(s),u=$(c).find(t);""==u.text()&&u.text(0)}}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var r=new e,s=new AV.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!0),r.setACL(s),r.set("title",o),r.set("url",n),r.set("time",1),r.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><style>#wenkmTips{position:fixed;font-size:1.4em;text-shadow:none;border-radius:0 5px 5px 0;z-index:5000;top:10px;left:0;background-color:rgba(13,159,203,.6);padding:15px;color:#fff;-webkit-transition:.5s;-moz-transition:.5s;-ms-transition:.5s;transition:.5s;-webkit-transform:translate3d(-100%,0,0);-moz-transform:translate3d(-100%,0,0);-ms-transform:translate3d(-100%,0,0);transform:translate3d(-100%,0,0)}#wenkmTips.show{-webkit-transform:translate3d(0,0,0);-moz-transform:translate3d(0,0,0);-ms-transform:translate3d(0,0,0);transform:translate3d(0,0,0)}.backtop{position:absolute;top:50%;z-index:3;clear:both;display:none;margin-top:-50px;margin-left:0;idth:68px;height:100px;background:url(https://huiprogramer.gitee.io/images/backtop.png)}</style><script type="text/javascript">function lanye_popup_box(){$("#lanye_popup_bg").fadeIn(800),$("#lanye_popup_bg").after("<div class=lanye_popup_box><h2><strong>支付宝扫码领红包</strong><span class=lanye_popup_closebox onclick=lanye_popup_closebox();></span></h2><div class=lanye_popup_boxcont><div style = 'padding:0px 12px 0px 12px;'>打开支付宝扫描二维码领取红包或者在支付宝首页输入<font color=red>1347239</font>搜索领取红包，每天可领取一次哦。</div><p style=padding-top:5px;padding-bottom:5px;text-align:center><img referrerpolicy='no-referrer' style=width:260px;height:auto; src=https://ws4.sinaimg.cn/large/006MOU0zgy1g23dhnc12bj30fs0nojtf.jpg /></p></div></div>"),$(".hb_box").fadeIn()}function lanye_popup_closebox(){$(".lanye_popup_box").remove(),$("#lanye_popup_bg").fadeOut(800)}$(document).ready(function(){$(".lanye_popup_close").click(function(){$(".lanye_popup_box").fadeOut()}),$(".lanye_popup_closetop").click(function(){$(".lanye_popup_top").remove()})}),$("meta[name='generator']").prop("content","在线生成").prop("name","在线分享网"),$(function(){setTimeout(function(){$("#cnzz_stat_icon_1277040022 a").css("border-bottom","none"),$("#cnzz_stat_icon_1277040022 a").css("color","#999")},1e3)})</script><script id="cy_cmt_num" async src="https://changyan.sohu.com/upload/plugins/plugins.list.count.js?clientId=cyu7tijsf"></script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script async type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script async type="text/javascript" src="/js/src/fireworks.js"></script></body></html><!-- rebuild by neat -->